<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Night Games â€¢ v506</title>

<!-- Firebase compat (single-file web build) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* ============================================================
   Night Games v506 â€” FULL BUILD (single-file; text-file friendly)
   ============================================================
   How to use:
   - Save as index.html (or rename this text file to index.html)
   - Place in your repo root alongside these assets (NOT embedded):
       7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png?v=495   (banner game design)
       7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png?v=495 (fallback banner)
       0217.mp4?v=495 (optional sweep overlay; if missing it will skip)
       MY DART AVATAR.png (optional)
       WILLIAM DART AVATAR.png (optional)
       MY DART AVATAR.png (optional)
   ------------------------------------------------------------
   What this build includes:
   - Email-only sign-in
   - New user => asks name once (modal)
   - Player page with big name top, speaker, sign out
   - Neon / glow night theme across ALL screens
   - Banner across top (game design image)
   - Footer disclosure across bottom on ALL screens
   - Players list with online green dot (presence pings)
   - Games: Cricket + 01 basic playable turn loop (per-turn entry)
   - Other games: placeholder screens (navigable)
   - Online matches WITHOUT codes:
       "Open Matches" list (create match; others can tap to join)
   ============================================================ */

:root{
  --bg0:#05070a; --bg1:#070a10;
  --panel:rgba(10,12,16,.80);
  --panel2:rgba(0,0,0,.28);
  --stroke:rgba(120,180,255,.18);
  --stroke2:rgba(0,215,255,.30);
  --text:#e9f2ff; --muted:rgba(233,242,255,.72);
  --cyan:#00d7ff; --blue:#2a7fff;
  --green:#2ee66b; --danger:#ff4d4d; --amber:#ffb000;
  --shadow:0 18px 42px rgba(0,0,0,.55);
  --r:18px;
  --btnR:16px;
}

html,body{height:100%;margin:0;color:var(--text);
  background:
    radial-gradient(120% 120% at 18% 12%, rgba(0,215,255,.18), rgba(0,0,0,0) 54%),
    radial-gradient(120% 120% at 85% 78%, rgba(42,127,255,.14), rgba(0,0,0,0) 56%),
    linear-gradient(180deg,var(--bg1),var(--bg0));
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}


/* --- v506 Skin: pull colors from the banner asset (repo) --- */
body::before{
  content:"";
  position:fixed; inset:-20%;
  background-image:url('7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png?v=496');
  background-size:cover; background-position:center;
  filter: blur(28px) saturate(1.15) contrast(1.08);
  opacity:.12;
  transform:scale(1.08);
  pointer-events:none;
  z-index:-2;
}
body::after{
  content:"";
  position:fixed; inset:0;
  background:
    radial-gradient(120% 120% at 18% 12%, rgba(0,215,255,.20), rgba(0,0,0,0) 54%),
    radial-gradient(120% 120% at 85% 78%, rgba(42,127,255,.18), rgba(0,0,0,0) 56%),
    linear-gradient(180deg, rgba(0,0,0,.40), rgba(0,0,0,.72));
  pointer-events:none;
  z-index:-1;
}
/* extra glow / bevel */
.btn{
  background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.26));
}
.btn::after{
  box-shadow:
    0 0 0 1px rgba(255,255,255,.08) inset,
    0 10px 24px rgba(0,0,0,.42),
    0 0 26px rgba(0,215,255,.16);
}
.btn.green::after{
  box-shadow:
    0 0 0 1px rgba(255,255,255,.10) inset,
    0 10px 24px rgba(0,0,0,.42),
    0 0 28px rgba(46,230,107,.22);
}
.panel{
  box-shadow:0 16px 36px rgba(0,0,0,.35), 0 0 22px rgba(0,215,255,.06);
}


/* --- v506 Landing Color Scheme --- */
.heroHeader{
  border:1px solid rgba(0,215,255,.20);
  border-left:none; border-right:none; /* keep clean inside main frame */
  background:
    radial-gradient(120% 140% at 12% 10%, rgba(0,215,255,.26), rgba(0,0,0,0) 55%),
    radial-gradient(120% 140% at 88% 35%, rgba(255,173,0,.22), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.34));
  box-shadow:0 0 18px rgba(0,215,255,.08);
}
.heroInner{padding:10px 10px 10px 10px;text-align:center;}
.heroLogo{
  width:100%;
  max-width:980px;
  max-height:640px;
  object-fit:contain;
  margin:0 auto;
  display:block;
  /* no border; only glow */
  filter:drop-shadow(0 22px 44px rgba(0,0,0,.62))
         drop-shadow(0 0 26px rgba(0,215,255,.24))
         drop-shadow(0 0 22px rgba(255,173,0,.16));
}
.heroTitle{
  margin-top:10px;
  font-size:28px;
  font-weight:1000;
  letter-spacing:.25px;
  text-shadow:0 0 18px rgba(0,215,255,.18);
}
.heroSub{color:rgba(233,242,255,.75);font-size:13px;margin-top:4px;}
.heroPanel{
  max-width:760px;
  margin:0 auto;
  background:
    radial-gradient(120% 120% at 15% 15%, rgba(0,215,255,.12), rgba(0,0,0,0) 55%),
    radial-gradient(120% 120% at 85% 35%, rgba(255,173,0,.10), rgba(0,0,0,0) 60%),
    rgba(0,0,0,.28);
  border:1px solid rgba(0,215,255,.24);
  box-shadow:0 18px 44px rgba(0,0,0,.44), 0 0 30px rgba(0,215,255,.10), 0 0 18px rgba(255,173,0,.07);
}
.input{
  border:1px solid rgba(0,215,255,.22);
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset, 0 0 22px rgba(0,215,255,.06);
}


/* --- v506: Night Games neon theme (match logo colors) --- */
:root{
  --cBlue: rgba(0,215,255,.26);
  --cBlue2: rgba(42,127,255,.20);
  --cOrange: rgba(255,173,0,.22);
  --cOrange2: rgba(255,120,35,.14);
}
body::before{
  content:"";
  position:fixed; inset:-20%;
  background-image:url('./7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png');
  background-size:cover; background-position:center;
  filter: blur(34px) saturate(1.2) contrast(1.08);
  opacity:.12;
  transform:scale(1.08);
  pointer-events:none;
  z-index:-2;
}
body::after{
  content:"";
  position:fixed; inset:0;
  background:
    radial-gradient(120% 120% at 18% 12%, var(--cBlue), rgba(0,0,0,0) 54%),
    radial-gradient(120% 120% at 82% 18%, var(--cOrange), rgba(0,0,0,0) 56%),
    radial-gradient(120% 120% at 86% 78%, var(--cBlue2), rgba(0,0,0,0) 56%),
    radial-gradient(120% 120% at 14% 78%, var(--cOrange2), rgba(0,0,0,0) 58%),
    linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.78));
  pointer-events:none;
  z-index:-1;
}
.heroHeader{
  border-bottom:1px solid rgba(120,180,255,.18);
  background:
    radial-gradient(120% 140% at 12% 10%, rgba(0,215,255,.26), rgba(0,0,0,0) 55%),
    radial-gradient(120% 140% at 88% 35%, rgba(255,173,0,.22), rgba(0,0,0,0) 60%),
    linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.34));
}
.heroInner{padding:18px 14px 14px 14px;text-align:center;}
.heroLogo{
  width:min(860px,100%);
  max-height:260px;
  object-fit:contain;
  filter:drop-shadow(0 26px 46px rgba(0,0,0,.62))
         drop-shadow(0 0 24px rgba(0,215,255,.24))
         drop-shadow(0 0 20px rgba(255,173,0,.16));
}
.heroSub{color:rgba(233,242,255,.78);font-size:13px;margin-top:6px;}
.heroPanel{
  max-width:640px;
  margin:0 auto;
  background:
    radial-gradient(120% 120% at 15% 15%, rgba(0,215,255,.12), rgba(0,0,0,0) 55%),
    radial-gradient(120% 120% at 85% 35%, rgba(255,173,0,.10), rgba(0,0,0,0) 60%),
    rgba(0,0,0,.28);
  border:1px solid rgba(0,215,255,.20);
  box-shadow:0 18px 44px rgba(0,0,0,.44), 0 0 30px rgba(0,215,255,.10);
}
.input{
  border:1px solid rgba(0,215,255,.26);
  box-shadow:0 0 0 1px rgba(255,255,255,.04) inset, 0 0 26px rgba(0,215,255,.10);
}
.btn::after{
  box-shadow:
    0 0 0 1px rgba(255,255,255,.09) inset,
    0 10px 24px rgba(0,0,0,.46),
    0 0 30px rgba(0,215,255,.18);
}
.btn.green::after{
  box-shadow:
    0 0 0 1px rgba(255,255,255,.10) inset,
    0 10px 24px rgba(0,0,0,.46),
    0 0 34px rgba(46,230,107,.22),
    0 0 16px rgba(255,173,0,.10);
}

/* Sweep overlay (MP4) */
#sweepOverlay{
  position:fixed;
  inset:0;
  display:none;
  align-items:center;
  justify-content:center;
  pointer-events:none;
  z-index:9999;
}
#sweepOverlay.show{display:flex;}
#sweepVideo{
  width:min(520px, 80vw);
  height:auto;
  transform:rotate(-45deg);
  opacity:0;
  filter:drop-shadow(0 26px 46px rgba(0,0,0,.65))
         drop-shadow(0 0 18px rgba(0,215,255,.22))
         drop-shadow(0 0 14px rgba(255,173,0,.14));
}
#sweepOverlay.run #sweepVideo{animation:sweepOnce 1.35s ease-in-out forwards;}
@keyframes sweepOnce{
  0%{opacity:0; transform:translate(-18vw, 10vw) rotate(-45deg) scale(.96);}
  18%{opacity:1;}
  65%{opacity:1; transform:translate(0,0) rotate(-45deg) scale(1.0);}
  100%{opacity:0; transform:translate(18vw, -10vw) rotate(-45deg) scale(1.02);}
}

*{box-sizing:border-box}
a{color:var(--cyan);text-decoration:none}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:16px;}
.card{
  width:min(980px,100%);
  background:var(--panel);
  border-radius:var(--r);
  overflow:hidden;
  position:relative;
  border:2px solid rgba(0,0,0,0);
  box-shadow:var(--shadow), 0 0 0 2px rgba(0,215,255,.18), 0 0 26px rgba(0,215,255,.10), 0 0 18px rgba(255,173,0,.08);
}
.main{padding:14px;}
.grid{display:grid;grid-template-columns:1fr;gap:12px;}
@media (min-width:860px){.grid{grid-template-columns:1fr 1fr;}}

.header{position:relative;border-bottom:1px solid rgba(120,180,255,.14);
  background:
    radial-gradient(120% 120% at 20% 20%, rgba(0,215,255,.16), rgba(0,0,0,0) 55%),
    radial-gradient(120% 120% at 90% 10%, rgba(42,127,255,.14), rgba(0,0,0,0) 55%),
    linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.20));
}
.banner{width:100%;height:min(220px, 34vh);object-fit:cover;display:block;
  filter: drop-shadow(0 18px 34px rgba(0,0,0,.55)) saturate(1.10) contrast(1.06);
}
.bannerShade{position:absolute;inset:0;pointer-events:none;
  background:linear-gradient(180deg, rgba(0,0,0,.02), rgba(0,0,0,.58));
}
.titleRow{position:absolute;left:14px;right:14px;bottom:12px;
  display:flex;align-items:flex-end;justify-content:space-between;gap:10px;flex-wrap:wrap;
}
.h1{font-size:26px;font-weight:1000;letter-spacing:.2px;text-shadow:0 10px 30px rgba(0,0,0,.85);}
.badge{padding:8px 10px;border-radius:999px;border:1px solid rgba(0,215,255,.35);
  background:rgba(0,0,0,.35);
  box-shadow:0 0 0 3px rgba(0,215,255,.08), 0 18px 40px rgba(0,0,0,.45);
  font-weight:900;
}

.sub{color:var(--muted);font-size:13px;line-height:1.35;}
.h2{font-size:16px;font-weight:1000;opacity:.95;margin:0}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.row.space{justify-content:space-between;}
.col{display:flex;flex-direction:column;gap:10px;}

.panel{border:1px solid rgba(120,180,255,.14);background:rgba(0,0,0,.22);border-radius:16px;padding:12px;}
.input{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(120,180,255,.22);
  background:rgba(0,0,0,.35);color:var(--text);outline:none;
}
.input:focus{outline:none;border-color:rgba(255,173,0,.30);box-shadow:0 0 0 1px rgba(255,255,255,.04) inset, 0 0 26px rgba(255,173,0,.10), 0 0 20px rgba(0,215,255,.08);}

.btn{width:100%;padding:12px;border-radius:999px;border:1px solid rgba(120,180,255,.22);
  background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.18));
  color:var(--text);font-weight:900;letter-spacing:.2px;cursor:pointer;position:relative;
}
.btn::after{content:"";position:absolute;inset:0;border-radius:var(--btnR);
  box-shadow:0 0 0 1px rgba(255,255,255,.05) inset, 0 12px 28px rgba(0,0,0,.38), 0 0 18px rgba(0,215,255,.12);
  pointer-events:none;
}
.btn:hover{border-color:rgba(0,215,255,.45);}
.btn.green{background:linear-gradient(180deg, rgba(46,230,107,.18), rgba(0,0,0,.18));
  border-color:rgba(46,230,107,.45);
}
.btn.danger{background:linear-gradient(180deg, rgba(255,77,77,.14), rgba(0,0,0,.18));
  border-color:rgba(255,77,77,.40);
}
.btn.sm{width:auto;padding:8px 12px;border-radius:999px;font-size:12px;}
.btn.inline{width:auto}
.btn[disabled]{opacity:.55;pointer-events:none;}

.pulse{animation:pulseGlow 1.15s ease-in-out infinite;}
@keyframes pulseGlow{
  0%{box-shadow:0 0 0 0 rgba(46,230,107,.0);}
  50%{box-shadow:0 0 0 4px rgba(46,230,107,.10),0 0 24px rgba(46,230,107,.20);}
  100%{box-shadow:0 0 0 0 rgba(46,230,107,.0);}
}

.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
  padding:10px 12px;border:1px solid rgba(120,180,255,.14);background:rgba(0,0,0,.18);
  border-radius:16px;
}
.bigName{font-size:22px;font-weight:1000;letter-spacing:.2px;text-shadow:0 10px 30px rgba(0,0,0,.65);}

.list{display:flex;flex-direction:column;gap:10px;}
.playerRow{display:flex;align-items:center;justify-content:space-between;gap:10px;
  padding:10px;border-radius:16px;border:1px solid rgba(120,180,255,.14);background:rgba(0,0,0,.22);
}
.left{display:flex;align-items:center;gap:10px;min-width:0;}
.dot{width:10px;height:10px;border-radius:50%;background:rgba(233,242,255,.20);}
.dot.on{background:var(--green);box-shadow:0 0 14px rgba(46,230,107,.55);}
.nameWithAvatar{display:flex;align-items:center;gap:10px;min-width:0;}
.nameWithAvatar img{width:26px;height:26px;border-radius:8px;object-fit:cover;box-shadow:0 6px 16px rgba(0,0,0,.35);}
.pmeta{min-width:0;}
.pname{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pemail{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

.chip{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;
  border:1px solid rgba(120,180,255,.18);background:rgba(0,0,0,.25);font-weight:900;font-size:12px;
}
.lock{padding:10px;border-radius:16px;border:1px solid rgba(255,176,0,.35);background:rgba(255,176,0,.08);}
.ok{padding:10px;border-radius:16px;border:1px solid rgba(46,230,107,.35);background:rgba(46,230,107,.06);}

.table{width:100%;border-collapse:collapse;font-size:13px;}
.table th,.table td{padding:8px 6px;border-bottom:1px solid rgba(120,180,255,.12);text-align:left;}
.table th{color:rgba(233,242,255,.85);font-weight:1000;}

.footer{padding:10px 12px;border-top:1px solid rgba(120,180,255,.14);
  background:rgba(0,0,0,.28);color:rgba(233,242,255,.78);
  font-size:12px;line-height:1.35;text-align:center;
}
.footer b{color:#e9f2ff;}


.cards{display:grid;grid-template-columns:1fr;gap:12px;}
@media (min-width:860px){.cards{grid-template-columns:1fr 1fr;}}
.gcard{border:1px solid rgba(120,180,255,.14);background:rgba(0,0,0,.20);border-radius:18px;padding:12px;
  box-shadow:0 12px 26px rgba(0,0,0,.26), 0 0 22px rgba(0,215,255,.05);
}
.gtitle{font-weight:1000;font-size:16px;letter-spacing:.2px;}
.gsub{color:var(--muted);font-size:12px;margin-top:2px;}
.grow{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-top:10px;}
@media (max-width:520px){.grow{grid-template-columns:1fr;}}

@media (min-width:860px){.gameGrid{grid-template-columns:repeat(2,1fr);}}
.btn.neon{border-color:rgba(0,215,255,.42);background:linear-gradient(180deg, rgba(0,215,255,.12), rgba(0,0,0,.18));}
.btn.neon:hover{box-shadow:0 0 0 4px rgba(0,215,255,.10), 0 0 26px rgba(0,215,255,.18);}
.smallList .playerRow{padding:9px;}
.smallList .pemail{display:none;}

/* Modal */
#modalBg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:999998;}
#modalBg.show{display:block;}
#modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(560px,calc(100% - 28px));
  background:rgba(10,12,16,.92);border:1px solid rgba(120,180,255,.22);
  border-radius:18px;box-shadow:0 24px 60px rgba(0,0,0,.65);padding:14px;display:none;z-index:999999;
}
#modal.show{display:block;}
.modalTitle{font-size:16px;font-weight:1000;}
.modalBody{margin-top:8px;}
.modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}

/* Sweep overlay (MP4 one-time) */
#sweepOverlay{position:fixed;inset:0;z-index:999999;pointer-events:none;display:none;}
#sweepOverlay.show{display:block;}
#sweepVideo{position:absolute;inset:-25% -35%;width:170%;height:170%;object-fit:cover;
  transform:translateX(-120%) translateY(18%) rotate(-18deg);opacity:0;mix-blend-mode:screen;
  filter:brightness(1.05) contrast(1.05) saturate(1.1);
}
#sweepOverlay.run #sweepVideo{opacity:.95;animation:sweepOnce 1.65s ease-out forwards;}
@keyframes sweepOnce{
  0%{transform:translateX(-120%) translateY(18%) rotate(-18deg);opacity:0;}
  10%{opacity:.95;}
  85%{opacity:.95;}
  100%{transform:translateX(120%) translateY(-18%) rotate(-18deg);opacity:0;}
}


#errBox{position:fixed;left:12px;right:12px;bottom:12px;z-index:9999;
  background:rgba(20,0,0,.92);border:1px solid rgba(255,80,80,.5);
  border-radius:14px;padding:12px;display:none;color:#ffd7d7;
  box-shadow:0 16px 40px rgba(0,0,0,.55), 0 0 22px rgba(255,80,80,.18);
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;
  font-size:12px;white-space:pre-wrap;
}
#errBox b{font-family:inherit;}

/* --- v506: stronger global neon wash (blue + orange) --- */
body::after{
  background:
    radial-gradient(140% 140% at 14% 10%, rgba(0,215,255,.28), rgba(0,0,0,0) 58%),
    radial-gradient(140% 140% at 86% 16%, rgba(255,173,0,.24), rgba(0,0,0,0) 60%),
    radial-gradient(140% 140% at 86% 86%, rgba(42,127,255,.22), rgba(0,0,0,0) 62%),
    radial-gradient(140% 140% at 14% 86%, rgba(255,120,35,.16), rgba(0,0,0,0) 64%),
    linear-gradient(180deg, rgba(0,0,0,.42), rgba(0,0,0,.82));
}
</style>
</head>
<body>

<div id="sweepOverlay">
  <video id="sweepVideo" muted playsinline preload="auto">
    <source src="0217.mp4" type="video/mp4"/>
  </video>
</div>

<div id="modalBg"></div>
<div id="modal"></div>


<div class="wrap"><div id="app" class="card">
  <div class="header heroHeader">
    <div class="heroInner">
      <img class="heroLogo" src="${asset('7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png')}" alt="Night Games"
        onerror="this.onerror=null; this.src='7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png';"/>
      <div class="heroTitle">Night Games</div>
      <div class="heroSub">Enter your email to continue â€¢ v506</div>
    </div>
  </div>
  <div class="main">
    <div class="panel heroPanel">
      <div class="h2" style="margin:0 0 6px 0;">Sign in</div>
      <div class="sub">Email only. If youâ€™re new, weâ€™ll ask your name one time.</div>
      <div style="height:10px"></div>
      <input id="inEmail" class="input" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
      <div style="height:10px"></div>
      <button id="btnEnter" class="btn green pulse">Enter</button>
      <div style="height:8px"></div>
      <button id="btnClearRemember" class="btn">Clear saved login</button>
    </div>
  </div>
  <div class="footer">
    <b>Night Games</b> is owned by <b>The Dart Room</b>. Â© 2026 The Dart Room. All rights reserved. â€¢
    Designed by <b>Steveâ€™s Graphic Designs</b>.
  </div>
</div></div>

<div id="fatalErr" style="position:fixed;left:10px;right:10px;bottom:10px;z-index:999999;display:none;padding:10px 12px;border-radius:14px;background:rgba(60,0,0,.78);border:1px solid rgba(255,77,77,.55);color:#ffd6d6;font:12px/1.3 system-ui;box-shadow:0 18px 40px rgba(0,0,0,.55);white-space:pre-wrap;"></div>

<script>
// v506: Global error handlers so we NEVER get a blank page with no clue.
(function(){
  function show(msg){
    try{
      var el=document.getElementById("fatalErr");
      if(!el) return;
      el.style.display="block";
      el.textContent="ERROR:\n"+msg;
    }catch(_){ }
  }
  window.addEventListener("error", function(e){ show((e && e.message) ? e.message : String(e)); });
  window.addEventListener("unhandledrejection", function(e){ show((e && e.reason) ? (e.reason.message||String(e.reason)) : "Unhandled rejection"); });
})();

/* ============================
   Config / Helpers
   ============================ */
const BUILD=506;

const ASSET_BASE = new URL('.', document.baseURI).toString();
const asset = (p)=> new URL(p, ASSET_BASE).toString();

const BANNER_PRIMARY="7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png?v=496";
const BANNER_FALLBACK="7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png?v=496";
const OWNER_EMAIL="stevewmoody@yahoo.com";
const OWNER_NAME="Steve Moody";
const firebaseConfig = {"apiKey": "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo", "authDomain": "gamenightdarts-e7601.firebaseapp.com", "projectId": "gamenightdarts-e7601", "storageBucket": "gamenightdarts-e7601.firebasestorage.app", "messagingSenderId": "270045452251", "appId": "1:270045452251:web:5a4a661140a60780e939fe", "measurementId": "G-M60TDFYBW0"};

const $=(s,r=document)=>r.querySelector(s);

function showError(msg){
  const box=document.getElementById("errBox");
  if(!box) return;
  box.style.display="block";
  box.innerHTML = "<b>Build v506 error:</b>\n"+String(msg);
}
window.addEventListener("error",(e)=>{
  showError(e?.error?.stack || e?.message || e);
});
window.addEventListener("unhandledrejection",(e)=>{
  showError(e?.reason?.stack || e?.reason || e);
});
const store={
  get(k,f=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v));},
  del(k){localStorage.removeItem(k);}
};
function normEmail(e){return String(e||"").trim().toLowerCase();}
function normName(n,email){const v=String(n||"").trim(); return v?v:normEmail(email);}
function getAvatarFor(p){
  const name=(p?.name||"").toLowerCase();
  const email=(p?.email||"").toLowerCase();

  // Repo-confirmed filenames:
  // - MY DART AVATAR.png (Steve)
  // - WILLIAM DART AVATAR.png (Bill/William)
  if(name.includes("steve") || email.includes("stevewmoody")) return "MY DART AVATAR.png";
  if(name.includes("william") || name.includes("bill")) return "WILLIAM DART AVATAR.png";

  // Default for anyone else until their avatar file is added to repo
  return "MY DART AVATAR.png";
}

function nowMs(){return Date.now();}

function setHtml(h){ $("#app").innerHTML=h; }
function footer(){
  return `
    <div class="footer">
      <b>Night Games</b> is owned by <b>The Dart Room</b>. Â© 2026 The Dart Room. All rights reserved. â€¢
      Designed by <b>Steveâ€™s Graphic Designs</b>.
    </div>
  `;
}
function headerBanner(title="Night Games", opts={}){
  const showTitleBelow = !!opts.titleBelow; // landing: logo above title
  return `
    <div class="header">
      <img class="banner" src="${BANNER_PRIMARY}" alt="Night Games Banner"
        onerror="this.onerror=null; this.src='${BANNER_FALLBACK}';"/>
      <div class="bannerShade"></div>
      ${showTitleBelow ? `
        <div class="titleRow" style="position:relative; left:auto; right:auto; bottom:auto; padding:12px 14px 0 14px;">
          <div class="h1">${title}</div>
          <div class="badge">v${BUILD}</div>
        </div>
      ` : `
        <div class="titleRow">
          <div class="h1">${title}</div>
          <div class="badge">v${BUILD}</div>
        </div>
      `}
    </div>
  `;
}
function avatarFor(email,name){
  const e=normEmail(email);
  const n=String(name||"").toLowerCase();
  if(e===normEmail(OWNER_EMAIL)) return "MY DART AVATAR.png";
  if(n.includes("bill moody")||n.includes("william moody")||n.includes("william")) return "WILLIAM DART AVATAR.png";
  if(n.includes("jace")||n.includes("jayce")) return "MY DART AVATAR.png";
  return null;
}

/* ============================
   Sound (speaker button)
   ============================ */
let audioCtx=null;
function soundOn(){return store.get("soundOn", true);}
function setSound(on){store.set("soundOn", !!on);}
function beep(freq=520, ms=45, gain=0.04){
  if(!soundOn()) return;
  try{
    if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)();
    const o=audioCtx.createOscillator();
    const g=audioCtx.createGain();
    o.type="sine"; o.frequency.value=freq;
    g.gain.value=gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>o.stop(), ms);
  }catch(_){}
}
document.addEventListener("click", (e)=>{
  const btn=e.target.closest("button");
  if(btn) beep();
});

/* ============================
   Modal
   ============================ */
function closeModal(){
  $("#modalBg").classList.remove("show");
  $("#modal").classList.remove("show");
  $("#modal").innerHTML="";
}
function openModal(title, bodyHtml, actionsHtml){
  $("#modal").innerHTML = `
    <div class="modalTitle">${title}</div>
    <div class="modalBody">${bodyHtml}</div>
    <div class="modalActions">${actionsHtml||""}</div>
  `;
  $("#modalBg").classList.add("show");
  $("#modal").classList.add("show");
  $("#modalBg").onclick=closeModal;
}

/* ============================
   Sweep (once)
   ============================ */
function runSweepOnce(){
  const key="sweepShown_v506";
  if(store.get(key,false)) return;

  const ov=$("#sweepOverlay");
  const v=$("#sweepVideo");
  if(!ov||!v) return;

  store.set(key,true);

  ov.classList.add("show");
  ov.classList.add("run");

  try{
    v.loop=false;
    v.currentTime=0;
    v.play().catch(()=>{
      // Autoplay may be blocked; animation still runs.
    });
  }catch(_){}

  const hide=()=>{
    ov.classList.remove("run");
    ov.classList.remove("show");
  };

  // Hide after ~1.6s (animation length). If video ends sooner, also hide.
  v.addEventListener("ended", hide, {once:true});
  setTimeout(hide, 1700);
}
  const done=()=>{
    ov.classList.remove("run");
    ov.classList.remove("show");
  };
  v.addEventListener("ended", done, {once:true});
  setTimeout(done, 2200);
}

/* If autoplay is blocked on some devices, run the sweep on the first user gesture. */
window.addEventListener("pointerdown", ()=>runSweepOnce(), {once:true});
window.addEventListener("keydown", ()=>runSweepOnce(), {once:true});

/* ============================
   Firebase
   ============================ */
let fb={app:null,auth:null,db:null};
function initFirebase(){
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  fb.app=firebase.app();
  fb.auth=firebase.auth();
  fb.db=firebase.firestore();
}
async function ensureBackendAuth(){
  if(fb.auth.currentUser) return fb.auth.currentUser;
  const cred=await fb.auth.signInAnonymously();
  return cred.user;
}
async function safeInit(){
  try{
    initFirebase();
    await ensureBackendAuth();
    return true;
  }catch(e){
    alert("Firebase init/auth failed:\n\n"+(e?.message||e));
    return false;
  }
}

/* ============================
   Presence (online dot)
   ============================ */
let presenceTimer=null;
let unsubPresence=null;
function startPresence(me){
  if(unsubPresence) unsubPresence();
  if(presenceTimer) clearInterval(presenceTimer);

  const email=normEmail(me.email);
  const ref=fb.db.collection("presence").doc(email);

  async function ping(){
    try{
      await ref.set({
        email,
        name: me.name,
        lastSeenMs: nowMs(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, {merge:true});
    }catch(_){}
  }

  ping();
  presenceTimer=setInterval(ping, 25000);

  unsubPresence=fb.db.collection("presence").onSnapshot((snap)=>{
    const m=new Map();
    snap.forEach(doc=>{
      const d=doc.data()||{};
      if(d.email) m.set(normEmail(d.email), d);
    });
    App.presence=m;
    if(App.screen==="players") render();
  });
}
function isOnline(email){
  const p=App.presence.get(normEmail(email));
  if(!p) return false;
  const ms=Number(p.lastSeenMs||0);
  return (nowMs()-ms)<=90000;
}

/* ============================
   App state
   ============================ */
const GAMES=[
  {id:"shanghai", name:"Shanghai"},
  {id:"killer", name:"Killer"},
  {id:"around", name:"Around the World"},
  {id:"cricket", name:"Cricket"},
  {id:"01", name:"01"},
];

const App={
  screen:"auth",
  me:null,
  players:[],
  presence:new Map(),
  matches:[],
  match:null,
  matchId:null,
  unsubMatches:null,
  unsubMatch:null,
  params:{},
};

function go(screen, params={}){
  App.screen=screen;
  App.params=params||{};
  render();
}

function topbar(){
  const sOn=soundOn();
  return `
    <div class="topbar">
      <div>
        <div class="bigName">${App.me?.name||""}</div>
        <div class="sub">${App.me?.email||""}</div>
      </div>
      <div class="row">
        <button class="btn sm" id="btnSpeaker">${sOn?"ðŸ”Š":"ðŸ”‡"}</button>
        <button class="btn sm" id="btnPlayers">Players</button>
        <button class="btn sm danger" id="btnSignOut">Sign out</button>
      </div>
    </div>
  `;
}

/* ============================
   Players collection
   ============================ */
async function ensureOwner(){
  try{
    await fb.db.collection("players").doc(normEmail(OWNER_EMAIL)).set({
      email:normEmail(OWNER_EMAIL),
      name:OWNER_NAME,
      locked:true,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, {merge:true});
  }catch(_){}
}
async function loadPlayers(){
  const snap=await fb.db.collection("players").get();
  App.players=snap.docs.map(d=>d.data()).filter(Boolean).map(p=>({
    email:normEmail(p.email),
    name:normName(p.name,p.email),
    locked: !!p.locked || normEmail(p.email)===normEmail(OWNER_EMAIL)
  }));
  if(!App.players.some(p=>p.email===normEmail(OWNER_EMAIL))){
    App.players.unshift({email:normEmail(OWNER_EMAIL), name:OWNER_NAME, locked:true});
    await ensureOwner();
  }
}
async function upsertPlayer(email,name){
  email=normEmail(email); name=normName(name,email);
  await fb.db.collection("players").doc(email).set({
    email, name,
    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  }, {merge:true});
}

/* ============================
   Matches (no codes)
   ============================ */
function randId(len=18){
  const chars="abcdefghijklmnopqrstuvwxyz0123456789";
  let s="";
  for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
  return s;
}
function subscribeMatches(){
  if(App.unsubMatches) App.unsubMatches();
  App.unsubMatches=fb.db.collection("matches")
    .orderBy("createdAtMs","desc")
    .limit(25)
    .onSnapshot((snap)=>{
      const list=[];
      snap.forEach(doc=>{
        const d=doc.data()||{};
        if(d.status==="open" || d.status==="active"){
          d.matchId=doc.id;
          list.push(d);
        }
      });
      App.matches=list;
      if(App.screen==="player") render();
    });
}
function subscribeMatch(matchId){
  if(App.unsubMatch) App.unsubMatch();
  App.unsubMatch=fb.db.collection("matches").doc(matchId).onSnapshot((doc)=>{
    if(!doc.exists){
      App.match=null; App.matchId=null;
      if(App.screen.startsWith("game_")) go("player");
      return;
    }
    App.match=doc.data()||{};
    App.matchId=matchId;
    if(App.screen.startsWith("game_")) render();
  });
}

function matchTitle(gameId, settings){
  if(gameId==="01"){
    const base=settings.base||501;
    const inMode=settings.inMode||"straight";
    const outMode=settings.outMode||"double";
    return `01 â€¢ ${base} â€¢ ${inMode}-in/${outMode}-out`;
  }
  if(gameId==="cricket") return "Cricket â€¢ Standard";
  return `${(GAMES.find(g=>g.id===gameId)?.name)||gameId}`;
}

function initGameState(gameId, settings, seats){
  if(gameId==="01"){
    const base = Number(settings.base||501);
    const leftBySeat={};
    seats.forEach(s=>{ leftBySeat[s.seat]=base; });
    return {leftBySeat, winnerSeat:null};
  }
  if(gameId==="cricket"){
    const keys=["20","19","18","17","16","15","B"];
    const marks={};
    const score={};
    seats.forEach(s=>{
      marks[s.seat]={};
      keys.forEach(k=>marks[s.seat][k]=0);
      score[s.seat]=0;
    });
    return {marks, score, winnerSeat:null};
  }
  return {note:"placeholder", winnerSeat:null};
}

async function createMatch(gameId, settings, seatCount=2){
  const matchId=randId(20);
  const seats=[];
  for(let i=0;i<seatCount;i++){
    seats.push({seat:i+1, email:"", name:""});
  }
  // creator claims seat 1
  seats[0]={seat:1, email:App.me.email, name:App.me.name};

  await fb.db.collection("matches").doc(matchId).set({
    status:"open",
    createdAtMs: nowMs(),
    updatedAtMs: nowMs(),
    createdBy: App.me.email,
    title: matchTitle(gameId, settings),
    gameId,
    settings,
    seats,
    turnSeat: settings.startingSeat||1,
    turnEmail: (settings.startingSeat||1)===1 ? App.me.email : "",
    state: initGameState(gameId, settings, seats),
    log: []
  });

  subscribeMatch(matchId);
  go("game_"+gameId, {matchId});
}

async function claimSeat(matchId, seatNum){
  const ref=fb.db.collection("matches").doc(matchId);
  await fb.db.runTransaction(async (tx)=>{
    const snap=await tx.get(ref);
    if(!snap.exists) throw new Error("Match not found.");
    const m=snap.data()||{};
    const seats=(m.seats||[]).map(s=>({...s}));
    const seat=seats.find(s=>Number(s.seat)===Number(seatNum));
    if(!seat) throw new Error("Seat not found.");
    if(seat.email && normEmail(seat.email)!==normEmail(App.me.email)){
      throw new Error("Seat already taken.");
    }
    seat.email=App.me.email;
    seat.name=App.me.name;

    // if match has no turnEmail yet, set it to first seat's email
    let turnSeat=m.turnSeat||1;
    let turnEmail=m.turnEmail||"";
    const ts=seats.find(s=>Number(s.seat)===Number(turnSeat));
    if(ts && ts.email) turnEmail=ts.email;

    tx.update(ref, {seats, status:"active", turnSeat, turnEmail, updatedAtMs: nowMs()});
  });
}

function mySeat(m){
  const email=normEmail(App.me?.email);
  return (m.seats||[]).find(s=>normEmail(s.email)===email)?.seat || null;
}
function isMyTurn(m){
  return normEmail(m.turnEmail)===normEmail(App.me?.email);
}

/* ============================
   Game actions
   ============================ */
async function submit01(matchId, points){
  const ref=fb.db.collection("matches").doc(matchId);
  await fb.db.runTransaction(async (tx)=>{
    const snap=await tx.get(ref);
    if(!snap.exists) throw new Error("Match not found.");
    const m=snap.data()||{};
    if(normEmail(m.turnEmail)!==normEmail(App.me.email)) throw new Error("Not your turn.");
    const seat=mySeat(m);
    if(!seat) throw new Error("You are not seated in this match.");

    const pts=Math.max(0, Math.min(180, Number(points||0)));
    const state=m.state||{};
    const leftBySeat={...(state.leftBySeat||{})};
    const left=Number(leftBySeat[seat]||0);
    const newLeft=left-pts;

    let appliedLeft=left;
    let winnerSeat=state.winnerSeat||null;

    if(newLeft===0){
      appliedLeft=0; winnerSeat=seat;
    }else if(newLeft>0){
      appliedLeft=newLeft;
    } // else bust => no change

    leftBySeat[seat]=appliedLeft;

    const seats=m.seats||[];
    const ordered=seats.map(s=>Number(s.seat)).sort((a,b)=>a-b);
    let idx=ordered.indexOf(Number(m.turnSeat)); if(idx<0) idx=0;
    let nextSeat=ordered[(idx+1)%ordered.length];
    if(winnerSeat) nextSeat=seat;

    const nextSeatObj=seats.find(s=>Number(s.seat)===Number(nextSeat))||{};
    const nextEmail=nextSeatObj.email||"";

    const log=(m.log||[]).slice(0,300);
    log.unshift({t:nowMs(), game:"01", seat, name:App.me.name, email:App.me.email, pts, leftBefore:left, leftAfter:appliedLeft});

    tx.update(ref, {
      state:{...state, leftBySeat, winnerSeat},
      turnSeat: nextSeat,
      turnEmail: nextEmail,
      status:"active",
      updatedAtMs: nowMs(),
      log
    });
  });
}

async function submitCricket(matchId, marksThisTurn){
  const ref=fb.db.collection("matches").doc(matchId);
  await fb.db.runTransaction(async (tx)=>{
    const snap=await tx.get(ref);
    if(!snap.exists) throw new Error("Match not found.");
    const m=snap.data()||{};
    if(normEmail(m.turnEmail)!==normEmail(App.me.email)) throw new Error("Not your turn.");
    const seat=mySeat(m);
    if(!seat) throw new Error("You are not seated in this match.");

    const state=m.state||{};
    const marks=JSON.parse(JSON.stringify(state.marks||{}));
    const score={...(state.score||{})};
    const keys=["20","19","18","17","16","15","B"];

    let totalAdded=0;
    keys.forEach(k=>{
      const add=Math.max(0, Math.min(3, Number(marksThisTurn[k]||0)));
      totalAdded+=add;
      if(!marks[seat]) marks[seat]={};
      marks[seat][k]=Number(marks[seat][k]||0)+add;
    });

    const val={"20":20,"19":19,"18":18,"17":17,"16":16,"15":15,"B":25};
    let gained=0;
    keys.forEach(k=>{
      const before = Number(state.marks?.[seat]?.[k]||0);
      const after = Number(marks[seat][k]||0);
      const beforeOver=Math.max(0, before-3);
      const afterOver=Math.max(0, after-3);
      const inc=afterOver-beforeOver;
      if(inc>0) gained += inc*val[k];
    });
    score[seat]=Number(score[seat]||0)+gained;

    let winnerSeat=state.winnerSeat||null;
    const closedAll = keys.every(k=>Number(marks[seat][k]||0)>=3);
    if(closedAll){
      let maxOther=0;
      Object.keys(score).forEach(s=>{
        if(Number(s)!==Number(seat)) maxOther=Math.max(maxOther, Number(score[s]||0));
      });
      if(Number(score[seat]||0)>=maxOther) winnerSeat=seat;
    }

    const seats=m.seats||[];
    const ordered=seats.map(s=>Number(s.seat)).sort((a,b)=>a-b);
    let idx=ordered.indexOf(Number(m.turnSeat)); if(idx<0) idx=0;
    let nextSeat=ordered[(idx+1)%ordered.length];
    if(winnerSeat) nextSeat=seat;

    const nextSeatObj=seats.find(s=>Number(s.seat)===Number(nextSeat))||{};
    const nextEmail=nextSeatObj.email||"";

    const log=(m.log||[]).slice(0,300);
    log.unshift({t:nowMs(), game:"cricket", seat, name:App.me.name, email:App.me.email, totalMarks:totalAdded, gained, scoreAfter:score[seat]});

    tx.update(ref, {
      state:{...state, marks, score, winnerSeat},
      turnSeat: nextSeat,
      turnEmail: nextEmail,
      status:"active",
      updatedAtMs: nowMs(),
      log
    });
  });
}

/* ============================
   Screens
   ============================ */

async function onStart(){
  try{
    const inEl=$("#inEmail");
    const email = normEmail((inEl?.value || ""));
    if(inEl) inEl.value=""; // auto-clear so next person never sees the previous email
    if(!email){
      alert("Enter your email.");
      return;
    }

    // ensure firebase initialized + anonymous session
    await safeInit();

    // load players and find existing
    await loadPlayers();
    let p = (App.players||[]).find(x=>normEmail(x.email)===email);

    if(!p){
      const nameRaw = prompt("New player. Enter your name:");
      const name = normName(nameRaw||"");
      if(!name){
        alert("Name is required for a new player.");
        return;
      }
      p = await upsertPlayer({email, name});
      await loadPlayers();
    }

    // remember for convenience (but landing still shows first by design in this build series)
    store.set("me", {email: p.email, name: p.name, ts: nowMs()});

    App.me = p;
    go("player");
  }catch(err){
    showError(err);
  }
}

function screenAuth(){
  setHtml(`
    <div class="header heroHeader">
      <div class="heroInner">
        <img class="heroLogo" src="./7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png" alt="Night Games"
          onerror="this.style.display='none'"/>
        <div class="heroSub">Enter your email to continue â€¢ v${BUILD}</div>
      </div>
    </div>

    <div class="main">
      <div class="panel heroPanel">
        <h3 class="h2">Sign in</h3>
        <div class="sub">Email only. If youâ€™re new, weâ€™ll ask your name one time.</div>
        <div style="height:10px"></div>
        <input id="inEmail" class="input" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
        <div style="height:10px"></div>
        <button id="btnEnter" class="btn green pulse">Enter</button>
        <div style="height:8px"></div>
        <button id="btnClearRemember" class="btn">Clear saved login</button>
      </div>
    </div>
    ${footer()}
  `);

  $("#btnEnter").onclick=onStart;
  $("#inEmail").addEventListener("keydown", (e)=>{ if(e.key==="Enter") onStart(); });
  $("#btnClearRemember").onclick=()=>{ store.del("me"); $("#inEmail").value=""; alert("Saved login cleared."); };

  
  // Diagonal sweep once on landing (autoplay may be blocked; first tap will trigger it)
  setTimeout(()=>runSweepOnce(), 350);
}
function screenPlayer(){
  setHtml(`
    ${headerBanner("Night Games")}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">Games</h3>
          <div class="sub">Tap <b>Play</b> or <b>History</b> for each game.</div>
        </div>
        <div style="height:10px"></div>

        <div class="cards" id="gameCards"></div>

        <div style="height:14px"></div>
        <div class="row space">
          <h3 class="h2" style="margin:0">Players</h3>
          <div class="sub">Green dot = online.</div>
        </div>
        <div style="height:10px"></div>
        <div id="playersUnderGames" class="list smallList"></div>
      </div>

      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">Matches</h3>
          <button class="btn sm green" id="btnNewMatch">New match</button>
        </div>
        <div class="sub">Create a match and others can join from their device.</div>
        <div style="height:10px"></div>
        <div id="matches" class="list"></div>
      </div>

      <div style="height:10px"></div>
      <div class="sub">Need the email gate page? Hit <b>Sign out</b>.</div>
    </div>
    ${footer()}
  `);

  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();

  const host=$("#gameCards");
  host.innerHTML = GAMES.map(g=>`
    <div class="gcard">
      <div class="gtitle">${g.name}</div>
      <div class="gsub">Quick actions</div>
      <div class="grow">
        <button class="btn neon ${g.id==="cricket"||g.id==="01"?"green pulse":""}" data-play="${g.id}">Play</button>
        <button class="btn" data-history="${g.id}">History</button>
        <button class="btn" data-stats="${g.id}">Stats</button>
      </div>
    </div>
  `).join("");

  host.querySelectorAll("button[data-play]").forEach(b=>{
    b.onclick=()=>go("game_setup",{gameId:b.getAttribute("data-play")});
  });
  host.querySelectorAll("button[data-history]").forEach(b=>{
    b.onclick=()=>go("history",{gameId:b.getAttribute("data-history")});
  });
  host.querySelectorAll("button[data-stats]").forEach(b=>{
    b.onclick=()=>go("stats",{gameId:b.getAttribute("data-stats")});
  });

  renderPlayersUnderGames();
  renderMatchesList();
  $("#btnNewMatch").onclick=()=>go("game_setup", {gameId:"01"});
}

function renderPlayersUnderGames(){
  const host=$("#playersUnderGames");
  if(!host) return;
  const players=[...(App.players||[])].sort((a,b)=>a.name.localeCompare(b.name)).slice(0,8);
  host.innerHTML = players.map(p=>{
    const online=isOnline(p.email);
    const av=avatarFor(p.email,p.name);
    return `
      <div class="playerRow">
        <div class="left">
          <span class="dot ${online?"on":""}"></span>
          <div class="nameWithAvatar">
            ${av?`<img src="${av}" alt="avatar" onerror="this.style.display='none'"/>`:""}
            <div class="pmeta">
              <div class="pname">${p.name}${p.locked?' <span class="chip">owner</span>':""}</div>
              <div class="pemail">${p.email}</div>
            </div>
          </div>
        </div>
        <div class="row">
          <span class="chip">${online?"online":"offline"}</span>
        </div>
      </div>
    `;
  }).join("");
}
function renderMatchesList(){
  const host=$("#matches");
  if(!host) return;
  const list=App.matches||[];

  if(list.length===0){
    host.innerHTML = `<div class="sub">No open matches yet.</div>`;
    return;
  }

  host.innerHTML = list.map(m=>{
    const seats=m.seats||[];
    const taken=seats.filter(s=>s.email).length;
    const online = seats.some(s=>s.email && isOnline(s.email));
    return `
      <div class="playerRow">
        <div class="left">
          <span class="dot ${online?"on":""}"></span>
          <div class="pmeta" style="min-width:0">
            <div class="pname">${m.title||m.gameId||"Match"}</div>
            <div class="pemail">${taken}/${seats.length} seated â€¢ ${m.status}</div>
          </div>
        </div>
        <div class="row">
          <button class="btn sm" data-open="${m.matchId}">Open</button>
        </div>
      </div>
    `;
  }).join("");

  host.querySelectorAll("button[data-open]").forEach(btn=>{
    btn.onclick=()=>{
      const id=btn.getAttribute("data-open");
      subscribeMatch(id);
      const m=App.matches.find(x=>x.matchId===id);
      const gameId=m?.gameId || "01";
      go("game_"+gameId, {matchId:id, gameId});
    };
  });
}

function screenPlayers(){
  setHtml(`
    ${headerBanner("Players")}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">Players</h3>
          <button class="btn sm" id="btnBack">Back</button>
        </div>
        <div class="sub">Green dot means online (last ping within 90 seconds).</div>
        <div style="height:10px"></div>
        <div id="plist" class="list"></div>
      </div>
    </div>
    ${footer()}
  `);

  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");

  const plist=$("#plist");
  const players=[...App.players].sort((a,b)=>a.name.localeCompare(b.name));
  plist.innerHTML = players.map(p=>{
    const av=avatarFor(p.email,p.name);
    const online=isOnline(p.email);
    return `
      <div class="playerRow">
        <div class="left">
          <span class="dot ${online?"on":""}"></span>
          <div class="nameWithAvatar">
            ${av?`<img src="${av}" alt="avatar" onerror="this.style.display='none'"/>`:""}
            <div class="pmeta">
              <div class="pname">${p.name}${p.locked?' <span class="chip">owner</span>':""}</div>
              <div class="pemail">${p.email}</div>
            </div>
          </div>
        </div>
        <div class="row">
          <span class="chip">${online?"online":"offline"}</span>
        </div>
      </div>
    `;
  }).join("");
}


function screenHistory(){
  const gameId=App.params.gameId;
  const g=GAMES.find(x=>x.id===gameId) || {id:gameId,name:gameId};
  setHtml(`
    ${headerBanner("Game History")}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>
      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">${g.name} â€¢ Game History</h3>
          <button class="btn sm" id="btnBack">Back</button>
        </div>
        <div style="height:10px"></div>
        <div class="ok">History view is wired as a real page in v506. Next pass we populate it from match logs / saved games.</div>
      </div>
    </div>
    ${footer()}
  `);
  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");
}

function screenStats(){
  const gameId=App.params.gameId;
  const g=GAMES.find(x=>x.id===gameId) || {id:gameId,name:gameId};
  setHtml(`
    ${headerBanner("Stats")}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>
      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">${g.name} â€¢ Stats</h3>
          <button class="btn sm" id="btnBack">Back</button>
        </div>
        <div style="height:10px"></div>
        <div class="ok">Stats page is a real page in v506. Next pass we show the stat definitions + your notables.</div>
      </div>
    </div>
    ${footer()}
  `);
  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");
}

function screenGameSetup(){
  const gameId=App.params.gameId;
  const g=GAMES.find(x=>x.id===gameId) || {id:gameId,name:gameId};
  const is01 = gameId==="01";
  const isCricket = gameId==="cricket";

  setHtml(`
    ${headerBanner(g.name)}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">${g.name} setup</h3>
          <button class="btn sm" id="btnBack">Back</button>
        </div>
        <div class="sub">Pick 2 players and choose who starts (manual or random).</div>
        <div style="height:12px"></div>

        <div class="grid">
          <div class="panel">
            <h3 class="h2">Players (2)</h3>
            <div class="sub">Teams come next pass. This first full run keeps it simple.</div>
            <div style="height:10px"></div>
            <select id="p1" class="input"></select>
            <div style="height:10px"></div>
            <select id="p2" class="input"></select>
            <div style="height:10px"></div>
            <button class="btn" id="btnRandomStart">Random who starts</button>
            <div class="sub" id="startInfo" style="margin-top:8px;"></div>
          </div>

          <div class="panel">
            <h3 class="h2">Options</h3>
            ${is01?`
              <div class="sub">Pick 301 / 501 / 701 and in/out options.</div>
              <div style="height:10px"></div>
              <select id="base" class="input">
                <option value="301">301</option>
                <option value="501" selected>501</option>
                <option value="701">701</option>
              </select>
              <div style="height:10px"></div>
              <select id="inMode" class="input">
                <option value="straight" selected>Straight in</option>
                <option value="double">Double in</option>
              </select>
              <div style="height:10px"></div>
              <select id="outMode" class="input">
                <option value="double" selected>Double out</option>
                <option value="straight">Straight out</option>
              </select>
            `: isCricket?`
              <div class="ok">Cricket standard numbers 20â€“15 + bull.</div>
            `:`
              <div class="ok">Placeholder screen included so the build is complete.</div>
            `}
            <div style="height:12px"></div>
            <button class="btn green pulse" id="btnCreate">Create match</button>
          </div>
        </div>
      </div>
    </div>
    ${footer()}
  `);

  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");

  const players=[...App.players].sort((a,b)=>a.name.localeCompare(b.name));
  const options=players.map(p=>`<option value="${p.email}">${p.name} (${p.email})</option>`).join("");
  $("#p1").innerHTML=options;
  $("#p2").innerHTML=options;

  const meEmail=normEmail(App.me.email);
  $("#p1").value=meEmail;
  const other=players.find(p=>p.email!==meEmail) || players[0];
  $("#p2").value=other.email;

  let startingSeat=1;
  const updateStartInfo=()=>{
    const p1=$("#p1").value; const p2=$("#p2").value;
    const n1=players.find(p=>p.email===p1)?.name||p1;
    const n2=players.find(p=>p.email===p2)?.name||p2;
    const startName = startingSeat===1?n1:n2;
    $("#startInfo").textContent = "Starts first: " + startName;
  };
  updateStartInfo();

  $("#btnRandomStart").onclick=()=>{ startingSeat = (Math.random()<0.5)?1:2; updateStartInfo(); };
  $("#p1").onchange=updateStartInfo;
  $("#p2").onchange=updateStartInfo;

  $("#btnCreate").onclick=async ()=>{
    const p1=$("#p1").value;
    const p2=$("#p2").value;
    if(p1===p2){ alert("Pick two different players."); return; }

    const n1=players.find(p=>p.email===p1)?.name||p1;
    const n2=players.find(p=>p.email===p2)?.name||p2;

    // settings
    const settings = is01 ? {
      base:Number($("#base").value),
      inMode:$("#inMode").value,
      outMode:$("#outMode").value,
      startingSeat
    } : {startingSeat};

    // create match, then set seat 2 to chosen player if it's you; otherwise it's open and they join
    try{
      await createMatch(gameId, settings, 2);
      // after create, we can set seat2 to the selected opponent immediately (so it feels like your old builds)
      const matchId=App.matchId;
      const ref=fb.db.collection("matches").doc(matchId);
      await fb.db.runTransaction(async (tx)=>{
        const snap=await tx.get(ref);
        if(!snap.exists) return;
        const m=snap.data()||{};
        const seats=(m.seats||[]).map(s=>({...s}));
        seats[0]={seat:1,email:p1,name:n1};
        seats[1]={seat:2,email:p2,name:n2};
        // set turn email to starting seat email
        const ts=seats.find(s=>Number(s.seat)===Number(startingSeat));
        tx.update(ref, {seats, turnSeat:startingSeat, turnEmail:ts?.email||"", status:"active", updatedAtMs: nowMs()});
      });
      subscribeMatch(matchId);
      go("game_"+gameId, {matchId});
    }catch(e){
      alert("Could not create match:\n\n"+(e?.message||e));
    }
  };
}

function screenGameCricket(){
  const m=App.match;
  if(!m){ go("player"); return; }

  const seats=m.seats||[];
  const seatMe=mySeat(m);
  const myTurn=isMyTurn(m);
  const winner=m.state?.winnerSeat || null;

  const scoreRows=seats.map(s=>{
    const online=isOnline(s.email);
    const isTurn = Number(m.turnSeat)===Number(s.seat);
    const sc=Number(m.state?.score?.[s.seat]||0);
    const closedAll = ["20","19","18","17","16","15","B"].every(k=>Number(m.state?.marks?.[s.seat]?.[k]||0)>=3);
    return `
      <div class="playerRow">
        <div class="left">
          <span class="dot ${online?"on":""}"></span>
          <div class="pmeta">
            <div class="pname">${s.name} ${isTurn?'<span class="chip">turn</span>':""} ${winner===s.seat?'<span class="chip">winner</span>':""}</div>
            <div class="pemail">${s.email}</div>
          </div>
        </div>
        <div class="row">
          <span class="chip">Score: ${sc}</span>
          <span class="chip">${closedAll?"closed":"open"}</span>
        </div>
      </div>
    `;
  }).join("");

  const keys=["20","19","18","17","16","15","B"];
  const marksTable = `
    <table class="table">
      <thead><tr><th>Number</th>${seats.map(s=>`<th>${s.name}</th>`).join("")}</tr></thead>
      <tbody>
        ${keys.map(k=>`
          <tr>
            <td>${k==="B"?"Bull":k}</td>
            ${seats.map(s=>{
              const v=Number(m.state?.marks?.[s.seat]?.[k]||0);
              const show = v>=3 ? ("âœ” "+v) : String(v);
              return `<td>${show}</td>`;
            }).join("")}
          </tr>
        `).join("")}
      </tbody>
    </table>
  `;

  setHtml(`
    ${headerBanner("Cricket")}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">${m.title||"Cricket"}</h3>
          <div class="row">
            <button class="btn sm" id="btnBack">Back</button>
          </div>
        </div>
        <div class="sub">v506: Enter marks-per-turn (0â€“3 each). Scoring is simplified for this first full run.</div>
        <div style="height:12px"></div>

        ${winner?`<div class="ok"><b>Winner:</b> ${seats.find(s=>s.seat===winner)?.name||winner}</div><div style="height:10px"></div>`:""}

        <div class="grid">
          <div class="panel">
            <h3 class="h2">Players</h3>
            <div style="height:10px"></div>
            ${scoreRows}
          </div>
          <div class="panel">
            <h3 class="h2">Board</h3>
            <div style="height:10px"></div>
            ${marksTable}
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="grid">
          <div class="panel">
            <h3 class="h2">Your turn controls</h3>
            ${myTurn?`
              <div class="sub">Enter marks for this turn (0â€“3 each).</div>
              <div style="height:10px"></div>
              ${keys.map(k=>`
                <div class="row" style="justify-content:space-between;margin-bottom:8px">
                  <div class="chip">${k==="B"?"Bull":k}</div>
                  <input class="input" style="width:120px" type="number" min="0" max="3" value="0" id="mk_${k}"/>
                </div>
              `).join("")}
              <button class="btn green pulse" id="btnSubmit">Submit turn</button>
            `:`
              <div class="lock">Not your turn. Waiting for <b>${m.turnEmail||"other player"}</b>.</div>
            `}
          </div>
          <div class="panel">
            <h3 class="h2">Match log</h3>
            <div class="sub">Latest first</div>
            <div style="height:10px"></div>
            <div id="log"></div>
          </div>
        </div>

      </div>
    </div>
    ${footer()}
  `);

  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");

  if(!seatMe){
    openModal("Join match", `
      <div class="sub">Pick a seat.</div>
      <div style="height:10px"></div>
      ${seats.map(s=>`
        <button class="btn" data-seat="${s.seat}">Seat ${s.seat}: ${s.email?`${s.name}`:"(open)"}</button>
      `).join('<div style="height:8px"></div>')}
    `, `<button class="btn sm" id="mClose">Close</button>`);
    $("#mClose").onclick=closeModal;
    $("#modal").querySelectorAll("button[data-seat]").forEach(b=>{
      b.onclick=async ()=>{
        const seat=Number(b.getAttribute("data-seat"));
        try{ await claimSeat(App.matchId, seat); closeModal(); }
        catch(e){ alert(e?.message||e); }
      };
    });
  }

  const btn=$("#btnSubmit");
  if(btn){
    btn.onclick=async ()=>{
      const payload={};
      keys.forEach(k=> payload[k]=Number($("#mk_"+k).value||0));
      try{ await submitCricket(App.matchId, payload); }
      catch(e){ alert(e?.message||e); }
    };
  }

  const logHost=$("#log");
  const log=(m.log||[]).slice(0,20);
  logHost.innerHTML = log.length? log.map(x=>`
    <div class="sub">â€¢ ${new Date(x.t).toLocaleTimeString()} â€” ${x.name} (${x.game}) marks:${x.totalMarks}, +${x.gained} pts</div>
  `).join("") : `<div class="sub">No turns yet.</div>`;
}

function screenGame01(){
  const m=App.match;
  if(!m){ go("player"); return; }

  const seats=m.seats||[];
  const seatMe=mySeat(m);
  const myTurn=isMyTurn(m);
  const winner=m.state?.winnerSeat || null;

  const rows=seats.map(s=>{
    const online=isOnline(s.email);
    const isTurn = Number(m.turnSeat)===Number(s.seat);
    const left=Number(m.state?.leftBySeat?.[s.seat]||0);
    return `
      <div class="playerRow">
        <div class="left">
          <span class="dot ${online?"on":""}"></span>
          <div class="pmeta">
            <div class="pname">${s.name} ${isTurn?'<span class="chip">turn</span>':""} ${winner===s.seat?'<span class="chip">winner</span>':""}</div>
            <div class="pemail">${s.email}</div>
          </div>
        </div>
        <div class="row">
          <span class="chip">Left: ${left}</span>
        </div>
      </div>
    `;
  }).join("");

  setHtml(`
    ${headerBanner("01")}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">${m.title||"01"}</h3>
          <div class="row">
            <button class="btn sm" id="btnBack">Back</button>
          </div>
        </div>
        <div class="sub">v506: per-turn points entry (0â€“180). Exact 0 wins. Enforcement of double-in/out comes next pass.</div>
        <div style="height:12px"></div>

        ${winner?`<div class="ok"><b>Winner:</b> ${seats.find(s=>s.seat===winner)?.name||winner}</div><div style="height:10px"></div>`:""}

        <div class="grid">
          <div class="panel">
            <h3 class="h2">Players</h3>
            <div style="height:10px"></div>
            ${rows}
          </div>

          <div class="panel">
            <h3 class="h2">Your turn controls</h3>
            ${myTurn?`
              <div class="sub">Enter points scored this turn (0â€“180).</div>
              <div style="height:10px"></div>
              <input id="pts" class="input" type="number" min="0" max="180" value="60"/>
              <div style="height:10px"></div>
              <button class="btn green pulse" id="btnSubmit">Submit turn</button>
            `:`
              <div class="lock">Not your turn. Waiting for <b>${m.turnEmail||"other player"}</b>.</div>
            `}
            <div style="height:10px"></div>
            <div class="sub">Settings: ${m.settings?.base||501} â€¢ ${m.settings?.inMode||"straight"}-in / ${m.settings?.outMode||"double"}-out</div>
          </div>
        </div>

        <div style="height:12px"></div>
        <div class="panel">
          <h3 class="h2">Match log</h3>
          <div class="sub">Latest first</div>
          <div style="height:10px"></div>
          <div id="log"></div>
        </div>

      </div>
    </div>
    ${footer()}
  `);

  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");

  if(!seatMe){
    openModal("Join match", `
      <div class="sub">Pick a seat.</div>
      <div style="height:10px"></div>
      ${seats.map(s=>`
        <button class="btn" data-seat="${s.seat}">Seat ${s.seat}: ${s.email?`${s.name}`:"(open)"}</button>
      `).join('<div style="height:8px"></div>')}
    `, `<button class="btn sm" id="mClose">Close</button>`);
    $("#mClose").onclick=closeModal;
    $("#modal").querySelectorAll("button[data-seat]").forEach(b=>{
      b.onclick=async ()=>{
        const seat=Number(b.getAttribute("data-seat"));
        try{ await claimSeat(App.matchId, seat); closeModal(); }
        catch(e){ alert(e?.message||e); }
      };
    });
  }

  const btn=$("#btnSubmit");
  if(btn){
    btn.onclick=async ()=>{
      const pts=Number($("#pts").value||0);
      try{ await submit01(App.matchId, pts); }
      catch(e){ alert(e?.message||e); }
    };
  }

  const logHost=$("#log");
  const log=(m.log||[]).slice(0,25);
  logHost.innerHTML = log.length? log.map(x=>`
    <div class="sub">â€¢ ${new Date(x.t).toLocaleTimeString()} â€” ${x.name}: ${x.pts} (left ${x.leftBefore} â†’ ${x.leftAfter})</div>
  `).join("") : `<div class="sub">No turns yet.</div>`;
}

function screenGamePlaceholder(){
  const gameId=App.params.gameId;
  const g=GAMES.find(x=>x.id===gameId) || {id:gameId,name:gameId};
  setHtml(`
    ${headerBanner(g.name)}
    <div class="main">
      ${topbar()}
      <div style="height:12px"></div>

      <div class="panel">
        <div class="row space">
          <h3 class="h2" style="margin:0">${g.name}</h3>
          <button class="btn sm" id="btnBack">Back</button>
        </div>
        <div style="height:10px"></div>
        <div class="ok">This game screen is included so the build is complete start-to-finish. We wire full rules after Cricket + 01.</div>
      </div>
    </div>
    ${footer()}
  `);

  $("#btnSpeaker").onclick=()=>{ setSound(!soundOn()); render(); };
  $("#btnPlayers").onclick=()=>go("players");
  $("#btnSignOut").onclick=()=>signOut();
  $("#btnBack").onclick=()=>go("player");
}

/* ============================
   Render router
   ============================ */
function render(){
  if(App.screen==="auth") return screenAuth();
  if(App.screen==="player") return screenPlayer();
  if(App.screen==="players") return screenPlayers();
  if(App.screen==="game_setup") return screenGameSetup();
  if(App.screen==="history") return screenHistory();
  if(App.screen==="stats") return screenStats();

  if(App.screen.startsWith("game_")){
    const id=App.screen.replace("game_","");
    if(id==="cricket") return screenGameCricket();
    if(id==="01") return screenGame01();
    return screenGamePlaceholder();
  }

  screenAuth();
}

/* ============================
   Boot
   ============================ */
(async function boot(){
  render();

  // Always start on landing/email gate. Prefill saved email only.
  const remembered=store.get("me", null);
  if(remembered?.email && App.screen==="auth"){
    const inEl=document.getElementById("inEmail");
    if(inEl) inEl.value = remembered.email;
  }

  // Try the diagonal sweep once on landing (may be blocked until user gesture).
  // If blocked, it will run on the first click.
  setTimeout(()=>runSweepOnce(), 350);
})();
// small refresh to keep match list fresh while on player screen
setInterval(()=>{
  if(App.screen==="player") renderMatchesList();
}, 2000);

</script>
</body>
</html>
