<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Night Games • v484</title>

<!-- Firebase compat (single-file web) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --bg0:#05070a; --bg1:#070a10;
  --panel:rgba(10,12,16,.78);
  --stroke:rgba(120,180,255,.18);
  --text:#e9f2ff; --muted:rgba(233,242,255,.72);
  --cyan:#00d7ff; --blue:#2a7fff;
  --green:#2ee66b; --danger:#ff4d4d;
  --shadow:0 18px 42px rgba(0,0,0,.55);
  --r:18px;
}
html,body{height:100%;margin:0;color:var(--text);
  background:
    radial-gradient(120% 120% at 20% 10%, rgba(0,180,255,.14), rgba(0,0,0,0) 55%),
    radial-gradient(120% 120% at 80% 80%, rgba(42,127,255,.10), rgba(0,0,0,0) 55%),
    linear-gradient(180deg,var(--bg1),var(--bg0));
  font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
}
.wrap{min-height:100%;display:flex;align-items:center;justify-content:center;padding:18px;}
.card{width:min(720px,100%);background:var(--panel);border:1px solid var(--stroke);
  border-radius:var(--r);box-shadow:var(--shadow);backdrop-filter:blur(10px);padding:16px;
}
.row{display:flex;gap:10px;align-items:center;} .row.space{justify-content:space-between;}
.col{display:flex;flex-direction:column;gap:10px;}
.h1{font-size:22px;font-weight:900;letter-spacing:.2px;}
.h2{font-size:16px;font-weight:900;opacity:.95;}
.sub{color:var(--muted);font-size:13px;line-height:1.35;}
hr{border:none;border-top:1px solid rgba(120,180,255,.14);margin:12px 0;}

.input{width:100%;box-sizing:border-box;padding:12px;border-radius:14px;
  border:1px solid rgba(120,180,255,.22);background:rgba(0,0,0,.35);color:var(--text);outline:none;
}
.input:focus{border-color:rgba(0,215,255,.55);box-shadow:0 0 0 3px rgba(0,215,255,.12);}

.btn{width:100%;padding:12px;border-radius:14px;border:1px solid rgba(120,180,255,.18);
  background:rgba(0,0,0,.28);color:var(--text);font-weight:900;letter-spacing:.2px;cursor:pointer;
}
.btn:hover{border-color:rgba(0,215,255,.45);box-shadow:0 10px 26px rgba(0,0,0,.35);}
.btn.green{background:rgba(46,230,107,.14);border-color:rgba(46,230,107,.45);}
.btn.sm{width:auto;padding:8px 10px;border-radius:12px;font-size:12px;}
.btn.danger{background:rgba(255,77,77,.12);border-color:rgba(255,77,77,.40);}
.btn[disabled]{opacity:.55;pointer-events:none;}

.hero{border-radius:18px;overflow:hidden;border:1px solid rgba(120,180,255,.18);
  background:radial-gradient(120% 120% at 20% 20%, rgba(0,180,255,.18), rgba(0,0,0,0) 55%),
            linear-gradient(180deg, rgba(10,12,16,.92), rgba(0,0,0,.92));
  box-shadow:0 10px 30px rgba(0,0,0,.55);margin-bottom:12px;
}
.heroInner{padding:16px;}
.hero img{display:block;width:100%;height:190px;object-fit:contain;
  filter:drop-shadow(0 12px 24px rgba(0,160,255,.35));
}

.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
@media (max-width:720px){.grid2{grid-template-columns:1fr;}}

.pillRow{display:flex;flex-wrap:wrap;gap:8px;}
.pill{padding:8px 10px;border-radius:999px;border:1px solid rgba(120,180,255,.18);
  background:rgba(0,0,0,.25);cursor:pointer;font-weight:900;font-size:12px;
}
.pill.on{border-color:rgba(0,215,255,.55);box-shadow:0 0 0 3px rgba(0,215,255,.10);}

#badge{position:fixed;right:10px;bottom:10px;z-index:999999;padding:6px 10px;border-radius:12px;
  background:rgba(0,0,0,.55);border:1px solid rgba(120,180,255,.25);color:#bfe7ff;font:12px/1.1 system-ui;
  pointer-events:none;box-shadow:0 10px 24px rgba(0,0,0,.45);
}

/* Sweep overlay (one-shot, on top) */
#sweepOverlay{position:fixed;inset:0;z-index:999999;pointer-events:none;display:none;}
#sweepOverlay.show{display:block;}
#sweepVideo{position:absolute;inset:-25% -35%;width:170%;height:170%;object-fit:cover;
  transform:translateX(-120%) translateY(18%) rotate(-18deg);opacity:0;mix-blend-mode:screen;
  filter:brightness(1.05) contrast(1.05) saturate(1.1);
}
#sweepOverlay.run #sweepVideo{opacity:.95;animation:sweepOnce 1.65s ease-out forwards;}
@keyframes sweepOnce{
  0%{transform:translateX(-120%) translateY(18%) rotate(-18deg);opacity:0;}
  10%{opacity:.95;}
  85%{opacity:.95;}
  100%{transform:translateX(120%) translateY(-18%) rotate(-18deg);opacity:0;}
}
</style>
</head>
<body>
<div id="sweepOverlay">
  <video id="sweepVideo" muted playsinline preload="auto">
    <source src="0217.mp4" type="video/mp4"/>
  </video>
</div>

<div class="wrap"><div id="app" class="card"></div></div>
<div id="badge">v484</div>

<script>
const BUILD=484;

// Repo assets (must exist beside index.html)
const LOGO="9238EAD8-8D2B-4820-9620-1692FA1DC3D4.png";

const firebaseConfig = {"apiKey": "AIzaSyC0sdB54z0G73P3epW6GmHqYvESFcqgTo", "authDomain": "gamenightdarts-e7601.firebaseapp.com", "projectId": "gamenightdarts-e7601", "storageBucket": "gamenightdarts-e7601.firebasestorage.app", "messagingSenderId": "270045452251", "appId": "1:270045452251:web:5a4a661140a60780e939fe", "measurementId": "G-M60TDFYBW0"};

const $=(s,r=document)=>r.querySelector(s);
const store={
  get(k,f=null){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f;}catch{return f;}},
  set(k,v){localStorage.setItem(k,JSON.stringify(v));},
  del(k){localStorage.removeItem(k);}
};

let fb={app:null,auth:null,db:null};
function initFirebase(){
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  fb.app=firebase.app(); fb.auth=firebase.auth(); fb.db=firebase.firestore();
}
async function ensureBackendAuth(){
  if(fb.auth.currentUser) return fb.auth.currentUser;
  const cred=await fb.auth.signInAnonymously();
  return cred.user;
}

function normEmail(e){return String(e||"").trim().toLowerCase();}
function normName(n,email){const v=String(n||"").trim(); return v?v:normEmail(email);}

const GAMES=[
  {id:"shanghai", name:"Shanghai"},
  {id:"killer", name:"Killer"},
  {id:"around", name:"Around the World"},
  {id:"cricket", name:"Cricket"},
  {id:"01", name:"01"}
];

const App={
  screen:"auth",
  me:null,
  players:[],
  params:{},
};

function setHtml(h){$("#app").innerHTML=h;}
function go(screen,params={}){App.screen=screen; App.params=params; render();}

async function loadPlayers(){
  const snap=await fb.db.collection("players").get();
  App.players=snap.docs.map(d=>d.data()).filter(Boolean).map(p=>({
    email:normEmail(p.email),
    name:normName(p.name,p.email),
  }));
}
async function upsertPlayer(email,name){
  email=normEmail(email); name=normName(name,email);
  await fb.db.collection("players").doc(email).set({
    email,name, updatedAt: firebase.firestore.FieldValue.serverTimestamp()
  },{merge:true});
}

function runSweepOnce(){
  const key="sweepShown_v484";
  if(store.get(key,false)) return;
  store.set(key,true);
  const ov=$("#sweepOverlay"); const v=$("#sweepVideo");
  if(!ov||!v) return;
  ov.classList.add("show"); ov.classList.add("run");
  try{v.currentTime=0; v.play().catch(()=>{});}catch{}
  const done=()=>{ov.classList.remove("run"); ov.classList.remove("show");};
  v.addEventListener("ended",done,{once:true});
  setTimeout(done,2200);
}

function renderAuth(){
  const saved=store.get("me",null);
  setHtml(`
    <div class="hero"><div class="heroInner"><img src="${LOGO}" alt="Night Games"/></div></div>
    <div class="h1">Night Games</div>
    <div class="sub">Simple email identity. If you're new, enter your name once.</div>
    <div style="height:12px"></div>
    <div class="grid2">
      <div>
        <div class="sub">Email</div>
        <input id="inEmail" class="input" placeholder="you@example.com" value="${(saved?.email||"").replaceAll('"','&quot;')}"/>
      </div>
      <div>
        <div class="sub">Name (new players only)</div>
        <input id="inName" class="input" placeholder="Your name" value="${(saved?.name||"").replaceAll('"','&quot;')}"/>
      </div>
    </div>
    <div style="height:12px"></div>
    <button id="btnStart" class="btn green">Start</button>
  `);
  const start=()=>onStart();
  $("#btnStart").onclick=start;
  $("#inEmail").addEventListener("keydown",(e)=>{if(e.key==="Enter") start();});
  $("#inName").addEventListener("keydown",(e)=>{if(e.key==="Enter") start();});
}

async function onStart(){
  const email=normEmail($("#inEmail")?.value);
  const nameIn=normName($("#inName")?.value,email);
  if(!email||!email.includes("@")){ alert("Enter a valid email."); return; }

  initFirebase();
  await ensureBackendAuth();
  await loadPlayers();

  const existing=App.players.find(p=>p.email===email);
  if(existing){
    App.me={email,name:existing.name};
    store.set("me",App.me);
  } else {
    if(!nameIn || nameIn===email){ alert("New player — please enter your name once."); return; }
    App.me={email,name:nameIn};
    store.set("me",App.me);
    await upsertPlayer(email,nameIn);
    await loadPlayers();
  }
  runSweepOnce();
  go("home");
}

function renderHome(){
  const me=App.me;
  const gameBtns=GAMES.map(g=>`<button class="btn" data-game="${g.id}">${g.name}</button>`).join("");
  setHtml(`
    <div class="row space">
      <div>
        <div class="h1">Home</div>
        <div class="sub">Signed in as <b>${me.name}</b></div>
      </div>
      <button id="btnSignOut" class="btn sm">Sign out</button>
    </div>
    <hr/>
    <div class="h2">Games</div>
    <div class="sub">Prototype: setup screens first. Engines next.</div>
    <div style="height:10px"></div>
    <div class="col" id="games">${gameBtns}</div>
  `);
  $("#btnSignOut").onclick=()=>{store.del("me"); App.me=null; go("auth");};
  $("#games").onclick=(e)=>{
    const b=e.target.closest("button[data-game]"); if(!b) return;
    const id=b.getAttribute("data-game");
    if(id==="cricket") return go("setup_cricket");
    if(id==="01") return go("setup_01");
    alert("Setup coming next for: "+id);
  };
}

function pillGroup(id, options, selected){
  return `
    <div class="pillRow" data-group="${id}">
      ${
        options.map(o=>`<div class="pill ${selected===o.value?"on":""}" data-value="${o.value}">${o.label}</div>`).join("")
      }
    </div>
  `;
}

function renderSetupCricket(){
  setHtml(`
    <div class="row space">
      <div>
        <div class="h1">Cricket Setup</div>
        <div class="sub">Solo • vs • Teams (prototype)</div>
      </div>
      <button class="btn sm" id="btnBack">Back</button>
    </div>
    <hr/>

    <div class="h2">Mode</div>
    ${
      pillGroup("mode",[
        {label:"Solo", value:"solo"},
        {label:"Vs", value:"vs"},
        {label:"Teams", value:"teams"},
      ], "vs")
    }

    <div style="height:10px"></div>
    <div class="h2">Who starts?</div>
    ${
      pillGroup("starter",[
        {label:"Random", value:"random"},
        {label:"Manual", value:"manual"},
      ], "random")
    }

    <div style="height:10px"></div>
    <div class="h2">Players / Teams</div>
    <div class="grid2">
      <div>
        <div class="sub">Side A (name or team)</div>
        <input id="a1" class="input" placeholder="Steve / Team A"/>
        <div style="height:8px"></div>
        <input id="a2" class="input" placeholder="(optional teammate)"/>
      </div>
      <div>
        <div class="sub">Side B (name or team)</div>
        <input id="b1" class="input" placeholder="Bill / Team B"/>
        <div style="height:8px"></div>
        <input id="b2" class="input" placeholder="(optional teammate)"/>
      </div>
    </div>

    <div style="height:12px"></div>
    <button class="btn green" id="btnCreate">Create Match</button>
    <div class="sub" style="margin-top:8px;">Next: cricket scoring entry (3 darts + enter) + stats logging.</div>
  `);

  $("#btnBack").onclick=()=>go("home");

  // simple pill toggles
  document.querySelectorAll(".pillRow").forEach(row=>{
    row.addEventListener("click",(e)=>{
      const p=e.target.closest(".pill"); if(!p) return;
      row.querySelectorAll(".pill").forEach(x=>x.classList.remove("on"));
      p.classList.add("on");
    });
  });

  $("#btnCreate").onclick=()=>{
    const mode = document.querySelector('[data-group="mode"] .pill.on')?.dataset.value || "vs";
    const starter = document.querySelector('[data-group="starter"] .pill.on')?.dataset.value || "random";
    const payload = {
      game:"cricket",
      mode, starter,
      sides: {
        A: [$("#a1").value, $("#a2").value].filter(Boolean),
        B: [$("#b1").value, $("#b2").value].filter(Boolean),
      }
    };
    store.set("lastMatch", payload);
    alert("Cricket match created (prototype). Next step: scoring engine.");
  };
}

function renderSetup01(){
  setHtml(`
    <div class="row space">
      <div>
        <div class="h1">01 Setup</div>
        <div class="sub">301 / 501 / 701 • Double-in option • Double-out</div>
      </div>
      <button class="btn sm" id="btnBack">Back</button>
    </div>
    <hr/>

    <div class="h2">Game</div>
    ${
      pillGroup("start",[
        {label:"301", value:"301"},
        {label:"501", value:"501"},
        {label:"701", value:"701"},
      ], "501")
    }

    <div style="height:10px"></div>
    <div class="h2">In / Out</div>
    ${
      pillGroup("inout",[
        {label:"Straight-in • Double-out", value:"straight_double"},
        {label:"Double-in • Double-out", value:"double_double"},
      ], "straight_double")
    }

    <div style="height:10px"></div>
    <div class="h2">Mode</div>
    ${
      pillGroup("mode",[
        {label:"Solo", value:"solo"},
        {label:"Vs", value:"vs"},
        {label:"Teams", value:"teams"},
      ], "vs")
    }

    <div style="height:10px"></div>
    <div class="h2">Who starts?</div>
    ${
      pillGroup("starter",[
        {label:"Random", value:"random"},
        {label:"Manual", value:"manual"},
      ], "random")
    }

    <div style="height:10px"></div>
    <div class="h2">Players / Teams</div>
    <div class="grid2">
      <div>
        <div class="sub">Side A</div>
        <input id="a1" class="input" placeholder="Steve / Team A"/>
        <div style="height:8px"></div>
        <input id="a2" class="input" placeholder="(optional teammate)"/>
      </div>
      <div>
        <div class="sub">Side B</div>
        <input id="b1" class="input" placeholder="Bill / Team B"/>
        <div style="height:8px"></div>
        <input id="b2" class="input" placeholder="(optional teammate)"/>
      </div>
    </div>

    <div style="height:12px"></div>
    <button class="btn green" id="btnCreate">Create Match</button>
    <div class="sub" style="margin-top:8px;">Next: scoring keypad + turn engine + checkout tracking.</div>
  `);

  $("#btnBack").onclick=()=>go("home");

  document.querySelectorAll(".pillRow").forEach(row=>{
    row.addEventListener("click",(e)=>{
      const p=e.target.closest(".pill"); if(!p) return;
      row.querySelectorAll(".pill").forEach(x=>x.classList.remove("on"));
      p.classList.add("on");
    });
  });

  $("#btnCreate").onclick=()=>{
    const start = document.querySelector('[data-group="start"] .pill.on')?.dataset.value || "501";
    const inout = document.querySelector('[data-group="inout"] .pill.on')?.dataset.value || "straight_double";
    const mode = document.querySelector('[data-group="mode"] .pill.on')?.dataset.value || "vs";
    const starter = document.querySelector('[data-group="starter"] .pill.on')?.dataset.value || "random";
    const payload = {
      game:"01",
      start, inout, mode, starter,
      sides: {
        A: [$("#a1").value, $("#a2").value].filter(Boolean),
        B: [$("#b1").value, $("#b2").value].filter(Boolean),
      }
    };
    store.set("lastMatch", payload);
    alert("01 match created (prototype). Next step: scoring engine.");
  };
}

function render(){
  if(!App.me && App.screen!=="auth") App.screen="auth";
  if(App.screen==="auth") return renderAuth();
  if(App.screen==="home") return renderHome();
  if(App.screen==="setup_cricket") return renderSetupCricket();
  if(App.screen==="setup_01") return renderSetup01();
  return renderAuth();
}

(function boot(){
  // If identity cached, don't auto-enter; user can press Start.
  render();
})();
</script>
</body>
</html>
