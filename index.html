<!--
================================================================================
  NIGHT GAMES v749  |  2026-02-25
================================================================================
  MASTER CLEAN BUILD (STABILITY FIRST)
  - Enter must work (email -> players) and must never regress.
  - Game -> Setup must open.
  - Setup Start must work (1 player + 2+ players).

  THIS BUILD CHANGES:
  - NO behavior changes intended.
  - Labels / section banners / edit notes only.
  - Visible version badge added.

  QUICK JUMP (Ctrl/Cmd+F):
    [EDIT_BG] [EDIT_LOGO] [EDIT_VERSION] [EDIT_COLORS] [EDIT_DROPDOWNS]
    [SECTION_CONFIG] [SECTION_FIREBASE] [SECTION_STATE] [SECTION_ROUTING]
    [SECTION_UI] [SECTION_PLAYERS] [SECTION_GAMES] [SECTION_SETUP]
    [SECTION_WAITING] [SECTION_INVITES] [SECTION_UTILS] [SECTION_DEBUG]
================================================================================
-->

<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Night Games v749 (MASTER STABLE)</title>
  <style>
/* =============================================================================
   SECTION: VISUAL THEME  [EDIT_COLORS]
   - Keep theme styles grouped here.
============================================================================= */
:root{
      --bgStage: url("./IMG_7315.jpeg");
      --maxW: 760px;
      --uiW: min(var(--maxW), calc(100vw - 24px));
      --txt: rgba(245,250,255,.94);
      --fieldFill: rgba(255,255,255,.035);
      --zShadow: drop-shadow(0 22px 46px rgba(0,0,0,.72));
      --zShadowSoft: drop-shadow(0 10px 22px rgba(0,0,0,.55));
    }

    html, body{
      height:100%;
      margin:0;
      background:#000;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow:hidden;
      -webkit-text-size-adjust: 100%;
    }

    .buildBadge{
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      font-weight: 1000;
      letter-spacing: 1px;
      font-size: 13px;
      text-transform: uppercase;
      pointer-events: none;
      box-shadow: 0 10px 22px rgba(0,0,0,.55);
    }
    .buildBadge b{ color: rgba(0,210,255,.95); }

    /* Debug panel (toggle) */
    .dbg{ display:none; }
    .dbgHead{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dbgHead span{
      font-size: 13px;
      font-weight: 1000;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: .92;
    }
    .dbgHead b{ color: rgba(90,255,170,.92); }
    .dbgBody{
      display:none;
      padding: 10px 12px 12px 12px;
      font-size: 13px;
      line-height: 1.4;
      opacity: .9;
    }
    .dbg.open .dbgBody{ display:block; }
    .kv{ display:flex; justify-content: space-between; gap:10px; }
    .kv code{ opacity:.95; }
    .warn{ color: rgba(255,210,90,.95); }
    .bad{ color: rgba(255,120,120,.95); }
    .ok{ color: rgba(90,255,170,.95); }

    #app{
  padding-top: 72px; /* keep UI clear of header */ position:fixed; inset:0; }
    .screen{ position:absolute; inset:0; display:none; }
    .screen.active{ display:block; }

    .screen::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--bgStage);
      background-repeat:no-repeat;
      background-size:cover;
      background-position: center bottom;
    }
    .screen::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(130% 110% at 50% 25%, rgba(0,0,0,0), rgba(0,0,0,.22) 60%, rgba(0,0,0,.52) 100%);
      pointer-events:none;
    }

    /* ===== Landing ===== */
    .landingUI{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(320px, 48vh, 590px);
      display:grid;
      gap: 14px;
      justify-items:center;
      z-index:2;
    }

    .field3d, .btn3d{
      width: min(640px, 92vw);
      height: 72px;
      border-radius: 22px;
      transform: translateZ(0);
      filter: var(--zShadow);
      background: var(--fieldFill);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.45),
        inset 0 -14px 22px rgba(0,0,0,.60),
        0 0 18px rgba(0,210,255,.10);
      position:relative;
      overflow:hidden;
    }
    .field3d::before, .btn3d::before{
      content:"";
      position:absolute;
      inset: 10px 12px auto 12px;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,.52), rgba(255,255,255,0));
      opacity: .42;
      pointer-events:none;
    }
    .field3d input{
      width:100%;
      height:100%;
      border:0;
      outline:none;
      background:transparent;
      color: rgba(255,255,255,.95);
      font-size: 18px;
      letter-spacing: .6px;
      padding: 0 20px;
      box-sizing:border-box;
      -webkit-appearance:none;
      appearance:none;
    }
    .field3d input::placeholder{ color: rgba(235,245,255,.55); }

    /* iOS Safari yellow autofill kill */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-text-fill-color: rgba(255,255,255,.95) !important;
      caret-color: rgba(255,255,255,.95);
      transition: background-color 99999s ease-out 0s;
      -webkit-box-shadow: 0 0 0px 1000px var(--fieldFill) inset !important;
      box-shadow: 0 0 0px 1000px var(--fieldFill) inset !important;
      border-radius: 22px;
    }

    .btn3d{
      cursor:pointer;
      color: rgba(255,255,255,.96);
      font-weight: 1000;
      font-size: 28px;
      letter-spacing: 2px;
      text-transform: uppercase;
      transition: transform .07s ease, filter .07s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn3d:active{ transform: translateY(2px) scale(.995); filter: var(--zShadowSoft); }

    .hint{
      font-size: 13px;
      opacity: .78;
      text-align:center;
      max-width: min(640px, 92vw);
      line-height: 1.35;
    }

    /* ===== Hub ===== */
    .hub{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(220px, 30vh, 340px);
      bottom: max(120px, env(safe-area-inset-bottom));
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: 18px;
      padding: 0 12px;
      box-sizing:border-box;
      z-index:2;
    }

    .panel{
      position:relative;
      border-radius: 22px;
      background: rgba(255,255,255,.03);
      border: none;
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.38),
        inset 0 -14px 22px rgba(0,0,0,.62),
        0 0 18px rgba(0,210,255,.10);
      overflow:hidden;
      filter: var(--zShadowSoft);
    }

    .sectionHead{ padding: 12px 14px 10px 14px; }

    .title{
      font-weight: 1000;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-size: clamp(22px, 3.0vh, 30px);
      position: relative;
      padding-bottom: 6px;
      width: 100%;
      background: linear-gradient(180deg,
        rgba(210,245,255,.96) 0%,
        rgba(90,210,255,.92) 35%,
        rgba(235,250,255,.98) 70%,
        rgba(120,225,255,.88) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-stroke: 0.7px rgba(255,255,255,.18);
      text-shadow:
        0 1px 0 rgba(255,255,255,.22),
        0 -2px 10px rgba(0,0,0,.70),
        0 0 22px rgba(0,210,255,.18);
    }
    .title::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:2px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(0,210,255,.55), rgba(255,175,0,.40), rgba(0,210,255,.10));
      opacity:.75;
    }

    .list{
      position:absolute;
      left: 0; right: 0;
      top: 54px; bottom: 0;
      padding: 10px 12px 14px 12px;
      box-sizing: border-box;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .itemLine{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 4px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .leftStack{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .glassText{
      font-weight: 1000;
      font-size: clamp(22px, 2.8vh, 30px);
      letter-spacing: .6px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(210,245,255,.78) 40%, rgba(255,255,255,.92));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-stroke: 0.6px rgba(255,255,255,.22);
      text-shadow:
        0 1px 0 rgba(255,255,255,.35),
        0 -2px 10px rgba(0,0,0,.70),
        0 0 14px rgba(0,210,255,.10);
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .dot.online{
      background: rgba(60, 255, 160, .98);
      box-shadow: 0 0 18px rgba(60,255,160,.75), 0 0 38px rgba(60,255,160,.30), 0 0 0 1px rgba(60,255,160,.45);
      animation: onlinePulse 1.35s ease-in-out infinite;
    }
    @keyframes onlinePulse{
      0%{ transform: scale(1); filter: brightness(1.0); }
      50%{ transform: scale(1.15); filter: brightness(1.25); }
      100%{ transform: scale(1); filter: brightness(1.0); }
    }

    .actions{ display:flex; gap:8px; flex:0 0 auto; }

    .pill{
      /* v748 uniform button sizing */
border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.95);
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 1000;
      letter-spacing: .8px;
      text-transform: uppercase;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.28),
        inset 0 -10px 16px rgba(0,0,0,.55),
        0 0 16px rgba(0,210,255,.08);
      transition: transform .07s ease, filter .07s ease;
    }

    /* [EDIT_BUTTONS] Advancement buttons = green glass "lit" */
    .btnAdvance{
      border: 1px solid rgba(120,255,170,.42) !important;
      background: linear-gradient(180deg, rgba(70,255,150,.18), rgba(255,255,255,.06)) !important;
      box-shadow: 0 0 0 1px rgba(70,255,150,.12) inset, 0 10px 22px rgba(0,0,0,.45);
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.55));
    }
    .btnAdvance:active{
      transform: translateY(1px) scale(.99);
      box-shadow: 0 0 0 1px rgba(70,255,150,.14) inset, 0 6px 14px rgba(0,0,0,.55);
    }

    .pill:active{
      transform: translateY(2px) scale(.99);
      filter: var(--zShadowSoft);
    }

    .detailWrap{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(220px, 30vh, 340px);
      bottom: max(120px, env(safe-area-inset-bottom));
      z-index: 2;
      display:grid;
      grid-template-rows: 1fr auto;
      gap: 18px;
      padding: 0 12px;
      box-sizing:border-box;
    }
    .detailBody{
      padding: 14px 14px 18px 14px;
      line-height: 1.55;
      font-size: 18px;
      opacity: .92;
    }

    .fatal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.82);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 99999;
    }
    .fatal .card{
      width: min(720px, 92vw);
      border-radius: 22px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 46px rgba(0,0,0,.55);
      padding: 16px 16px 18px 16px;
    }
    .fatal h2{ margin:0 0 8px 0; font-size: 18px; letter-spacing:1px; text-transform: uppercase; }
    .fatal p{ margin:0 0 10px 0; opacity:.88; line-height:1.45; }
    .fatal pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 13px;
      opacity: .9;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 12px;
      border-radius: 14px;
    }
  
    /* v748: header row + mini pill */
    .headerRow{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
    .pillMini{
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 1px;
      height: 34px;
      align-self: center;
    }

  
    /* v748: session indicator */
    .sessionPill{
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 1px;
      height: 34px;
      align-self: center;
      opacity: .92;
    }
    .sessionPill.live{
      border-color: rgba(90,255,170,.55);
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.28),
        inset 0 -10px 16px rgba(0,0,0,.55),
        0 0 16px rgba(90,255,170,.12);
    }

  
    /* v748 layout lock: micro vertical drop */
    .appWrap, .screen, .landing, .players {
        transform: translateY(20px);
    }


    /* v748 layout lock adjustment: additional micro drop */
    .appWrap, .screen, .landing, .players {
        transform: translateY(20px);
    }


    /* v748 ATW emoji: keep color + one-line */
    .gameLabelWrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      white-space:nowrap;
    }
    .emojiGlobe{
      display:inline-block;
      font-size: 18px;
      line-height: 1;
      color: initial !important;
      background: none !important;
      -webkit-text-fill-color: initial !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      filter: drop-shadow(0 0 10px rgba(120,200,255,.18));
    }



    /* v748: Setup screen scroll/visibility fix for iPhone Safari (more vertical room) */
    #setup .detailWrap{
      top: clamp(150px, 18vh, 260px);
      bottom: max(80px, env(safe-area-inset-bottom));
    }
    /* Ensure list area can always finger-scroll */
    #setup .list{
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }



    /* v748: glass dropdowns (no white/yellow) */
    .glassSelect{
      width: 100%;
      padding: 14px 44px 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.96);
      font-weight: 1100;
      font-size: 20px;
      line-height: 1.1;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      box-shadow:
        inset 0 0 18px rgba(255,255,255,.06),
        0 0 18px rgba(255,255,255,.06);
      background-image:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='rgba(255,255,255,0.85)' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-size: auto, 20px 20px;
      background-position: 0 0, calc(100% - 14px) 50%;
    }
    .glassSelect:focus{
      border-color: rgba(255,255,255,.24);
      background: rgba(255,255,255,.08);
      box-shadow:
        0 0 0 2px rgba(255,255,255,.10),
        inset 0 0 20px rgba(255,255,255,.08),
        0 0 22px rgba(120,190,255,.10);
    }

    /* Keep iOS/Safari from forcing yellow/white fills on inputs */
    input, textarea, select{
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      caret-color: rgba(255,255,255,.95);
    }
    input:-webkit-autofill,
    textarea:-webkit-autofill,
    select:-webkit-autofill{
      -webkit-text-fill-color: rgba(255,255,255,.96) !important;
      transition: background-color 99999s ease-in-out 0s;
      box-shadow: 0 0 0 1000px rgba(255,255,255,.06) inset !important;
      border: 1px solid rgba(255,255,255,.16) !important;
    }



    /***********************
     *  v748 ERROR HUD
     *  - Appears only when an error occurs
     *  - Small, not in the way
     ***********************/
    #ngErrToast{
      position: fixed;
      right: 14px;
      bottom: max(14px, env(safe-area-inset-bottom));
      z-index: 99999;
      display: none;
      max-width: min(420px, calc(100vw - 28px));
    }
    #ngErrToast .card{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(20,20,24,.78);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 18px rgba(255,255,255,.06);
      overflow:hidden;
    }
    #ngErrToast .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    #ngErrToast .title{
      font-weight: 1200;
      font-size: 14px;
      letter-spacing: .2px;
      opacity: .95;
      display:flex;
      gap: 8px;
      align-items:center;
      white-space: nowrap;
    }
    #ngErrToast .dot{
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: rgba(255,80,80,.92);
      box-shadow: 0 0 14px rgba(255,80,80,.35);
      flex: 0 0 auto;
    }
    #ngErrToast .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 1100;
      font-size: 13px;
      line-height: 1;
    }
    #ngErrToast .btn:active{ transform: translateY(1px); opacity:.96; }
    #ngErrToast .body{
      padding: 10px 12px 12px;
      font-size: 13px;
      line-height: 1.35;
      opacity: .90;
    }
    #ngErrToast .msg{
      font-weight: 1000;
      font-size: 13px;
      margin-bottom: 8px;
      opacity: .96;
    }
    #ngErrToast .detail{
      display:none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      opacity: .90;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #ngErrToast.expanded .detail{ display:block; }


/* =============================================================================
   SECTION: EDITABLE COORDINATES  [EDIT_LOGO] [EDIT_BG] [EDIT_VERSION]
   - If you want to move the logo or tweak offsets, search for these tags.
============================================================================= */

/* =============================================================================
   SECTION_SETUP: PLAYER PICKER DROPDOWN  [SECTION_SETUP]
============================================================================= */
/* v748: player picker dropdown */
.glassBtn{
  width: 100%;
  padding: 14px 16px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.96);
  font-weight: 1100;
  font-size: 20px;
  line-height: 1.1;
  box-shadow: inset 0 0 18px rgba(255,255,255,.06), 0 0 18px rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
}
.glassBtn .sub{ opacity:.72; font-weight:900; font-size:16px; }
.glassBtn:active{ transform: translateY(1px); opacity:.96; }
.pickerModal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.58);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 99999;
  padding: 18px;
}
.pickerCard{
  width: min(520px, 100%);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(20,20,24,.72);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 0 30px rgba(0,0,0,.35), inset 0 0 24px rgba(255,255,255,.06);
  overflow:hidden;
}
.pickerHead{
  padding: 14px 16px;
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap: 12px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.pickerHead .t{ font-weight:1200; font-size:18px; }
.pickerHead .c{ opacity:.75; font-weight:900; font-size:14px; }
.pickerBody{
  max-height: 46vh;
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px 12px;
}
.pickerRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.04);
  margin-bottom: 10px;
}
.pickerRow .nm{ font-weight:1100; }
.pickerRow .em{ opacity:.65; font-size: 13px; font-weight:800; }
.pickerFoot{
  padding: 12px 12px;
  display:flex;
  gap: 10px;
  border-top: 1px solid rgba(255,255,255,.10);
}
.pickerFoot .pill{ flex:1; }

/* =============================================================================
   SECTION_UI: VERSION BADGE  [EDIT_VERSION]
============================================================================= */
#ngVersionBadge{
  position: fixed;
  left: 12px;
  top: max(10px, env(safe-area-inset-top));
  z-index: 99998;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(20,20,24,.58);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  font-weight: 1100;
  font-size: 13px;
  letter-spacing: .4px;
  opacity: .92;
}

/* =============================================================================
   SECTION_UI: FIELD LABELS (visual separation)  [EDIT_COLORS]
============================================================================= */
.fieldLabel{
  display:inline-block;
  padding: 8px 12px;
  border-radius: 14px;
  border: 1px solid rgba(120,190,255,.22);
  background: rgba(40,120,220,.14);
  color: rgba(225,245,255,.96);
  font-weight: 1100;
  letter-spacing: .4px;
  margin: 0 0 10px 0;
  box-shadow: inset 0 0 18px rgba(120,190,255,.08);
}

/* v748 ADVANCE BUTTONS + SETUP LAYOUT FIXES */
.pill.btnAdvance, .btnAdvance, .btn-advance{
  border: 1px solid rgba(120,255,170,.35) !important;
  background: linear-gradient(180deg, rgba(60,255,160,.22), rgba(20,120,70,.18)) !important;
  box-shadow: 0 0 18px rgba(70,255,160,.18), inset 0 0 18px rgba(60,255,160,.12) !important;
}
.pill.btnAdvance:active, .btnAdvance:active, .btn-advance:active{
  transform: translateY(1px) scale(0.99);
  box-shadow: 0 0 10px rgba(70,255,160,.16), inset 0 0 10px rgba(60,255,160,.10) !important;
}
/* Make "advance" buttons readable */
.pill.btnAdvance{ font-weight: 950; }

/* Prevent duplicated controls from stacking/overlapping inside setup body */
#setup .panel .detailBody{ position: relative; }


/* ===================== v749 HEADER BAR (ONE ROW, NO WRAP) ===================== */
#ngHeaderBar{
  position: fixed;
  top: max(10px, env(safe-area-inset-top));
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  width: min(760px, 94vw);
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.18);
  background: linear-gradient(180deg, rgba(12,28,56,.35), rgba(0,0,0,.22));
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 10px 28px rgba(0,0,0,.35);
  overflow: hidden;
}
#ngHeaderBar::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:16px;
  pointer-events:none;
  background: radial-gradient(120px 80px at 18% 0%, rgba(70,170,255,.28), transparent 70%),
              radial-gradient(140px 90px at 82% 0%, rgba(70,255,160,.22), transparent 72%),
              linear-gradient(90deg, rgba(70,170,255,.12), rgba(70,255,160,.10));
  mix-blend-mode: screen;
}
#ngHeaderBar > span{
  position: relative;
  z-index: 1;
  white-space: nowrap;
  font-size: 13px;
  letter-spacing: .2px;
}
.ngHeaderLeft{ font-weight: 700; }
.ngHeaderCenter{ opacity: .95; }
.ngHeaderRight{ opacity: .85; }
#ngHeaderBar span{
  font-size: 12px;
  line-height: 1;
  letter-spacing: .06em;
  text-transform: uppercase;
  font-weight: 900;
  opacity: .92;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#ngHeaderBar .ngHeaderLeft{ flex: 0 0 auto; max-width: 45%; }
#ngHeaderBar .ngHeaderCenter{ flex: 1 1 auto; opacity: .80; max-width: 40%; }
#ngHeaderBar .ngHeaderRight{ flex: 0 0 auto; opacity: .85; max-width: 20%; }

/* Make sure landing UI sits below the header */
#landing .landingUI{ padding-top: 54px; }

/* ===================== v748 GREEN ADVANCE BUTTONS ===================== */
.btnAdvance, .btn-advance, .btnAdvanceGreen{
  border: 1px solid rgba(120,255,170,.35) !important;
  background: linear-gradient(180deg, rgba(60,255,160,.22), rgba(20,120,70,.18)) !important;
  box-shadow:
    0 0 18px rgba(70,255,160,.18),
    inset 0 0 18px rgba(60,255,160,.12) !important;
}
.btnAdvance:active, .btn-advance:active, .btnAdvanceGreen:active{
  transform: translateY(1px) scale(0.99);
  box-shadow:
    0 0 10px rgba(70,255,160,.16),
    inset 0 0 10px rgba(60,255,160,.10) !important;
}
</style>

<script id="ngGuards_v748">
/* =============================================================================
   SECTION_UTILS: SAFETY GUARDS  [SECTION_UTILS]
   - Prevents small errors from killing the whole app.
   - Does NOT change normal behavior when everything is working.
============================================================================= */
(function(){
  // Safe wrapper for event handlers
  window.ngSafe = function(fn, label){
    return function(){
      try { return fn.apply(this, arguments); }
      catch (e) {
        try {
          if (window.ngErr) window.ngErr(label || "Handler error", e && (e.stack || e.message || String(e)));
        } catch(_e){}
      }
    };
  };

  // Guard common DOM lookup usage
  window.ng$ = function(sel){ return document.querySelector(sel); };
  window.ngAll = function(sel){ return Array.from(document.querySelectorAll(sel)); };
})();
</script>

</head>
<body>
<div id="ngHeaderBar"><span class="ngHeaderLeft">Night Games v749</span><span class="ngHeaderCenter">Firebase • Firestore</span><span class="ngHeaderRight" id="ngHeaderRight">Online</span></div>

<!--
================================================================================
  EDIT NOTES (v748)
================================================================================
  [EDIT_BG]       Background image / gradient choices
  [EDIT_LOGO]     Logo placement / size
  [EDIT_VERSION]  Version label placement
  [EDIT_DROPDOWNS]Glass dropdown styling
  [EDIT_COLORS]   Color/opacity tweaks for glass

  TIP: Use Ctrl/Cmd+F for the tags above to jump to the exact spot.
================================================================================
-->

  <div class="dbg" id="dbg">
    <div class="dbgHead" id="dbgHead">
      <span>Debug <b id="dbgState">INIT</b></span>
      <span style="opacity:.7;"></span>
    </div>
    <div class="dbgBody" id="dbgBody">
      <div class="kv"><span>URL</span><code id="dbgUrl"></code></div>
      <div class="kv"><span>Auth</span><code id="dbgAuth"></code></div>
      <div class="kv"><span>Firestore</span><code id="dbgFs"></code></div>
      <div class="kv"><span>Last error</span><code id="dbgErr" class="warn">none</code></div>
      <div style="margin-top:8px; opacity:.8;">If anything fails on iPhone, this box tells us exactly what.</div>
    </div>
  </div>

  <div id="app">
    <section id="landing" class="screen active">
      <div class="landingUI">
        <div class="field3d">
          <input id="emailInput" type="email" placeholder="Enter your email" autocomplete="email" inputmode="email"/>
        </div>
        <button id="enterBtn" class="btn3d" type="button">Enter</button>
        <div class="hint" id="statusLine">Email-only sign-in (no password). Firebase stable build.</div>
      </div>
    </section>

    <section id="players" class="screen">
      <div class="hub">
        <div class="panel">
          <div class="sectionHead headerRow">
            <div class="title">Games</div>
            <div style="display:flex; gap:10px; align-items:center;"><button class="pill pillMini sessionPill" id="sessionBtn" data-action="show_session" type="button" style="display:none;">Session</button></div>
          </div>
          <div class="list" id="gamesList"></div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Players</div></div>
          <div class="list" id="playersList"></div>
        </div>
      </div>
    </section>

    
    
    <section id="setup" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title">Setup</div></div>
          <div class="detailBody" id="setupBody">
            <div style="opacity:.82;">Setup screen is installed. Wiring comes next.</div>
          </div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Controls</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="setupBackBtn" type="button">Back</button>
            <button class="pill btnAdvance" id="setupStartBtn" type="button" style="display:none;">Start Game</button>
</div>
        </div>
      </div>
    </section>


    
    <section id="waiting" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title">Waiting Room</div></div>
          <div class="detailBody" id="waitingBody">
            <div style="opacity:.82;">Waiting room is installed. Wiring comes next.</div>
          </div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Controls</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="waitingBackBtn" type="button">Back</button>
          </div>
        </div>
      </div>
    </section>


    <section id="lobby" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title" id="lobbyTitle">Lobby</div></div>
          <div class="detailBody" id="lobbyBody">Loading…</div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Controls</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="lobbyBackBtn" type="button">Back</button>
            <button class="pill" id="lobbySetupBtn" type="button">Setup</button>
            <button class="pill" id="lobbyStartBtn" type="button" style="display:none;">Start</button>
            <button class="pill" id="lobbyEndBtn" type="button" style="display:none;">End</button>
          </div>
        </div>
      </div>
    </section>


    <section id="detail" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title" id="detailTitle">Detail</div></div>
          <div class="detailBody" id="detailBody">Loading…</div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Navigation</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="backBtn" type="button">Back</button>
            <button class="pill" id="homeBtn" type="button">Home</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="fatal" id="fatal">
    <div class="card">
      <h2>Firebase didn’t start</h2>
      <p>This page uses Firebase modules. If you’re on a web link and still see this, the host is blocking module imports or Firebase is blocked.</p>
      <pre id="fatalMsg">No details.</pre>
    </div>
  </div>

  <script nomodule>
    // Very old browsers only
    document.getElementById("fatal").style.display = "flex";
    document.getElementById("fatalMsg").textContent = "Your browser doesn’t support ES Modules. Use a modern Safari/Chrome.";
  </script>

  <script>
    // Debug UI toggle
    (function(){
      const dbg = document.getElementById("dbg");
      const head = document.getElementById("dbgHead");
      head.addEventListener("click", ()=> dbg.classList.toggle("open"));
      document.getElementById("dbgUrl").textContent = location.href.slice(0, 48) + (location.href.length>48 ? "…" : "");
    })();
  </script>

  <script type="module">


/* v748 VOICE (Phase 4 finalized)
   - iOS requires a user gesture before speech.
   - We trigger on FIRST focus/tap of the email field.
   - We speak the welcome line (NOT a generic prompt).
   - Single voice module; no duplicate declarations.
*/

const NG_BUILD = "v749";
const NG_WELCOME_LINE = "Welcome to America's Sixth Bill Moody's Limited Edition Night Games. Shoot well.";

const NGVoice = (function(){
  const api = { enabled:true, unlocked:false, voice:null, queue:[] };

  function getBestVoice(){
    try {
      const synth = window.speechSynthesis;
      const voices = synth && synth.getVoices ? synth.getVoices() : [];
      if(!voices || !voices.length) return null;
      const en = voices.filter(v => /^en/i.test(v.lang||""));
      const pool = en.length ? en : voices;
      const preferNames = ["Samantha","Victoria","Ava","Allison","Karen","Moira","Tessa","Zira","Serena"];
      for(const name of preferNames){
        const v = pool.find(x => (x.name||"").toLowerCase().includes(name.toLowerCase()));
        if(v) return v;
      }
      return pool[0] || null;
    } catch(e){ return null; }
  }

  function init(){
    if(!("speechSynthesis" in window) || typeof SpeechSynthesisUtterance === "undefined"){
      api.enabled = false; return;
    }
    const pick = () => { api.voice = getBestVoice(); };
    pick();
    try { window.speechSynthesis.onvoiceschanged = pick; } catch(e){}
  }

  function speakNow(text){
    if(!api.enabled || !text) return;
    try { window.speechSynthesis.cancel(); } catch(e){}
    const u = new SpeechSynthesisUtterance(String(text));
    if(api.voice) u.voice = api.voice;
    // Less monotone: slower + warmer, with natural pacing from punctuation/ellipsis.
    u.rate = 0.92;
    u.pitch = 1.06;
    u.volume = 1.0;
    try { window.speechSynthesis.speak(u); } catch(e){}
  }

  function flush(){
    if(!api.unlocked || !api.queue.length) return;
    const q = api.queue.slice();
    api.queue.length = 0;
    // speak sequentially (non-blocking)
    let i = 0;
    const step = () => {
      if(i>=q.length) return;
      speakNow(q[i++]);
      setTimeout(step, 750);
    };
    step();
  }

  function unlock(){
    if(!api.enabled) return;
    api.unlocked = true;
    flush();
  }

  function speak(text){
    if(!api.enabled || !text) return;
    if(!api.unlocked){ api.queue.push(text); return; }
    speakNow(text);
  }

  init();
  return { api, unlock, speak };
})();

window.ngSpeak = (t) => NGVoice.speak(t);

document.addEventListener("DOMContentLoaded", () => {
  const emailEl = document.getElementById("emailInput");

  const bootOnce = () => {
    NGVoice.unlock();
    NGVoice.speak(NG_WELCOME_LINE);
  };

  if(emailEl){
    // Gesture unlock + welcome on first interaction with the email field
    emailEl.addEventListener("focus", bootOnce, { once:true });
    emailEl.addEventListener("pointerdown", bootOnce, { once:true });
    emailEl.addEventListener("touchstart", bootOnce, { once:true });
  } else {
    // Fallback: first tap anywhere
    window.addEventListener("pointerdown", bootOnce, { once:true });
    window.addEventListener("touchstart", bootOnce, { once:true });
  }
});

// END VOICE

</script>

<!-- =======================
     v748 ERROR HUD (shows only on errors)
     ======================= -->
<div id="ngErrToast" aria-live="polite" aria-atomic="true">
  <div class="card">
    <div class="head">
      <div class="title"><span class="dot"></span><span id="ngErrTitle">Hey Steve — something went wrong</span></div>
      <div style="display:flex; gap:8px;">
        <button class="btn" id="ngErrMore" type="button">Details</button>
        <button class="btn" id="ngErrClose" type="button">Close</button>
      </div>
    </div>
    <div class="body">
      <div class="msg" id="ngErrMsg">Error captured.</div>
      <div class="detail" id="ngErrDetail"></div>
    </div>
  </div>
</div>


<script id="ngErrorHud_v748">
/***********************
 *  v748: ERROR HUD + SAFE LOGGING
 *  Purpose:
 *   - If a runtime error happens, show a small toast with details.
 *   - Does NOT block the UI and does NOT change game logic.
 ***********************/
(function(){
  if(window.__NG_ERRHUD__) return; window.__NG_ERRHUD__=true;
  const toast = document.getElementById('ngErrToast');
  if(!toast) return;
  const titleEl = document.getElementById('ngErrTitle');
  const msgEl   = document.getElementById('ngErrMsg');
  const detEl   = document.getElementById('ngErrDetail');
  const moreBtn = document.getElementById('ngErrMore');
  const closeBtn= document.getElementById('ngErrClose');

  let hideTimer = null;

  function showToast(head, msg, detail){
    try{
      titleEl.textContent = head || 'Hey Steve — something went wrong';
      msgEl.textContent = msg || 'Error captured.';
      detEl.textContent = detail || '';
      toast.classList.remove('expanded');
      toast.style.display = 'block';
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>{ toast.style.display = 'none'; }, 9000);
    }catch(e){}
  }

  function normalizeError(err){
    if(!err) return {head:'Hey Steve — something went wrong', msg:'Unknown error', detail:''};
    if(typeof err === 'string') return {head:'Hey Steve — something went wrong', msg:err, detail:''};
    const msg = err.message || String(err);
    const stack = err.stack || '';
    return {head:'Hey Steve — something went wrong', msg, detail:stack};
  }

  // Buttons
  moreBtn && moreBtn.addEventListener('click', ()=>{
    toast.classList.toggle('expanded');
    if(hideTimer) clearTimeout(hideTimer);
  });
  closeBtn && closeBtn.addEventListener('click', ()=>{
    toast.style.display = 'none';
    if(hideTimer) clearTimeout(hideTimer);
  });

  // Global error hooks
  window.addEventListener('error', (event)=>{
    const err = event.error || new Error(event.message || 'Script error');
    const n = normalizeError(err);
    const where = event.filename ? `\n@ ${event.filename}:${event.lineno||0}:${event.colno||0}` : '';
    showToast(n.head, n.msg, (n.detail||'') + where);
  });

  window.addEventListener('unhandledrejection', (event)=>{
    const n = normalizeError(event.reason);
    showToast(n.head, n.msg, n.detail);
  });

  // Expose a manual helper: window.ngErr("message", "detail")
  window.ngErr = function(message, detail){
    showToast('Hey Steve — heads up', message || 'Notice', detail || '');
  };
})();
</script>




<script id="ngBoot_v748">
/* =============================================================================
   v749 BOOT (NO PATCHING / NO DUPLICATE INITS)
   - Fixes Enter wiring (email -> players)
   - Keeps Error HUD always enabled
   - Hides Debug panel unless ?debug=1
============================================================================= */
(function(){
  if(window.__NG_BOOT_V749__) return;
  window.__NG_BOOT_V749__ = true;

  function $(id){ return document.getElementById(id); }
  function showScreen(id){
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    const el = $(id);
    if(el) el.classList.add('active');
  }

  // Debug panel: only if ?debug=1
  try{
    const dbg = $('dbg');
    const showDbg = /(?:\?|&)debug=1(?:&|$)/.test(location.search);
    if(dbg) dbg.style.display = showDbg ? 'block' : 'none';
  }catch(e){}

  // Header right: simple online indicator (local)
  try{
    const right = $('ngHeaderRight');
    if(right){
      right.textContent = navigator.onLine ? 'Online' : 'Offline';
      window.addEventListener('online', ()=> right.textContent='Online');
      window.addEventListener('offline', ()=> right.textContent='Offline');
    }
  }catch(e){}

  // Enter: validate + store + route
  function onEnter(){
    const emailEl = $('emailInput');
    const raw = emailEl ? String(emailEl.value||'').trim() : '';
    const email = raw.toLowerCase();
    if(!email || email.indexOf('@')<1 || email.indexOf('.')<3){
      if(window.ngErr) window.ngErr('Enter a valid email to continue.', 'emailInput invalid: ' + raw);
      const status = $('statusLine');
      if(status) status.textContent = 'Please enter a valid email.';
      try{ emailEl && emailEl.focus(); }catch(e){}
      return;
    }
    try{ localStorage.setItem('ng_email', email); }catch(e){}
    const status = $('statusLine');
    if(status) status.textContent = 'Signed in as ' + email;
    // voice confirmation (if enabled)
    try{ if(window.ngSpeak) window.ngSpeak('Signed in.'); }catch(e){}
    try{ if(emailEl) emailEl.value=''; }catch(e){}
    showScreen('players');
  }

  function bindEnter(){
    const btn = $('enterBtn');
    const emailEl = $('emailInput');
    if(btn && !btn.__ngBound){
      btn.addEventListener('click', onEnter, { passive:true });
      btn.__ngBound = true;
    }
    if(emailEl && !emailEl.__ngBound){
      emailEl.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); onEnter(); }});
      emailEl.__ngBound = true;
    }
  }

  if(document.readyState === 'loading') document.addEventListener('DOMContentLoaded', bindEnter);
  else bindEnter();

})();
</script>

</body>
</html>
