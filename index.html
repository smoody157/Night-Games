<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Night Games ‚Ä¢ v600</title>
<!-- NightGames FULL BUILD v600 generated 2026-02-24 13:16:50 -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root {
  --text: rgba(235,245,255,.92);
  --muted: rgba(215,230,255,.72);
  --cyan: rgba(0,215,255,.95);
  --gold: rgba(255,208,0,.95);
  --blue: rgba(10,75,255,.95);
  --green: rgba(46,230,107,.92);
}
*{box-sizing:border-box;}
html,body{height:100%;margin:0;color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
.wrap{max-width:1100px;margin:0 auto;padding:0 14px;}
.badge{position:fixed;top:10px;right:12px;z-index:50;padding:6px 10px;border-radius:12px;background:rgba(0,0,0,.28);border:1px solid rgba(0,210,255,.22);color:#8ff6ff;font-weight:1000;letter-spacing:2px;}
.h2{font-size:16px;font-weight:1000;margin:0;color:var(--green);letter-spacing:3px;text-transform:uppercase;}
.sub{margin-top:6px;color:var(--muted);font-size:13px;line-height:1.35;}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}
.topbar{display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px;}
.bigName{font-size:22px;font-weight:1000;}
.input{width:100%;max-width:520px;padding:12px 14px;border-radius:16px;border:2px solid var(--blue);outline:none;font-size:15px;}
.btn{padding:12px 14px;border-radius:16px;border:2px solid var(--gold);font-weight:1000;letter-spacing:.8px;cursor:pointer;user-select:none;}
.btn.sm{padding:8px 10px;font-size:12px;border-radius:14px;letter-spacing:.2px;}
.btn.danger{border-color:rgba(255,90,90,.72)!important;color:rgba(255,170,170,.95)!important;}
.btn:active{transform:translateY(1px);}
.list{display:flex;flex-direction:column;gap:10px;margin-top:12px;}
.playerRow{display:flex;align-items:center;justify-content:space-between;gap:10px;min-height:62px;}
.left{display:flex;align-items:center;gap:10px;min-width:0;}
.dot{width:10px;height:10px;border-radius:50%;background:rgba(233,242,255,.20);}
.dot.on{background:var(--green);box-shadow:0 0 14px rgba(46,230,107,.45);}
.pmeta{min-width:0;}
.pname{font-weight:1000;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.pemail{font-size:12px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.chip{padding:6px 10px;border-radius:999px;border:1px solid rgba(120,180,255,.18);font-size:12px;color:var(--muted);}
.cards{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px;}
@media (min-width:860px){.cards{grid-template-columns:1fr 1fr;}}
.gcard{padding:12px;border-radius:18px;}
.gtitle{font-weight:1000;font-size:16px;}
.gsub{color:var(--muted);font-size:12px;margin-top:2px;}
.gactions{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;align-items:center;}
#modalBg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;z-index:9998;}
#modalBg.show{display:block;}
#modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
  width:min(680px,calc(100% - 28px));background:rgba(10,12,16,.92);
  border:1px solid rgba(120,180,255,.22);border-radius:18px;
  box-shadow:0 24px 60px rgba(0,0,0,.65);padding:14px;display:none;z-index:9999;}
#modal.show{display:block;}
.modalTitle{font-size:16px;font-weight:1000;}
.modalActions{display:flex;gap:10px;justify-content:flex-end;margin-top:12px;flex-wrap:wrap;}
#errBox{position:fixed;left:12px;right:12px;bottom:12px;z-index:10000;
  background:rgba(20,0,0,.92);border:1px solid rgba(255,80,80,.5);
  border-radius:14px;padding:12px;display:none;color:#ffd7d7;
  box-shadow:0 16px 40px rgba(0,0,0,.55),0 0 22px rgba(255,80,80,.18);
  font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,'Liberation Mono','Courier New',monospace;
  font-size:12px;white-space:pre-wrap;}
.footer{margin-top:18px;padding:12px 12px;text-align:center;color:rgba(233,242,255,.78);font-size:12px;line-height:1.35;}

/* =========================================================
   NG ‚Äî STAGE SYSTEM v600
   Full-screen background image + 3D floating modules
   Generated 2026-02-24 13:16:50
   ========================================================= */
:root{
  --bgUrl: none;
}
body{
  min-height:100vh;
  background-image: var(--bgUrl);
  background-size: cover;
  background-position: center top;
  background-repeat:no-repeat;
  background-attachment: fixed;
}
.wrap{min-height:100vh; display:flex; flex-direction:column;}
#app{flex:1; min-height:100vh;}
.stage{
  min-height:calc(100vh - 60px);
  display:flex;
  flex-direction:column;
  gap:18px;
  padding:12px 6px 30px;
}
.ngModule{
  position:relative;
  border-radius:26px;
  padding:14px 14px;
  background: transparent !important;
}
.ngModule::before{
  content:"";
  position:absolute; inset:-12px;
  border-radius:32px;
  background:
    radial-gradient(120% 120% at 18% 16%, rgba(0,210,255,.12), rgba(0,0,0,0) 60%),
    radial-gradient(120% 120% at 86% 18%, rgba(255,175,0,.10), rgba(0,0,0,0) 62%),
    radial-gradient(120% 120% at 50% 100%, rgba(10,75,255,.10), rgba(0,0,0,0) 66%);
  filter: blur(2px);
  opacity:.9;
  pointer-events:none;
}
.ngModule::after{
  content:"";
  position:absolute; inset:6px;
  border-radius:20px;
  background: rgba(0,0,0,.10);
  opacity:.35;
  pointer-events:none;
}
.ngModule > *{ position:relative; z-index:1; }
@keyframes ngBob{0%{transform:translate3d(0,0,0)}50%{transform:translate3d(0,-7px,0)}100%{transform:translate3d(0,0,0)}}
.ngModule, .btn, .input, .playerRow, .gcard, .chip{ animation: ngBob 6.8s ease-in-out infinite; will-change:transform; }
.ngModule:nth-child(2n){ animation-duration:7.4s; animation-delay:-1.3s;}
.ngModule:nth-child(3n){ animation-duration:6.4s; animation-delay:-2.1s;}
.playerRow, .gcard{position:relative;border-radius:22px !important;padding:14px 14px !important;border:none !important;}
.playerRow::before, .gcard::before{
  content:""; position:absolute; inset:-10px; border-radius:28px;
  background:
    radial-gradient(120% 120% at 25% 20%, rgba(0,210,255,.10), rgba(0,0,0,0) 62%),
    radial-gradient(120% 120% at 80% 30%, rgba(255,175,0,.08), rgba(0,0,0,0) 64%);
  opacity:.75; pointer-events:none;
}
.playerRow > *, .gcard > *{ position:relative; z-index:1; }
.heroLogo{width:min(980px,100%);max-height:380px;object-fit:contain;display:block;margin:0 auto 6px;}
.hero{min-height:55vh;display:flex;flex-direction:column;justify-content:flex-start;padding-top:8px;text-align:center;}


/* =========================================================
   NG ‚Äî TRUE FLOATING THEME (PASTE LAST)
   Goal: no frames; consistent 3D floating assets like logo
   ========================================================= */

/* Space backdrop (subtle) */
html, body{
  background:
    radial-gradient(120% 90% at 18% 12%, rgba(0,210,255,.14), rgba(0,0,0,0) 55%),
    radial-gradient(110% 80% at 82% 14%, rgba(255,175,0,.12), rgba(0,0,0,0) 58%),
    radial-gradient(120% 120% at 50% 96%, rgba(160,120,255,.09), rgba(0,0,0,0) 62%),
    #000 !important;
}

/* Tiny star dust */
body::after{
  content:"";
  position:fixed; inset:0;
  background-image:
    radial-gradient(rgba(255,255,255,.22) 1px, transparent 1px),
    radial-gradient(rgba(0,210,255,.18) 1px, transparent 1px),
    radial-gradient(rgba(255,175,0,.14) 1px, transparent 1px);
  background-size: 95px 95px, 140px 140px, 180px 180px;
  background-position: 0 0, 34px 58px, 72px 24px;
  opacity:.07;
  pointer-events:none;
}

/* HARD KILL: any screen/frame wrappers */
.wrap, #app, .card, .frame, .shell, .outer, .container, .wrapper, .appFrame,
.heroHeader, .heroPanel, .panel, .footer,
.viewport, .phone, .stage, .canvas{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  outline: none !important;
  backdrop-filter: none !important;
}

/* HARD KILL: inner ‚Äúcard modules‚Äù (these create the framed look) */
.topbar, .playerRow, .gcard, .chip, .lock, .ok, .table, .list,
.header, .main, .grid, .cards{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
}

/* Universal ‚Äúfloating 3D‚Äù lighting ‚Äî same feel everywhere */
:root{
  --floatShadow: drop-shadow(0 18px 34px rgba(0,0,0,.66));
  --edgeCyan: 0 0 22px rgba(0,210,255,.18);
  --edgeAmber: 0 0 18px rgba(255,175,0,.12);
}

/* Everything important gets suspended */
.heroLogo, .h1, .h2, .sub,
.btn, button, a.btn,
input, select,
.playerRow *, .topbar *, .gcard *{
  filter: var(--floatShadow);
}

/* Inputs: outline-only neon (no fills) */
input, select, .input, #inEmail, #inName{
  background: transparent !important;
  border-radius: 16px !important;
  border: 2px solid rgba(10,75,255,.95) !important;
  color: rgba(235,245,255,.92) !important;
  box-shadow:
    0 0 14px rgba(10,75,255,.55),
    0 0 30px rgba(10,75,255,.22),
    inset 0 0 10px rgba(10,75,255,.14) !important;
}
input::placeholder{ color: rgba(200,220,255,.45) !important; }

/* Buttons: outline-only (no green frame/glow) */
.btn, button, #btnEnter{
  background: transparent !important;
  border-radius: 16px !important;
  border: 2px solid rgba(255,208,0,.95) !important;
  color: rgba(255,208,0,.95) !important;
  box-shadow:
    0 0 18px rgba(255,208,0,.22),
    0 0 34px rgba(255,160,0,.14),
    var(--edgeCyan),
    var(--edgeAmber) !important;
  text-shadow:
    0 0 12px rgba(255,208,0,.45),
    0 0 24px rgba(255,160,0,.25) !important;
}
.btn::before, .btn::after,
#btnEnter::before, #btnEnter::after{
  content:none !important;
}

/* Optional ‚Äúrunway light‚Äù under button if present */
.sparkBar, .underBar{
  height: 8px !important;
  border-radius: 999px !important;
  background: linear-gradient(90deg,
    rgba(10,75,255,.10),
    rgba(0,210,255,.18),
    rgba(255,175,0,.14),
    rgba(10,75,255,.10)
  ) !important;
  box-shadow:
    0 0 16px rgba(0,210,255,.12),
    0 0 14px rgba(255,175,0,.08) !important;
}

/* Kill any remaining ‚Äúborders everywhere‚Äù rules that nuke your outlines */
*{ border-color: initial; }
</style>
</head>

<body>
<div class="badge">v593</div>
<div id="errBox"></div>
<div id="modalBg"></div>
<div id="modal"></div>

<div class="wrap">
  <div id="app"></div>
  <div class="footer">
    <b>Night Games</b> ‚Ä¢ Email-only entry ‚Ä¢ Presence uses heartbeat + realtime snapshot ‚Ä¢ Up to 8 players per match
  </div>
</div>

<script>
(() => {
"use strict";
const BUILD = 593;
const firebaseConfig = {"apiKey": "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo", "authDomain": "gamenightdarts-e7601.firebaseapp.com", "projectId": "gamenightdarts-e7601", "storageBucket": "gamenightdarts-e7601.firebasestorage.app", "messagingSenderId": "270045452251", "appId": "1:270045452251:web:5a4a661140a60780e939fe", "measurementId": "G-M60TDFYBW0"};
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const store = {
  get(k, fallback=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fallback; }catch{ return fallback; } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
  del(k){ localStorage.removeItem(k); }
};
const nowMs = () => Date.now();
const normEmail = (e)=>String(e||"").trim().toLowerCase();
const normName = (n,email="")=>{ const v=String(n||"").trim(); if(v) return v; const em=normEmail(email); return em?em.split("@")[0]:"Player"; };
function htmlEscape(s){ return String(s??"").replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
function showError(msg){ const box=document.getElementById("errBox"); box.style.display="block"; box.innerHTML="<b>Build v"+BUILD+" error:</b>\n"+String(msg); }
window.addEventListener("error",(e)=>showError(e?.error?.stack||e?.message||e));
window.addEventListener("unhandledrejection",(e)=>showError(e?.reason?.stack||e?.reason||e));
function modal(title, bodyHtml, actions=[]) {
  const bg=document.getElementById("modalBg"); const m=document.getElementById("modal");
  bg.classList.add("show"); m.classList.add("show");
  m.innerHTML=`<div class="modalTitle">${title}</div><div class="modalBody">${bodyHtml}</div>
    <div class="modalActions">${actions.map(a=>`<button class="btn sm" id="${a.id}" type="button">${a.label}</button>`).join("")}</div>`;
  const close=()=>{bg.classList.remove("show");m.classList.remove("show");m.innerHTML="";};
  bg.onclick=close;
  actions.forEach(a=>{ const b=document.getElementById(a.id); if(b) b.onclick=async()=>{ const r=await a.onClick(close); if(r!==false) close(); }; });
}

// Firebase
const fb={app:null,auth:null,db:null};
let fbReady=false;
async function fbInitOnce(){ if(fbReady) return; if(!firebaseConfig?.apiKey) throw new Error("firebaseConfig missing."); if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  fb.app=firebase.app(); fb.auth=firebase.auth(); fb.db=firebase.firestore(); fbReady=true; }
async function fbEnsureAnon(){ await fbInitOnce(); if(fb.auth.currentUser) return fb.auth.currentUser; const cred=await fb.auth.signInAnonymously(); return cred.user; }

async function playersLoadAll(){ await fbEnsureAnon(); const snap=await fb.db.collection("players").get();
  return snap.docs.map(d=>d.data()).filter(Boolean).map(p=>({email:normEmail(p.email), name:normName(p.name,p.email), locked:!!p.locked})).filter(p=>p.email); }
async function playerUpsert(email,name,extra={}){ await fbEnsureAnon(); email=normEmail(email); name=normName(name,email);
  await fb.db.collection("players").doc(email).set({email,name,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),...extra},{merge:true});
  return {email,name}; }

// Presence
const presence={map:new Map(),unsub:null,timer:null};
function stopPresence(){ if(presence.unsub) try{presence.unsub();}catch{} presence.unsub=null; if(presence.timer) clearInterval(presence.timer); presence.timer=null; presence.map.clear(); }
function isOnline(email){ const p=presence.map.get(normEmail(email)); if(!p) return false; return (nowMs()-Number(p.lastSeenMs||0))<=90000; }
async function startPresence(me){ await fbEnsureAnon(); stopPresence(); const email=normEmail(me.email); if(!email) return; const ref=fb.db.collection("presence").doc(email);
  async function ping(){ try{ await ref.set({email,name:me.name||"",lastSeenMs:nowMs(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); }catch{} }
  await ping(); presence.timer=setInterval(ping,25000);
  presence.unsub=fb.db.collection("presence").onSnapshot((snap)=>{ presence.map.clear(); snap.forEach(doc=>{ const d=doc.data()||{}; if(d.email) presence.map.set(normEmail(d.email),d); }); if(App.route==="hub") renderHub(); if(App.route==="match") renderMatch(); },(err)=>showError(err?.message||err)); }

// Matches + Games
const MATCH_MAX_PLAYERS = 8;
function gameLabel(key){ if(key==="cricket") return "Cricket"; if(key==="shanghai") return "Shanghai"; if(key==="01-301") return "301"; if(key==="01-501") return "501"; if(key==="01-701") return "701"; return key||"Game"; }
function gameType(key){ if(key==="cricket") return "cricket"; if(key==="shanghai") return "shanghai"; if(String(key).startsWith("01-")) return "01"; return "unknown"; }
function gameStart(key){ if(key==="01-301") return 301; if(key==="01-501") return 501; if(key==="01-701") return 701; return 501; }

const CRICKET_NUMS=[20,19,18,17,16,15,"B"];
function cricketVal(num){ return (num==="B")?25:Number(num); }
function cricketMarks(st,email,num){ return Number((st.marks||{})[email+"_"+num]||0); }
function cricketClosed(st,email,num){ return cricketMarks(st,email,num)>=3; }
function cricketAllClosed(st,email){ return CRICKET_NUMS.every(n=>cricketClosed(st,email,n)); }
function cricketOppOpen(st, players, num, hitter){ return players.some(p=>p.email!==hitter && !cricketClosed(st,p.email,num)); }
function cricketWinner(st, players){ const scores=st.score||{}; const c=players.filter(p=>cricketAllClosed(st,p.email)); if(!c.length) return null;
  for(const p of c){ const s=Number(scores[p.email]||0); if(players.every(o=>Number(scores[o.email]||0)<=s)) return p.email; } return null; }

function makeInitialGameState(match){ const t=gameType(match.game); const ps=(match.players||[]).map(p=>({email:normEmail(p.email),name:p.name||p.email}));
  if(t==="cricket") return {type:"cricket",version:1,createdMs:nowMs(),marks:{},score:Object.fromEntries(ps.map(p=>[p.email,0])),turnIndex:0,log:[]};
  if(t==="shanghai") return {type:"shanghai",version:1,createdMs:nowMs(),round:1,turnIndex:0,total:Object.fromEntries(ps.map(p=>[p.email,0])),history:[]};
  if(t==="01"){ const start=gameStart(match.game); return {type:"01",version:1,createdMs:nowMs(),start,turnIndex:0,scores:Object.fromEntries(ps.map(p=>[p.email,start])),history:[]}; }
  return {type:"unknown",createdMs:nowMs()}; }
function normalizePlayersForState(st, players){ const ps=(players||[]).map(p=>({email:normEmail(p.email),name:p.name||p.email}));
  if(st.type==="cricket"){ st.score=st.score||{}; st.marks=st.marks||{}; ps.forEach(p=>{ if(typeof st.score[p.email]!=="number") st.score[p.email]=0; }); }
  if(st.type==="shanghai"){ st.total=st.total||{}; st.history=st.history||[]; ps.forEach(p=>{ if(typeof st.total[p.email]!=="number") st.total[p.email]=0; }); }
  if(st.type==="01"){ st.scores=st.scores||{}; st.history=st.history||[]; ps.forEach(p=>{ if(typeof st.scores[p.email]!=="number") st.scores[p.email]=st.start||501; }); }
  return ps; }

async function matchCreate(gameKey, me){ await fbEnsureAnon(); const ref=fb.db.collection("matches").doc();
  const match={id:ref.id,game:gameKey,gameType:gameType(gameKey),status:"open",maxPlayers:MATCH_MAX_PLAYERS,players:[{email:me.email,name:me.name}],
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  match.gameState=makeInitialGameState(match); await ref.set(match); return ref.id; }
async function matchJoin(id, me){ await fbEnsureAnon(); const ref=fb.db.collection("matches").doc(id); const meE=normEmail(me.email);
  await fb.db.runTransaction(async(tx)=>{ const snap=await tx.get(ref); if(!snap.exists) throw new Error("Match not found");
    const m=snap.data()||{}; const ps=Array.isArray(m.players)?m.players:[];
    if(ps.some(p=>normEmail(p.email)===meE)) return;
    const maxP=Number(m.maxPlayers||MATCH_MAX_PLAYERS); if(ps.length>=maxP) throw new Error("Match full (max "+maxP+")");
    ps.push({email:meE,name:me.name});
    const gs=m.gameState || makeInitialGameState({game:m.game,players:ps});
    tx.update(ref,{players:ps,gameState:gs,status:(ps.length>=2)?"active":"open",updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
  }); }
async function matchUpdateState(id, st){ await fbEnsureAnon(); await fb.db.collection("matches").doc(id).set({gameState:st,updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); }

let unsubMatches=null; function stopMatchesList(){ if(unsubMatches) try{unsubMatches();}catch{} unsubMatches=null; }
async function startMatchesList(){ await fbEnsureAnon(); stopMatchesList();
  unsubMatches=fb.db.collection("matches").where("status","in",["open","active"]).orderBy("updatedAt","desc").limit(60).onSnapshot((snap)=>{
    App.matches=snap.docs.map(d=>d.data()).filter(Boolean).map(m=>({id:m.id,game:m.game,gameType:m.gameType||gameType(m.game),status:m.status||"open",maxPlayers:Number(m.maxPlayers||MATCH_MAX_PLAYERS),players:Array.isArray(m.players)?m.players:[],gameState:m.gameState||null}));
    if(App.route==="hub") renderHub();
  },(err)=>showError(err?.message||err)); }

let unsubMatch=null; function stopMatchDoc(){ if(unsubMatch) try{unsubMatch();}catch{} unsubMatch=null; }
async function startMatchDoc(id){ await fbEnsureAnon(); stopMatchDoc();
  unsubMatch=fb.db.collection("matches").doc(id).onSnapshot((snap)=>{ if(!snap.exists){ App.activeMatch=null; if(App.route==="match") setRoute("hub"); return; }
    const m=snap.data()||{};
    App.activeMatch={id:m.id,game:m.game,gameType:m.gameType||gameType(m.game),status:m.status||"open",maxPlayers:Number(m.maxPlayers||MATCH_MAX_PLAYERS),players:Array.isArray(m.players)?m.players:[],gameState:m.gameState||null};
    if(App.route==="match") renderMatch();
  },(err)=>showError(err?.message||err)); }

// Router + UI
const App={route:"auth",me:null,players:[],matches:[],activeMatch:null};
function setHtml(h){ document.getElementById("app").innerHTML=h; }
function setRoute(r){ App.route=r; render(); }
function render(){ if(App.route==="auth") return renderAuth(); if(App.route==="hub") return renderHub(); if(App.route==="match") return renderMatch(); App.route="auth"; return renderAuth(); }

function gameCard(key,title,sub){ return `<div class="gcard" data-game="${key}" style="cursor:pointer"><div class="gtitle">${title}</div><div class="gsub">${sub}</div>
  <div class="gactions"><button class="btn sm" type="button">Create Match</button><div class="chip">Tap</div></div></div>`; }

function renderAuth(){ setHtml(`<div class="hero"><img class="heroLogo" src="./7F737C26-56A1-497B-A4A2-CCD6141E7B8C.png" alt="Night Games" onerror="this.style.display='none'"/>
  <div class="sub">Email sign-in to enter Night Games.</div></div>
  <div class="panel"><div class="h2">Sign in</div><div class="sub">Enter your email. New players will be asked for a name once.</div><div style="height:12px"></div>
  <input id="inEmail" class="input" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
  <div style="height:12px"></div><button id="btnEnter" class="btn" type="button">ENTER</button><div style="height:10px"></div>
  <div id="authHint" class="sub" style="min-height:18px"></div><div class="sub" style="opacity:.9;margin-top:6px">Build v${BUILD} ‚Ä¢ GitHub Pages-safe</div></div>`);
  const hint=document.getElementById("authHint"); const setHint=(t)=>{ if(hint) hint.textContent=t||""; };
  const emailEl=document.getElementById("inEmail"); const saved=store.get("me",null); if(saved?.email) emailEl.value=saved.email;
  async function enterFlow(){ try{ const email=normEmail(emailEl.value); if(!email){ alert("Enter your email"); setHint("Email required."); return; }
      setHint("Connecting..."); await fbEnsureAnon(); setHint("Loading players..."); App.players=await playersLoadAll();
      let me=App.players.find(p=>p.email===email);
      if(!me){ setHint("New player ‚Äî enter name"); modal("New Player",`<div class="sub">Enter your name for <b>${htmlEscape(email)}</b></div><div style="height:10px"></div><input id="inName" class="input" placeholder="Your name" />`,[{id:"saveName",label:"Save",onClick:async()=>{
        const name=normName(document.getElementById("inName").value,email); if(!name){ alert("Name required"); return false; }
        setHint("Saving..."); await playerUpsert(email,name); App.players=await playersLoadAll(); me=App.players.find(p=>p.email===email)||{email,name};
        App.me={email:me.email,name:me.name}; store.set("me",{email:me.email,name:me.name,ts:nowMs()}); await startPresence(App.me); await startMatchesList(); setRoute("hub");
      }}]); return; }
      App.me={email:me.email,name:me.name}; store.set("me",{email:me.email,name:me.name,ts:nowMs()}); await startPresence(App.me); await startMatchesList(); setHint("Entering..."); setRoute("hub");
    }catch(err){ showError(err?.stack||err?.message||err); setHint("Error. See red box."); } }
  document.getElementById("btnEnter").onclick=enterFlow; emailEl.onkeydown=(e)=>{ if(e.key==="Enter") enterFlow(); }; }

function renderHub(){ const me=App.me||store.get("me",null); if(!me?.email){ setRoute("auth"); return; }
  App.me={email:normEmail(me.email),name:normName(me.name,me.email)};
  const players=(App.players||[]).slice().sort((a,b)=>a.name.localeCompare(b.name)); const matches=(App.matches||[]);
  setHtml(`<div class="topbar"><div class="bigName">Welcome, ${htmlEscape(App.me.name)}</div><div class="row"><div class="chip">${htmlEscape(App.me.email)}</div>
    <button id="btnSignOut" class="btn sm danger" type="button">Sign out</button></div></div>
    <div class="panel"><div class="h2">Players</div><div class="sub">Green dot means active within ~90 seconds (heartbeat + realtime).</div><div class="list">
      ${players.map(p=>`<div class="playerRow"><div class="left"><div class="dot ${isOnline(p.email)?"on":""}"></div><div class="pmeta"><div class="pname">${htmlEscape(p.name)}</div><div class="pemail">${htmlEscape(p.email)}</div></div></div>
      <div class="chip">${p.locked?"Locked":"Ready"}</div></div>`).join("")}
    </div></div>
    <div class="panel"><div class="h2">Games</div><div class="sub">Create a match, then others join from Open Matches.</div><div class="cards">
      ${gameCard("01-701","701","Subtract to zero. Winner hits 0.")}
      ${gameCard("01-501","501","Subtract to zero. Winner hits 0.")}
      ${gameCard("01-301","301","Fast game. Subtract to zero.")}
      ${gameCard("cricket","Cricket","Close 15‚Äì20 + Bull and score extras.")}
      ${gameCard("shanghai","Shanghai","Rounds 1‚Äì20 + Bull. Single+Double+Triple = Shanghai!")} 
    </div></div>
    <div class="panel"><div class="h2">Open Matches</div><div class="sub">Tap a match to join (up to 8 players).</div><div class="list">
      ${matches.length?matches.map(m=>`<div class="playerRow" data-mid="${m.id}" style="cursor:pointer"><div class="left"><div class="pmeta">
        <div class="pname">${htmlEscape(gameLabel(m.game))} ‚Ä¢ ${htmlEscape(m.status)} ‚Ä¢ ${(m.players||[]).length}/${m.maxPlayers||8}</div>
        <div class="pemail">${(m.players||[]).map(p=>htmlEscape(p.name||p.email)).join(" vs ")}</div></div></div><div class="chip">Join</div></div>`).join(""):`<div class="sub">No open matches yet. Create one above.</div>`}
    </div></div>`);
  document.getElementById("btnSignOut").onclick=()=>{ store.del("me"); App.me=null; App.activeMatch=null; stopMatchDoc(); stopMatchesList(); stopPresence(); setRoute("auth"); };
  $$("[data-game]",document.getElementById("app")).forEach(el=>{ el.onclick=async()=>{ try{ const key=el.getAttribute("data-game"); const id=await matchCreate(key,App.me); await startMatchDoc(id); setRoute("match"); }catch(err){ showError(err?.stack||err?.message||err); } }; });
  $$("[data-mid]",document.getElementById("app")).forEach(el=>{ el.onclick=async()=>{ try{ const mid=el.getAttribute("data-mid"); await matchJoin(mid,App.me); await startMatchDoc(mid); setRoute("match"); }catch(err){ showError(err?.stack||err?.message||err); } }; });
}

function renderMatch(){ const me=App.me||store.get("me",null); if(!me?.email){ setRoute("auth"); return; }
  App.me={email:normEmail(me.email),name:normName(me.name,me.email)};
  const m=App.activeMatch; if(!m?.id){ setRoute("hub"); return; }
  const players=(m.players||[]).map(p=>({email:normEmail(p.email),name:p.name||p.email}));
  const st=m.gameState||makeInitialGameState(m);
  const plist=players.map(p=>`<span class="chip">${htmlEscape(p.name)}${isOnline(p.email)?" üü¢":""}</span>`).join(" ");
  setHtml(`<div class="topbar"><div class="bigName">${htmlEscape(gameLabel(m.game))}</div><div class="row">
    <button id="btnBack" class="btn sm" type="button">Back</button><button id="btnLeave" class="btn sm danger" type="button">Leave Match</button></div></div>
    <div class="panel"><div class="h2">Match</div><div class="sub">Players: ${plist}</div><div class="sub">Match ID: <span class="chip">${htmlEscape(m.id)}</span></div></div>
    <div class="panel" id="gameMount"></div>`);
  document.getElementById("btnBack").onclick=()=>setRoute("hub");
  document.getElementById("btnLeave").onclick=()=>{ stopMatchDoc(); App.activeMatch=null; setRoute("hub"); };
  mountGame(document.getElementById("gameMount"),m,st,players);
}

function mountGame(mount,match,state,players){ const type=match.gameType||gameType(match.game); const st=state||makeInitialGameState(match); const ps=normalizePlayersForState(st,players);
  if(type==="01") return mount01(mount,match,st,ps);
  if(type==="cricket") return mountCricket(mount,match,st,ps);
  if(type==="shanghai") return mountShanghai(mount,match,st,ps);
  mount.innerHTML=`<div class="h2">Unknown game</div><div class="sub">Game type not recognized.</div>`;
}

function mount01(mount,match,st,players){ const cur=players[st.turnIndex%players.length]; const winner=st.winnerEmail||null;
  const rows=players.map(p=>`<div class="playerRow"><div class="left"><div class="dot ${(p.email===cur.email&&!winner)?"on":""}"></div><div class="pmeta"><div class="pname">${htmlEscape(p.name)}</div><div class="pemail">${htmlEscape(p.email)}</div></div></div>
    <div class="chip">${Number(st.scores[p.email]||0)}</div></div>`).join("");
  const winLine=winner?`<div class="sub"><b>Winner:</b> ${htmlEscape((players.find(p=>p.email===winner)||{}).name||winner)}</div>`:"";
  mount.innerHTML=`<div class="h2">01 (${gameLabel(match.game)})</div><div class="sub">Subtract to zero. Bust if below 0. Max 180 per turn.</div>${winLine}
    <div style="height:10px"></div>${rows}<div style="height:12px"></div><div class="sub">Turn: <span class="chip">${htmlEscape(cur.name)}</span></div>
    <div style="height:10px"></div><input id="inPts" class="input" inputmode="numeric" placeholder="Points scored (0-180)"/>
    <div style="height:10px"></div><div class="row"><button id="btnApply" class="btn sm" type="button" ${winner?"disabled":""}>Apply</button>
    <button id="btnUndo" class="btn sm" type="button" ${st.history.length?"":"disabled"}>Undo</button></div>`;
  const apply=async()=>{ try{ if(winner) return; const raw=String(document.getElementById("inPts").value||"").trim(); const pts=Math.max(0,Math.min(180,parseInt(raw,10)||0));
      const before=Number(st.scores[cur.email]||st.start||501); const after=before-pts; const bust=(after<0); if(!bust) st.scores[cur.email]=after;
      st.history.push({t:nowMs(),email:cur.email,pts,before,after:bust?before:after,bust});
      if(!bust && after===0) st.winnerEmail=cur.email; else st.turnIndex=(st.turnIndex+1)%players.length;
      await matchUpdateState(match.id,st);
    }catch(err){ showError(err?.stack||err?.message||err); } };
  const undo=async()=>{ try{ const last=st.history.pop(); if(!last) return; st.scores[last.email]=last.before; st.winnerEmail=null;
      const idx=players.findIndex(p=>p.email===last.email); if(idx>=0) st.turnIndex=idx; await matchUpdateState(match.id,st);
    }catch(err){ showError(err?.stack||err?.message||err); } };
  document.getElementById("btnApply").onclick=apply; document.getElementById("btnUndo").onclick=undo; document.getElementById("inPts").onkeydown=(e)=>{ if(e.key==="Enter") apply(); };
}

function mountCricket(mount,match,st,players){ const winner=cricketWinner(st,players)||null; const cur=players[st.turnIndex%players.length];
  const marksSymbol=(m)=>m>=3?"XXX":(m===2?"XX":(m===1?"X":"-"));
  const header=`<tr><th>Num</th>${players.map(p=>`<th>${htmlEscape(p.name)}</th>`).join("")}</tr>`;
  const body=CRICKET_NUMS.map(n=>`<tr><td><b>${n}</b></td>${players.map(p=>`<td>${marksSymbol(Math.min(3,cricketMarks(st,p.email,n)))}</td>`).join("")}</tr>`).join("");
  const scoreRow=players.map(p=>`<div class="chip">${htmlEscape(p.name)}: ${Number(st.score[p.email]||0)}</div>`).join(" ");
  const winLine=winner?`<div class="sub"><b>Winner:</b> ${htmlEscape((players.find(p=>p.email===winner)||{}).name||winner)}</div>`:"";
  mount.innerHTML=`<div class="h2">Cricket</div><div class="sub">Close 15‚Äì20 + Bull. Extra marks score points if opponents are open.</div>${winLine}
    <div style="height:10px"></div><div class="sub">Scores: ${scoreRow}</div><div style="height:10px"></div>
    <div class="sub">Turn: <span class="chip">${htmlEscape(cur.name)}</span></div><div style="height:10px"></div>
    <table class="table"><thead>${header}</thead><tbody>${body}</tbody></table>
    <div style="height:10px"></div><div class="row">
      <select id="crNum" class="input" style="max-width:180px">${CRICKET_NUMS.map(n=>`<option value="${n}">${n}</option>`).join("")}</select>
      <button id="hitS" class="btn sm" type="button" ${winner?"disabled":""}>Single</button>
      <button id="hitD" class="btn sm" type="button" ${winner?"disabled":""}>Double</button>
      <button id="hitT" class="btn sm" type="button" ${winner?"disabled":""}>Triple</button>
      <button id="nextTurn" class="btn sm" type="button" ${winner?"disabled":""}>Next Turn</button>
      <button id="undoC" class="btn sm" type="button" ${st.log.length?"":"disabled"}>Undo</button>
    </div>`;
  const applyHit=async(mult)=>{ try{ if(winner) return; const num=document.getElementById("crNum").value; let marksAdded=mult; if(num==="B" && mult===3) marksAdded=2;
      const before={marks:JSON.parse(JSON.stringify(st.marks||{})),score:JSON.parse(JSON.stringify(st.score||{})),turnIndex:st.turnIndex};
      st.marks=st.marks||{}; st.score=st.score||{}; if(typeof st.score[cur.email]!=="number") st.score[cur.email]=0;
      const key=cur.email+"_"+num; const prev=Number(st.marks[key]||0); const toClose=Math.max(0,3-prev); const closeMarks=Math.min(toClose,marksAdded); const extra=marksAdded-closeMarks;
      st.marks[key]=Math.min(3,prev+closeMarks);
      let scored=0; if(extra>0 && cricketOppOpen(st,players,num,cur.email)){ scored=extra*cricketVal(num); st.score[cur.email]+=scored; }
      st.log=st.log||[]; st.log.push({t:nowMs(),email:cur.email,num,mult,scored,before});
      await matchUpdateState(match.id,st);
    }catch(err){ showError(err?.stack||err?.message||err); } };
  const nextTurn=async()=>{ try{ if(winner) return; st.turnIndex=(st.turnIndex+1)%players.length; await matchUpdateState(match.id,st); }catch(err){ showError(err?.stack||err?.message||err); } };
  const undo=async()=>{ try{ const last=st.log.pop(); if(!last) return; st.marks=last.before.marks; st.score=last.before.score; st.turnIndex=last.before.turnIndex; await matchUpdateState(match.id,st); }catch(err){ showError(err?.stack||err?.message||err); } };
  document.getElementById("hitS").onclick=()=>applyHit(1); document.getElementById("hitD").onclick=()=>applyHit(2); document.getElementById("hitT").onclick=()=>applyHit(3);
  document.getElementById("nextTurn").onclick=nextTurn; document.getElementById("undoC").onclick=undo;
}

function mountShanghai(mount,match,st,players){ const roundsTotal=21; const target=(st.round>=1 && st.round<=20)?st.round:25; const roundLabel=(st.round<=20)?String(st.round):"Bull";
  const cur=players[st.turnIndex%players.length]; const finished=st.round>roundsTotal;
  let leader=null; if(finished){ let best=-Infinity; players.forEach(p=>{ const t=Number(st.total[p.email]||0); if(t>best){best=t; leader=p.email;} }); }
  const totals=players.map(p=>`<div class="playerRow"><div class="left"><div class="dot ${(p.email===cur.email && !finished)?"on":""}"></div>
    <div class="pmeta"><div class="pname">${htmlEscape(p.name)}</div><div class="pemail">${htmlEscape(p.email)}</div></div></div><div class="chip">${Number(st.total[p.email]||0)}</div></div>`).join("");
  const winLine=finished?`<div class="sub"><b>Winner:</b> ${htmlEscape((players.find(p=>p.email===leader)||{}).name||leader)} ‚Ä¢ Final totals locked</div>`:"";
  mount.innerHTML=`<div class="h2">Shanghai</div><div class="sub">Round ${htmlEscape(roundLabel)} target = <span class="chip">${target}</span>. Enter 3 darts as multipliers.</div>
    <div class="sub">Shanghai bonus: S+D+T in one round gives +${target}√ó7 bonus.</div>${winLine}<div style="height:10px"></div>${totals}
    <div style="height:10px"></div><div class="sub">Turn: <span class="chip">${htmlEscape(cur.name)}</span> ‚Ä¢ Round: <span class="chip">${htmlEscape(roundLabel)}</span></div>
    <div style="height:10px"></div><div class="row">
      <select id="d1" class="input" style="max-width:140px" ${finished?"disabled":""}><option value="0">Miss</option><option value="1">Single</option><option value="2">Double</option><option value="3">Triple</option></select>
      <select id="d2" class="input" style="max-width:140px" ${finished?"disabled":""}><option value="0">Miss</option><option value="1">Single</option><option value="2">Double</option><option value="3">Triple</option></select>
      <select id="d3" class="input" style="max-width:140px" ${finished?"disabled":""}><option value="0">Miss</option><option value="1">Single</option><option value="2">Double</option><option value="3">Triple</option></select>
      <button id="applySh" class="btn sm" type="button" ${finished?"disabled":""}>Apply</button>
      <button id="undoSh" class="btn sm" type="button" ${st.history.length?"":"disabled"}>Undo</button>
    </div><div style="height:12px"></div><div class="sub">History (latest 8):</div><div class="list">
      ${st.history.slice(-8).reverse().map(h=>`<div class="playerRow"><div class="left"><div class="pmeta"><div class="pname">${htmlEscape(h.name)} ‚Ä¢ Round ${h.roundLabel} ‚Ä¢ Darts: ${h.darts.join("-")}</div>
      <div class="pemail">Points: ${h.points} ${h.shanghai?"‚Ä¢ SHANGHAI!":""}</div></div></div><div class="chip">Total: ${h.totalAfter}</div></div>`).join("") || `<div class="sub">No turns yet.</div>`}
    </div>`;
  const apply=async()=>{ try{ if(finished) return; const m1=parseInt(document.getElementById("d1").value,10)||0; const m2=parseInt(document.getElementById("d2").value,10)||0; const m3=parseInt(document.getElementById("d3").value,10)||0;
      const darts=[m1,m2,m3]; const points=(m1+m2+m3)*target; const sh=darts.includes(1)&&darts.includes(2)&&darts.includes(3); const bonus=sh?(target*7):0; const totalAdd=points+bonus;
      const before=JSON.parse(JSON.stringify(st.total||{})); st.total[cur.email]=Number(st.total[cur.email]||0)+totalAdd;
      st.history.push({t:nowMs(),email:cur.email,name:cur.name,round:st.round,roundLabel,target,darts:darts.map(x=>x===0?"M":(x===1?"S":(x===2?"D":"T"))),points:totalAdd,shanghai:sh,totalAfter:st.total[cur.email],before,turnIndex:st.turnIndex});
      if(st.turnIndex % players.length === players.length-1) st.round += 1;
      st.turnIndex = (st.turnIndex + 1) % players.length;
      await matchUpdateState(match.id,st);
    }catch(err){ showError(err?.stack||err?.message||err); } };
  const undo=async()=>{ try{ const last=st.history.pop(); if(!last) return; st.total=last.before; st.turnIndex=last.turnIndex; if(last.turnIndex % players.length === players.length-1) st.round=Math.max(1,(st.round||1)-1); await matchUpdateState(match.id,st);
    }catch(err){ showError(err?.stack||err?.message||err); } };
  document.getElementById("applySh").onclick=apply; document.getElementById("undoSh").onclick=undo;
}

// Boot
async function boot(){ try{ setRoute("auth"); await fbEnsureAnon(); App.players=await playersLoadAll();
    const saved=store.get("me",null); if(saved?.email){ App.me={email:normEmail(saved.email),name:normName(saved.name,saved.email)}; await startPresence(App.me); await startMatchesList(); setRoute("hub"); }
  }catch(err){ showError(err?.stack||err?.message||err); setRoute("auth"); } }
document.addEventListener("DOMContentLoaded", boot);
})();
</script>
</body>
</html>

</style>
</head>
<body>
<div class="badge">v600</div>
<div id="errBox"></div>
<div id="modalBg"></div>
<div id="modal"></div>
<div class="wrap">
  <div id="app"></div>
  <div class="footer"><b>Night Games</b> ‚Ä¢ v600 ‚Ä¢ GitHub Pages</div>
</div>

<script>
(() => {
"use strict";
const BUILD = 600;
const firebaseConfig = {"apiKey": "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo", "authDomain": "gamenightdarts-e7601.firebaseapp.com", "projectId": "gamenightdarts-e7601", "storageBucket": "gamenightdarts-e7601.firebasestorage.app", "messagingSenderId": "270045452251", "appId": "1:270045452251:web:5a4a661140a60780e939fe", "measurementId": "G-M60TDFYBW0"};

const $ = (sel, root=document) => root.querySelector(sel);
const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const nowMs = () => Date.now();
const normEmail = (e)=>String(e||"").trim().toLowerCase();
const normName = (n,email="")=>{ const v=String(n||"").trim(); if(v) return v; const em=normEmail(email); return em?em.split("@")[0]:"Player"; };
function esc(s){ return String(s ?? "").replace(/[&<>"']/g, c => ({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

const store = {
  get(k, fallback=null){ try{ const v=localStorage.getItem(k); return v?JSON.parse(v):fallback; }catch{ return fallback; } },
  set(k,v){ localStorage.setItem(k, JSON.stringify(v)); },
  del(k){ localStorage.removeItem(k); }
};

function showError(msg){ const box=$("#errBox"); if(!box) return; box.style.display="block"; box.textContent = "Build v"+BUILD+" error:\n" + String(msg); }
window.addEventListener("error",(e)=>showError(e?.error?.stack||e?.message||e));
window.addEventListener("unhandledrejection",(e)=>showError(e?.reason?.stack||e?.reason||e));

const BG_CANDIDATES = [
  "./IMG_NightGames_full_background_logo_top.png",
  "./IMG_NightGames_full_background_logo_top.jpg",
  "./IMG_NightGames_full_background_logo_top.jpeg",
  "./IMG_full_background_logo_top.png",
  "./IMG_full_background_logo_top.jpg",
  "./IMG_full_background_logo_top.jpeg",
  "./NightGames_full_background_logo_top.png",
  "./a_digital_graphic_promotional_graphic_for_a_mobile.png"
];
function setBg(url){
  document.documentElement.style.setProperty("--bgUrl", `url('${url}')`);
}
function pickBackground(){
  let decided=false;
  for(const url of BG_CANDIDATES){
    const im = new Image();
    im.onload = () => { if(decided) return; decided=true; setBg(url); window.__ngBgChosen=url; };
    im.onerror = () => {};
    im.src = url + (url.includes("?") ? "" : ("?v=" + BUILD));
  }
}

function modal(title, bodyHtml, actions=[]){
  const bg = $("#modalBg");
  const m = $("#modal");
  bg.classList.add("show");
  m.classList.add("show");
  m.innerHTML = `
    <div class="modalTitle">${title}</div>
    <div class="modalBody">${bodyHtml}</div>
    <div class="modalActions">
      ${actions.map(a=>`<button class="btn sm" id="${a.id}" type="button">${a.label}</button>`).join("")}
    </div>
  `;
  const close = () => { bg.classList.remove("show"); m.classList.remove("show"); m.innerHTML=""; };
  bg.onclick = close;
  actions.forEach(a=>{
    const btn = document.getElementById(a.id);
    if(btn) btn.onclick = async () => { const r = await a.onClick(close); if(r !== false) close(); };
  });
}

// Firebase init
const fb={app:null,auth:null,db:null}; let fbReady=false;
async function fbInitOnce(){
  if(fbReady) return;
  if(!firebaseConfig?.apiKey) throw new Error("firebaseConfig missing.");
  if(!firebase.apps.length) firebase.initializeApp(firebaseConfig);
  fb.app=firebase.app(); fb.auth=firebase.auth(); fb.db=firebase.firestore(); fbReady=true;
}
async function fbEnsureAnon(){
  await fbInitOnce();
  if(fb.auth.currentUser) return fb.auth.currentUser;
  const cred = await fb.auth.signInAnonymously();
  return cred.user;
}

// Players & presence
async function playersLoadAll(){
  await fbEnsureAnon();
  const snap=await fb.db.collection("players").get();
  return snap.docs.map(d=>d.data()).filter(Boolean).map(p=>({email:normEmail(p.email),name:normName(p.name,p.email),locked:!!p.locked})).filter(p=>p.email);
}
async function playerUpsert(email,name,extra={}){
  await fbEnsureAnon();
  email=normEmail(email); name=normName(name,email);
  await fb.db.collection("players").doc(email).set({email,name,updatedAt:firebase.firestore.FieldValue.serverTimestamp(),...extra},{merge:true});
  return {email,name};
}
const presence={map:new Map(),unsub:null,timer:null};
function stopPresence(){
  if(presence.unsub) try{presence.unsub();}catch{}
  presence.unsub=null;
  if(presence.timer) clearInterval(presence.timer);
  presence.timer=null;
  presence.map.clear();
}
function isOnline(email){
  const p=presence.map.get(normEmail(email));
  return p ? ((nowMs()-Number(p.lastSeenMs||0))<=90000) : false;
}
async function startPresence(me){
  await fbEnsureAnon();
  stopPresence();
  const email=normEmail(me.email);
  if(!email) return;
  const ref=fb.db.collection("presence").doc(email);
  async function ping(){ try{ await ref.set({email,name:me.name||"",lastSeenMs:nowMs(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()},{merge:true}); }catch{} }
  await ping();
  presence.timer=setInterval(ping,25000);
  presence.unsub=fb.db.collection("presence").onSnapshot((snap)=>{
    presence.map.clear();
    snap.forEach(doc=>{ const d=doc.data()||{}; if(d.email) presence.map.set(normEmail(d.email),d); });
    if(App.route==="hub") renderHub();
  }, (err)=>showError(err?.message||err));
}

// Matches (minimal for hub list + join/create)
const MATCH_MAX_PLAYERS=8;
function gameLabel(key){
  if(key==="cricket") return "Cricket";
  if(key==="shanghai") return "Shanghai";
  if(key==="killer") return "Killer";
  if(key==="around") return "Around The World";
  if(key==="01-301") return "01 (301)";
  if(key==="01-501") return "01 (501)";
  if(key==="01-701") return "01 (701)";
  if(key==="01") return "01";
  return key || "Game";
}
function gameType(key){
  if(key==="cricket") return "cricket";
  if(key==="shanghai") return "shanghai";
  if(key==="killer") return "killer";
  if(key==="around") return "around";
  if(String(key).startsWith("01-")) return "01";
  return "unknown";
}
function gameStart(key){ if(key==="01-301") return 301; if(key==="01-501") return 501; if(key==="01-701") return 701; return 501; }

function makeInitialGameState(match){
  const t=gameType(match.game);
  const ps=(match.players||[]).map(p=>({email:normEmail(p.email),name:p.name||p.email}));
  if(t==="01"){ const start=gameStart(match.game); return {type:"01",version:1,createdMs:nowMs(),start,turnIndex:0,scores:Object.fromEntries(ps.map(p=>[p.email,start])),history:[],winnerEmail:null}; }
  if(t==="cricket"){ return {type:"cricket",version:1,createdMs:nowMs(),turnIndex:0,marks:{},score:Object.fromEntries(ps.map(p=>[p.email,0])),log:[]}; }
  if(t==="shanghai"){ return {type:"shanghai",version:1,createdMs:nowMs(),round:1,turnIndex:0,total:Object.fromEntries(ps.map(p=>[p.email,0])),history:[]}; }
  if(t==="around"){ return {type:"around",version:1,createdMs:nowMs(),target:1,turnIndex:0,progress:Object.fromEntries(ps.map(p=>[p.email,1])),history:[],winnerEmail:null}; }
  if(t==="killer"){ return {type:"killer",version:1,createdMs:nowMs(),turnIndex:0,nums:Object.fromEntries(ps.map(p=>[p.email,null])),lives:Object.fromEntries(ps.map(p=>[p.email,3])),history:[],winnerEmail:null}; }
  return {type:"unknown",createdMs:nowMs()};
}
async function matchCreate(gameKey, me){
  await fbEnsureAnon();
  const ref=fb.db.collection("matches").doc();
  const match={id:ref.id,game:gameKey,gameType:gameType(gameKey),status:"open",maxPlayers:MATCH_MAX_PLAYERS,players:[{email:me.email,name:me.name}],
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),updatedAt:firebase.firestore.FieldValue.serverTimestamp()};
  match.gameState=makeInitialGameState(match);
  await ref.set(match);
  return ref.id;
}
async function matchJoin(id, me){
  await fbEnsureAnon();
  const ref=fb.db.collection("matches").doc(id); const meE=normEmail(me.email);
  await fb.db.runTransaction(async(tx)=>{
    const snap=await tx.get(ref); if(!snap.exists) throw new Error("Match not found");
    const m=snap.data()||{}; const ps=Array.isArray(m.players)?m.players:[];
    if(ps.some(p=>normEmail(p.email)===meE)) return;
    const maxP=Number(m.maxPlayers||MATCH_MAX_PLAYERS); if(ps.length>=maxP) throw new Error("Match full (max "+maxP+")");
    ps.push({email:meE,name:me.name});
    const gs=m.gameState || makeInitialGameState({game:m.game,players:ps});
    tx.update(ref,{players:ps,gameState:gs,status:(ps.length>=2)?"active":"open",updatedAt:firebase.firestore.FieldValue.serverTimestamp()});
  });
}

let unsubMatches=null;
function stopMatchesList(){ if(unsubMatches) try{unsubMatches();}catch{} unsubMatches=null; }
async function startMatchesList(){
  await fbEnsureAnon();
  stopMatchesList();
  unsubMatches=fb.db.collection("matches").where("status","in",["open","active"]).orderBy("updatedAt","desc").limit(60).onSnapshot((snap)=>{
    App.matches=snap.docs.map(d=>d.data()).filter(Boolean).map(m=>({id:m.id,game:m.game,gameType:m.gameType||gameType(m.game),status:m.status||"open",maxPlayers:Number(m.maxPlayers||MATCH_MAX_PLAYERS),players:Array.isArray(m.players)?m.players:[]}));
    if(App.route==="hub") renderHub();
  }, (err)=>showError(err?.message||err));
}

// Router
const App={route:"auth",me:null,players:[],matches:[]};
function setRoute(r){ App.route=r; render(); }
function setHtml(h){ $("#app").innerHTML=h; }
function render(){ if(App.route==="auth") return renderAuth(); if(App.route==="hub") return renderHub(); App.route="auth"; return renderAuth(); }

function gameCard(key,title,sub,tag="Tap"){
  return `
    <div class="gcard" data-game="${key}" style="cursor:pointer">
      <div class="gtitle">${title}</div>
      <div class="gsub">${sub}</div>
      <div class="gactions">
        <button class="btn sm" type="button">Create</button>
        <div class="chip">${tag}</div>
      </div>
    </div>`;
}

function renderAuth(){
  setHtml(`
    <div class="stage">
      <div class="ngModule hero">
        <div class="sub">Email sign-in to enter Night Games.</div>
        <div style="height:12px"></div>
        <input id="inEmail" class="input" type="email" placeholder="you@example.com" autocomplete="email" inputmode="email"/>
        <div style="height:12px"></div>
        <button id="btnEnter" class="btn" type="button">ENTER</button>
        <div style="height:10px"></div>
        <div id="authHint" class="sub" style="min-height:18px"></div>
      </div>
    </div>
  `);
  const hint=$("#authHint"); const setHint=(t)=>{ if(hint) hint.textContent=t||""; };
  const emailEl=$("#inEmail"); const saved=store.get("me",null); if(saved?.email) emailEl.value=saved.email;

  async function enterFlow(){
    try{
      const email=normEmail(emailEl.value);
      if(!email){ alert("Enter your email"); setHint("Email required."); return; }
      setHint("Connecting...");
      await fbEnsureAnon();
      setHint("Loading players...");
      App.players = await playersLoadAll();
      let me = App.players.find(p=>p.email===email);
      if(!me){
        setHint("New player ‚Äî enter name");
        modal("New Player",`
          <div class="sub">Enter your name for <b>${esc(email)}</b></div>
          <div style="height:10px"></div>
          <input id="inName" class="input" placeholder="Your name" />
        `,[{id:"saveName",label:"Save",onClick:async()=>{
          const name=normName($("#inName").value,email);
          if(!name){ alert("Name required"); return false; }
          setHint("Saving...");
          await playerUpsert(email,name);
          App.players = await playersLoadAll();
          me = App.players.find(p=>p.email===email) || {email,name};
          App.me = {email:me.email,name:me.name};
          store.set("me",{email:me.email,name:me.name,ts:nowMs()});
          await startPresence(App.me);
          await startMatchesList();
          setRoute("hub");
        }}]);
        return;
      }
      App.me={email:me.email,name:me.name};
      store.set("me",{email:me.email,name:me.name,ts:nowMs()});
      await startPresence(App.me);
      await startMatchesList();
      setHint("Entering...");
      setRoute("hub");
    }catch(err){
      showError(err?.stack||err?.message||err);
      setHint("Error. See red box.");
    }
  }
  $("#btnEnter").onclick=enterFlow;
  emailEl.onkeydown=(e)=>{ if(e.key==="Enter") enterFlow(); };
  window.__ngEnterFlow = window.__ngEnterFlow || {};
  window.__ngEnterFlow.go = enterFlow;
  window.__ngEnterFlow.onStart = enterFlow;
  window.ngEnterFlow = enterFlow;
}

function renderHub(){
  const me = App.me || store.get("me", null);
  if(!me?.email){ setRoute("auth"); return; }
  App.me={email:normEmail(me.email),name:normName(me.name,me.email)};

  const matches = App.matches || [];
  const players = (App.players||[]).slice().sort((a,b)=>a.name.localeCompare(b.name));

  setHtml(`
    <div class="stage">
      <div class="ngModule">
        <div class="topbar">
          <div class="bigName">Welcome, ${esc(App.me.name)}</div>
          <div class="row">
            <div class="chip">${esc(App.me.email)}</div>
            <button id="btnSignOut" class="btn sm danger" type="button">Sign out</button>
          </div>
        </div>
        <div class="sub">Choose a game, create a match, then others join.</div>
      </div>

      <div class="ngModule">
        <div class="h2">Games</div>
        <div class="sub">01 includes 701/501/301 selection.</div>
        <div class="cards">
          ${gameCard("01","01","Pick 701 / 501 / 301","Choose")}
          ${gameCard("cricket","Cricket","Close 15‚Äì20 + Bull and score extras.","Tap")}
          ${gameCard("shanghai","Shanghai","Rounds 1‚Äì20 + Bull. Single+Double+Triple = Shanghai!","Tap")}
          ${gameCard("around","Around The World","Hit 1‚Üí20‚ÜíBull. First to finish wins.","Tap")}
          ${gameCard("killer","Killer","Pick a number. Hit others to reduce lives.","Tap")}
        </div>
      </div>

      <div class="ngModule">
        <div class="h2">Players</div>
        <div class="sub">Green dot = active within ~90 seconds.</div>
        <div class="list">
          ${players.map(p=>`
            <div class="playerRow">
              <div class="left">
                <div class="dot ${isOnline(p.email)?"on":""}"></div>
                <div class="pmeta">
                  <div class="pname">${esc(p.name)}</div>
                  <div class="pemail">${esc(p.email)}</div>
                </div>
              </div>
              <div class="chip">${p.locked?"Locked":"Ready"}</div>
            </div>
          `).join("")}
        </div>
      </div>

      <div class="ngModule">
        <div class="h2">Open Matches</div>
        <div class="sub">Tap a match to join (up to ${MATCH_MAX_PLAYERS} players).</div>
        <div class="list">
          ${matches.length ? matches.map(m=>`
            <div class="playerRow" data-mid="${m.id}" style="cursor:pointer">
              <div class="left">
                <div class="pmeta">
                  <div class="pname">${esc(gameLabel(m.game))} ‚Ä¢ ${esc(m.status)} ‚Ä¢ ${(m.players||[]).length}/${m.maxPlayers||MATCH_MAX_PLAYERS}</div>
                  <div class="pemail">${(m.players||[]).map(p=>esc(p.name||p.email)).join(" vs ")}</div>
                </div>
              </div>
              <div class="chip">Join</div>
            </div>
          `).join("") : `<div class="sub">No open matches yet.</div>`}
        </div>
      </div>
    </div>
  `);

  $("#btnSignOut").onclick = () => {
    store.del("me");
    App.me=null;
    stopMatchesList(); stopPresence();
    setRoute("auth");
  };

  $$("[data-game]", $("#app")).forEach(el=>{
    el.onclick = async () => {
      try {
        const key = el.getAttribute("data-game");
        if(key === "01") {
          modal("01 Game", `
            <div class="sub">Choose a starting score:</div>
            <div style="height:10px"></div>
            <div class="row">
              <button class="btn sm" id="g701" type="button">701</button>
              <button class="btn sm" id="g501" type="button">501</button>
              <button class="btn sm" id="g301" type="button">301</button>
            </div>
          `, []);
          setTimeout(()=>{
            $("#g701").onclick = async ()=>{ await matchCreate("01-701", App.me); };
            $("#g501").onclick = async ()=>{ await matchCreate("01-501", App.me); };
            $("#g301").onclick = async ()=>{ await matchCreate("01-301", App.me); };
          }, 0);
          return;
        }
        await matchCreate(key, App.me);
      } catch (err) {
        showError(err?.stack || err?.message || err);
      }
    };
  });

  $$("[data-mid]", $("#app")).forEach(el=>{
    el.onclick = async () => {
      try {
        const mid = el.getAttribute("data-mid");
        await matchJoin(mid, App.me);
      } catch (err) {
        showError(err?.stack || err?.message || err);
      }
    };
  });
}

async function boot(){
  try{
    pickBackground();
    setRoute("auth");
    await fbEnsureAnon();
    App.players = await playersLoadAll();
    const saved = store.get("me", null);
    if(saved?.email){
      App.me={email:normEmail(saved.email),name:normName(saved.name,saved.email)};
      await startPresence(App.me);
      await startMatchesList();
      setRoute("hub");
    }
  }catch(err){
    showError(err?.stack||err?.message||err);
    setRoute("auth");
  }
}
document.addEventListener("DOMContentLoaded", boot);
})();
</script>
</body>
</html>
