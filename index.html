<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Night Games v718 (Enter Restored Baseline)</title>
  <style>
    :root{
      --bgStage: url("./IMG_7315.jpeg");
      --maxW: 760px;
      --uiW: min(var(--maxW), calc(100vw - 24px));
      --txt: rgba(245,250,255,.94);
      --fieldFill: rgba(255,255,255,.035);
      --zShadow: drop-shadow(0 22px 46px rgba(0,0,0,.72));
      --zShadowSoft: drop-shadow(0 10px 22px rgba(0,0,0,.55));
    }

    html, body{
      height:100%;
      margin:0;
      background:#000;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow:hidden;
      -webkit-text-size-adjust: 100%;
    }

    .buildBadge{
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      font-weight: 1000;
      letter-spacing: 1px;
      font-size: 12px;
      text-transform: uppercase;
      pointer-events: none;
      box-shadow: 0 10px 22px rgba(0,0,0,.55);
    }
    .buildBadge b{ color: rgba(0,210,255,.95); }

    /* Debug panel (toggle) */
    .dbg{
      position: fixed;
      top: 10px;
      right: 10px;
      z-index: 9999;
      background: rgba(0,0,0,.45);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.45);
      overflow:hidden;
      max-width: min(340px, calc(100vw - 24px));
    }
    .dbgHead{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dbgHead span{
      font-size: 12px;
      font-weight: 1000;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: .92;
    }
    .dbgHead b{ color: rgba(90,255,170,.92); }
    .dbgBody{
      display:none;
      padding: 10px 12px 12px 12px;
      font-size: 12px;
      line-height: 1.4;
      opacity: .9;
    }
    .dbg.open .dbgBody{ display:block; }
    .kv{ display:flex; justify-content: space-between; gap:10px; }
    .kv code{ opacity:.95; }
    .warn{ color: rgba(255,210,90,.95); }
    .bad{ color: rgba(255,120,120,.95); }
    .ok{ color: rgba(90,255,170,.95); }

    #app{ position:fixed; inset:0; }
    .screen{ position:absolute; inset:0; display:none; }
    .screen.active{ display:block; }

    .screen::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--bgStage);
      background-repeat:no-repeat;
      background-size:cover;
      background-position: center bottom;
    }
    .screen::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(130% 110% at 50% 25%, rgba(0,0,0,0), rgba(0,0,0,.22) 60%, rgba(0,0,0,.52) 100%);
      pointer-events:none;
    }

    /* ===== Landing ===== */
    .landingUI{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(320px, 48vh, 590px);
      display:grid;
      gap: 14px;
      justify-items:center;
      z-index:2;
    }

    .field3d, .btn3d{
      width: min(640px, 92vw);
      height: 72px;
      border-radius: 22px;
      transform: translateZ(0);
      filter: var(--zShadow);
      background: var(--fieldFill);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.45),
        inset 0 -14px 22px rgba(0,0,0,.60),
        0 0 18px rgba(0,210,255,.10);
      position:relative;
      overflow:hidden;
    }
    .field3d::before, .btn3d::before{
      content:"";
      position:absolute;
      inset: 10px 12px auto 12px;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,.52), rgba(255,255,255,0));
      opacity: .42;
      pointer-events:none;
    }
    .field3d input{
      width:100%;
      height:100%;
      border:0;
      outline:none;
      background:transparent;
      color: rgba(255,255,255,.95);
      font-size: 18px;
      letter-spacing: .6px;
      padding: 0 20px;
      box-sizing:border-box;
      -webkit-appearance:none;
      appearance:none;
    }
    .field3d input::placeholder{ color: rgba(235,245,255,.55); }

    /* iOS Safari yellow autofill kill */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-text-fill-color: rgba(255,255,255,.95) !important;
      caret-color: rgba(255,255,255,.95);
      transition: background-color 99999s ease-out 0s;
      -webkit-box-shadow: 0 0 0px 1000px var(--fieldFill) inset !important;
      box-shadow: 0 0 0px 1000px var(--fieldFill) inset !important;
      border-radius: 22px;
    }

    .btn3d{
      cursor:pointer;
      color: rgba(255,255,255,.96);
      font-weight: 1000;
      font-size: 28px;
      letter-spacing: 2px;
      text-transform: uppercase;
      transition: transform .07s ease, filter .07s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn3d:active{ transform: translateY(2px) scale(.995); filter: var(--zShadowSoft); }

    .hint{
      font-size: 12px;
      opacity: .78;
      text-align:center;
      max-width: min(640px, 92vw);
      line-height: 1.35;
    }

    /* ===== Hub ===== */
    .hub{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(220px, 30vh, 340px);
      bottom: max(120px, env(safe-area-inset-bottom));
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: 18px;
      padding: 0 12px;
      box-sizing:border-box;
      z-index:2;
    }

    .panel{
      position:relative;
      border-radius: 22px;
      background: rgba(255,255,255,.03);
      border: none;
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.38),
        inset 0 -14px 22px rgba(0,0,0,.62),
        0 0 18px rgba(0,210,255,.10);
      overflow:hidden;
      filter: var(--zShadowSoft);
    }

    .sectionHead{ padding: 12px 14px 10px 14px; }

    .title{
      font-weight: 1000;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-size: clamp(22px, 3.0vh, 30px);
      position: relative;
      padding-bottom: 6px;
      width: 100%;
      background: linear-gradient(180deg,
        rgba(210,245,255,.96) 0%,
        rgba(90,210,255,.92) 35%,
        rgba(235,250,255,.98) 70%,
        rgba(120,225,255,.88) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-stroke: 0.7px rgba(255,255,255,.18);
      text-shadow:
        0 1px 0 rgba(255,255,255,.22),
        0 -2px 10px rgba(0,0,0,.70),
        0 0 22px rgba(0,210,255,.18);
    }
    .title::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:2px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(0,210,255,.55), rgba(255,175,0,.40), rgba(0,210,255,.10));
      opacity:.75;
    }

    .list{
      position:absolute;
      left: 0; right: 0;
      top: 54px; bottom: 0;
      padding: 10px 12px 14px 12px;
      box-sizing: border-box;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .itemLine{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 4px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .leftStack{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .glassText{
      font-weight: 1000;
      font-size: clamp(22px, 2.8vh, 30px);
      letter-spacing: .6px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      background: linear-gradient(180deg, rgba(255,255,255,.98), rgba(210,245,255,.78) 40%, rgba(255,255,255,.92));
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-stroke: 0.6px rgba(255,255,255,.22);
      text-shadow:
        0 1px 0 rgba(255,255,255,.35),
        0 -2px 10px rgba(0,0,0,.70),
        0 0 14px rgba(0,210,255,.10);
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .dot.online{
      background: rgba(90,255,170,.92);
      box-shadow: 0 0 10px rgba(90,255,170,.35), 0 0 0 1px rgba(90,255,170,.28);
    }

    .actions{ display:flex; gap:8px; flex:0 0 auto; }

    .pill{
      border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.95);
      border-radius: 999px;
      padding: 9px 11px;
      font-size: 12px;
      font-weight: 1000;
      letter-spacing: .8px;
      text-transform: uppercase;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.28),
        inset 0 -10px 16px rgba(0,0,0,.55),
        0 0 16px rgba(0,210,255,.08);
      transition: transform .07s ease, filter .07s ease;
    }
    .pill:active{
      transform: translateY(2px) scale(.99);
      filter: var(--zShadowSoft);
    }

    .detailWrap{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(220px, 30vh, 340px);
      bottom: max(120px, env(safe-area-inset-bottom));
      z-index: 2;
      display:grid;
      grid-template-rows: 1fr auto;
      gap: 18px;
      padding: 0 12px;
      box-sizing:border-box;
    }
    .detailBody{
      padding: 14px 14px 18px 14px;
      line-height: 1.55;
      font-size: 18px;
      opacity: .92;
    }

    .fatal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.82);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 99999;
    }
    .fatal .card{
      width: min(720px, 92vw);
      border-radius: 22px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 46px rgba(0,0,0,.55);
      padding: 16px 16px 18px 16px;
    }
    .fatal h2{ margin:0 0 8px 0; font-size: 18px; letter-spacing:1px; text-transform: uppercase; }
    .fatal p{ margin:0 0 10px 0; opacity:.88; line-height:1.45; }
    .fatal pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 12px;
      opacity: .9;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 12px;
      border-radius: 14px;
    }
  
    /* v718: header row + mini pill */
    .headerRow{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
    .pillMini{
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 1px;
      height: 34px;
      align-self: center;
    }

  
    /* v718: session indicator */
    .sessionPill{
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 1px;
      height: 34px;
      align-self: center;
      opacity: .92;
    }
    .sessionPill.live{
      border-color: rgba(90,255,170,.55);
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.28),
        inset 0 -10px 16px rgba(0,0,0,.55),
        0 0 16px rgba(90,255,170,.12);
    }

  
    /* v718 layout lock: micro vertical drop */
    .appWrap, .screen, .landing, .players {
        transform: translateY(20px);
    }


    /* v718 layout lock adjustment: additional micro drop */
    .appWrap, .screen, .landing, .players {
        transform: translateY(20px);
    }


    /* v718 ATW emoji: keep color + one-line */
    .gameLabelWrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      white-space:nowrap;
    }
    .emojiGlobe{
      display:inline-block;
      font-size: 18px;
      line-height: 1;
      color: initial !important;
      background: none !important;
      -webkit-text-fill-color: initial !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      filter: drop-shadow(0 0 10px rgba(120,200,255,.18));
    }

</style>
</head>
<body>
  <div class="buildBadge">Build <b>v718</b> â€¢ Firebase</div>

  <div class="dbg" id="dbg">
    <div class="dbgHead" id="dbgHead">
      <span>Debug <b id="dbgState">INIT</b></span>
      <span style="opacity:.7;">tap</span>
    </div>
    <div class="dbgBody" id="dbgBody">
      <div class="kv"><span>URL</span><code id="dbgUrl"></code></div>
      <div class="kv"><span>Auth</span><code id="dbgAuth"></code></div>
      <div class="kv"><span>Firestore</span><code id="dbgFs"></code></div>
      <div class="kv"><span>Last error</span><code id="dbgErr" class="warn">none</code></div>
      <div style="margin-top:8px; opacity:.8;">If anything fails on iPhone, this box tells us exactly what.</div>
    </div>
  </div>

  <div id="app">
    <section id="landing" class="screen active">
      <div class="landingUI">
        <div class="field3d">
          <input id="emailInput" type="email" placeholder="Enter your email" autocomplete="email" inputmode="email"/>
        </div>
        <button id="enterBtn" class="btn3d" type="button">Enter</button>
        <div class="hint" id="statusLine">Email-only sign-in (no password). Firebase stable build.</div>
      </div>
    </section>

    <section id="players" class="screen">
      <div class="hub">
        <div class="panel">
          <div class="sectionHead headerRow">
            <div class="title">Games</div>
            <div style="display:flex; gap:10px; align-items:center;"><button class="pill pillMini sessionPill" id="sessionBtn" data-action="show_session" type="button" style="display:none;">Session</button></div>
          </div>
          <div class="list" id="gamesList"></div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Players</div></div>
          <div class="list" id="playersList"></div>
        </div>
      </div>
    </section>

    
    
    <section id="setup" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title">Setup</div></div>
          <div class="detailBody" id="setupBody">
            <div style="opacity:.82;">Setup screen is installed. Wiring comes next.</div>
          </div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Controls</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="setupBackBtn" type="button">Back</button>
          </div>
        </div>
      </div>
    </section>


    <section id="lobby" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title" id="lobbyTitle">Lobby</div></div>
          <div class="detailBody" id="lobbyBody">Loadingâ€¦</div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Controls</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="lobbyBackBtn" type="button">Back</button>
            <button class="pill" id="lobbySetupBtn" type="button">Setup</button>
            <button class="pill" id="lobbyStartBtn" type="button" style="display:none;">Start</button>
            <button class="pill" id="lobbyEndBtn" type="button" style="display:none;">End</button>
          </div>
        </div>
      </div>
    </section>


    <section id="detail" class="screen">
      <div class="detailWrap">
        <div class="panel">
          <div class="sectionHead"><div class="title" id="detailTitle">Detail</div></div>
          <div class="detailBody" id="detailBody">Loadingâ€¦</div>
        </div>
        <div class="panel">
          <div class="sectionHead"><div class="title">Navigation</div></div>
          <div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="backBtn" type="button">Back</button>
            <button class="pill" id="homeBtn" type="button">Home</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <div class="fatal" id="fatal">
    <div class="card">
      <h2>Firebase didnâ€™t start</h2>
      <p>This page uses Firebase modules. If youâ€™re on a web link and still see this, the host is blocking module imports or Firebase is blocked.</p>
      <pre id="fatalMsg">No details.</pre>
    </div>
  </div>

  <script nomodule>
    // Very old browsers only
    document.getElementById("fatal").style.display = "flex";
    document.getElementById("fatalMsg").textContent = "Your browser doesnâ€™t support ES Modules. Use a modern Safari/Chrome.";
  </script>

  <script>
    // Debug UI toggle
    (function(){
      const dbg = document.getElementById("dbg");
      const head = document.getElementById("dbgHead");
      head.addEventListener("click", ()=> dbg.classList.toggle("open"));
      document.getElementById("dbgUrl").textContent = location.href.slice(0, 48) + (location.href.length>48 ? "â€¦" : "");
    })();
  </script>

  <script type="module">
    // ===== Firebase (stable) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, setDoc, getDoc,
      collection, onSnapshot,
      serverTimestamp, query
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const dbgState = document.getElementById("dbgState");
    const dbgAuth = document.getElementById("dbgAuth");
    const dbgFs = document.getElementById("dbgFs");
    const dbgErr = document.getElementById("dbgErr");
    function setDbg(state, auth, fs, err){
      if(state) dbgState.textContent = state;
      if(auth) dbgAuth.textContent = auth;
      if(fs) dbgFs.textContent = fs;
      if(err) dbgErr.textContent = err;
    }

    const fatal = document.getElementById("fatal");
    const fatalMsg = document.getElementById("fatalMsg");
    function failHard(msg, err){
      console.error(msg, err);
      fatal.style.display = "flex";
      fatalMsg.textContent = msg + (err ? ("\n\n" + (err.stack||err.message||String(err))) : "");
      setDbg("FAIL", "â€”", "â€”", msg);
    }

    // ===== Config (from Steven) =====
    const firebaseConfig = {
      apiKey: "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo",
      authDomain: "gamenightdarts-e7601.firebaseapp.com",
      projectId: "gamenightdarts-e7601",
      storageBucket: "gamenightdarts-e7601.firebasestorage.app",
      messagingSenderId: "270045452251",
      appId: "1:270045452251:web:393956ce18b43316e939fe",
      measurementId: "G-LQEHF02ZVR"
    };

    // ===== UI refs =====
    const landing = document.getElementById("landing");
    const players = document.getElementById("players");
    const detail = document.getElementById("detail");
    const emailInput = document.getElementById("emailInput");
    const enterBtn = document.getElementById("enterBtn");
    const gamesList = document.getElementById("gamesList");
    const playersList = document.getElementById("playersList");
    const detailTitle = document.getElementById("detailTitle");
    const detailBody = document.getElementById("detailBody");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const statusLine = document.getElementById("statusLine");
    const setup = document.getElementById("setup");
    const setupBackBtn = document.getElementById("setupBackBtn");
    const lobbySetupBtn = document.getElementById("lobbySetupBtn");
    const lobby = document.getElementById("lobby");
    const lobbyTitle = document.getElementById("lobbyTitle");
    const lobbyBody = document.getElementById("lobbyBody");
    const lobbyBackBtn = document.getElementById("lobbyBackBtn");
    const lobbyStartBtn = document.getElementById("lobbyStartBtn");
    const lobbyEndBtn = document.getElementById("lobbyEndBtn");
    const sessionBtn = document.getElementById("sessionBtn");

    function show(which){
      landing.classList.toggle("active", which==="landing");
      players.classList.toggle("active", which==="players");
      setup.classList.toggle("active", which==="setup");
      lobby.classList.toggle("active", which==="lobby");
      detail.classList.toggle("active", which==="detail");
    }
    function openDetail(title, html){
      detailTitle.textContent = title;
      detailBody.innerHTML = html;
      show("detail");
    }

    // ===== Click sound (iPhone safe) =====
    let audioCtx = null;
    function ensureAudio(){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();
    }
    function clickSound(){
      try{
        ensureAudio();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "triangle";
        osc.frequency.setValueAtTime(680, t);
        osc.frequency.exponentialRampToValueAtTime(260, t + 0.07);
        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.exponentialRampToValueAtTime(0.22, t + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.09);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(t);
        osc.stop(t + 0.10);
      }catch(e){}
    }
    document.addEventListener("pointerdown", (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      clickSound();
    }, {passive:true});

    function safeEmail(email){
      return (email||"").toLowerCase().replaceAll(".", "(dot)").replaceAll("@","(at)");
    }

    const games = ["01","Cricket","Killer","Shanghai","ATW","Half It"];

    const GAME_RULES = {
      "01": "Classic x01. Start at 301/501/701 etc (we'll add selector next). Lowest to zero wins (bust rules configurable).",
      "Cricket": "20â€“15 + Bull. Close numbers then score. Team/solo rules configurable.",
      "Killer": "Assign a number, get to killer, then knock others out. (Weâ€™ll match your house rules).",
      "Shanghai": "Each round targets a number. Shanghai = single+double+triple in same round. (House rules).",
      "ATW ðŸŒ": "ATW: hit 1â†’20 (and bull if you want). Miss = move on / stay (house rules).",
      "Half It": "Hit the called target each round or score is halved. (House rules)."
    };

    function renderGames(){
      gamesList.innerHTML = games.map(g => `
        <div class="itemLine">
          <div class="leftStack"><div class="gameLabelWrap">${g==="ATW" ? `<span class="glassText">ATW</span><span class="emojiGlobe">ðŸŒŽ</span>` : `<span class="glassText">${g}</span>`}</div></div>
          <div class="actions">
            <button class="pill" data-action="enter_game" data-value="${g}">Enter</button>
            <button class="pill" data-action="game_history" data-value="${g}">History</button>
            
          </div>
        </div>
      `).join("");
    }

    // Seed registry (only merges; harmless)
    const SEED = [
      { email: "stevewmoody@yahoo.com", name: "Steve Moody" },
      { email: "jmoody7712@gmail.com", name: "Jayce Moody" },
      { email: "wmoody7931@aol.com", name: "Bill Moody" }
    ];
    async function seedRegistry(db){
      for(const u of SEED){
        await setDoc(doc(db, "registry", safeEmail(u.email)), {
          email: u.email.toLowerCase(),
          name: u.name,
          createdAt: serverTimestamp()
        }, { merge: true });
      }
    }

    let currentEmail = null;
    let currentUid = null;
    let presenceTimer = null;
    let presenceMap = new Map(); // id -> lastActiveMillis

    let lastPeople = []; // cached registry list for re-render on presence updates


    function renderPlayers(list){
      playersList.innerHTML = list.map(p => {
        const id = safeEmail(p.email);
        const last = presenceMap.get(id) || 0;
        const online = (p.email || "").toLowerCase() === (currentEmail || "").toLowerCase() || ((Date.now() - last) < 25000);
        return `
          <div class="itemLine">
            <div class="leftStack">
              <span class="dot ${online ? "online" : ""}"></span>
              <span class="glassText">${p.name}</span>
            </div>
            <div class="actions">
              <button class="pill" data-action="player_stats" data-value="${p.email}">Stats</button>
              <button class="pill" data-action="player_history" data-value="${p.email}">History</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function watchData(db){
      // registry
      onSnapshot(query(collection(db, "registry")), (snap)=>{
        const people = snap.docs.map(d => d.data()).filter(x=>x && x.email && x.name);
        people.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
        lastPeople = people;
        renderPlayers(people);
        setDbg("OK", dbgAuth.textContent || "â€”", "registry live", dbgErr.textContent || "none");
      }, (err)=>{
        setDbg("FAIL", dbgAuth.textContent || "â€”", "registry fail", err.code || err.message || String(err));
      });

      // presence
      onSnapshot(query(collection(db, "presence")), (snap)=>{
        const m = new Map();
        snap.docs.forEach(d => {
          const data = d.data() || {};
          const ts = data.lastActive;
          let ms = 0;
          try{
            ms = ts && typeof ts.toMillis === "function" ? ts.toMillis() : Date.now();
          }catch(_e){ ms = Date.now(); }
          m.set(d.id, ms);
        });
        presenceMap = m;
      }, (err)=>{
        setDbg("FAIL", dbgAuth.textContent || "â€”", "presence fail", err.code || err.message || String(err));
      });

      // dot refresh
      setInterval(()=>{
        // re-render quickly by triggering minimal update if list already rendered
        const rows = playersList.querySelectorAll(".itemLine");
        if(!rows.length) return;
        rows.forEach((row)=>{
          const nameEl = row.querySelector(".glassText");
          const dot = row.querySelector(".dot");
          if(!nameEl || !dot) return;
          const name = nameEl.textContent || "";
          // find matching registry entry by name is not safe; we keep last state until next snapshot.
          // presence updates will come through snapshot anyway.
        });
      }, 2000);
    }

    async function startPresence(db){
      if(!currentEmail || !currentUid) return;
      const id = safeEmail(currentEmail);
      const ref = doc(db, "presence", id);
      async function tick(){
        await setDoc(ref, {
          email: currentEmail,
          uid: currentUid,
          lastActive: serverTimestamp()
        }, { merge: true });
        // optimistic: show online immediately
        try { presenceMap.set(id, Date.now()); if(lastPeople && lastPeople.length) renderPlayers(lastPeople); } catch(e) {}
      }
      await tick();
      clearInterval(presenceTimer);
      presenceTimer = setInterval(()=> tick().catch(()=>{}), 5000);
    }

    async function signInFlow(auth, db, email){
      currentEmail = (email||"").trim().toLowerCase();
      if(!currentEmail) return;

      statusLine.textContent = "Signing inâ€¦";
      setDbg("AUTH", "startingâ€¦", "â€”", dbgErr.textContent || "none");

      // 1) Auth (anonymous)
      const cred = await signInAnonymously(auth);
      currentUid = cred.user.uid;
      dbgAuth.textContent = "anon uid " + currentUid.slice(0,6) + "â€¦";

      // 2) Seed registry
      await seedRegistry(db);

      // 3) Verify registration
      const regRef = doc(db, "registry", safeEmail(currentEmail));
      const regSnap = await getDoc(regRef);
      if(!regSnap.exists()) {
        statusLine.textContent = "Not registered.";
        setDbg("FAIL", dbgAuth.textContent, "registry miss", "not registered: " + currentEmail);
        alert("Email not registered yet.");
        return;
      }

      // 4) Write user record (optional)
      await setDoc(doc(db, "users", currentUid), {
        email: currentEmail,
        lastLogin: serverTimestamp()
      }, { merge: true });

      // 5) Presence + live listeners
      try { presenceMap.set(safeEmail(currentEmail), Date.now()); } catch(e) {}
      await startPresence(db);
      renderGames();
      watchData(db);
      show("players");
      statusLine.textContent = "Signed in.";
      setDbg("OK", dbgAuth.textContent, "connected", "none");
    }

    // Start Firebase and wire handlers
    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

    // v718 Multiplayer
    const ROOM_ID = "dart-room";
    let activeSessionId = null;
    let activeGame = null;
    let activeHost = null;

      setDbg("INIT", "ready", "ready", "none");

      onAuthStateChanged(auth, (u)=>{
        if(u) dbgAuth.textContent = "anon uid " + u.uid.slice(0,6) + "â€¦";
      });

      function onEnter() {
        signInFlow(auth, db, emailInput.value).catch((err)=>{
          const msg = err?.code || err?.message || String(err);
          statusLine.textContent = "Firebase error.";
          setDbg("FAIL", dbgAuth.textContent || "â€”", "fail", msg);
          alert("Firebase error: " + msg);
        });
      }
      enterBtn.addEventListener("click", onEnter);
      emailInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); onEnter(); }
      });

          document.addEventListener("click", async (e)=>{
      const b = e.target.closest(".pill");
      if(!b) return;

      const action = b.dataset.action;
      const value = b.dataset.value || "";

      if(action === "game_rules"){
        const txt = (GAME_RULES[value] || "Rules coming soon.");
        openDetail("RULES â€¢ " + value, `
          <div style="font-weight:1000; font-size:22px; margin-bottom:8px;">${value}</div>
          <div style="opacity:.82; font-size:14px; line-height:1.55;">${txt}</div>
        `);
        return;
      }


      // Global rules list
      if(action === "show_rules"){
        const list = Object.entries(GAME_RULES).map(([k,v]) => `
          <div style="margin: 0 0 14px 0;">
            <div style="font-weight:1000; font-size:20px; margin-bottom:4px;">${k}</div>
            <div style="opacity:.78; font-size:14px; line-height:1.45;">${v}</div>
          </div>
        `).join("");
        openDetail("RULES", `<div>${list}</div>`);
        return;
      }

      // Per-game rules
      if(action === "game_rules"){
        const txt = (GAME_RULES[value] || "Rules coming soon.");
        openDetail("RULES â€¢ " + value, `
          <div style="font-weight:1000; font-size:22px; margin-bottom:8px;">${value}</div>
          <div style="opacity:.82; font-size:14px; line-height:1.55;">${txt}</div>
        `);
        return;
      }

      // Enter game (multiplayer session)
      if(action === "enter_game"){
        try{
          await createSessionForGame(value);
          renderLobby();
          show("lobby");
        }catch(e){
          alert("Session error: " + (e.message||e));
        }
        return;
      }

      if(action === "game_history"){
        openDetail("GAME HISTORY", `
          <div style="font-weight:1000; font-size:26px; margin-bottom:6px;">${value}</div>
          <div style="opacity:.75;">Placeholder. Next weâ€™ll pull from Firestore.</div>
        `);
        return;
      }

      if(action === "player_stats"){
        openDetail("PLAYER STATS", `
          <div style="font-weight:1000; font-size:22px; margin-bottom:6px;">${value}</div>
          <div style="opacity:.75;">Placeholder. Next weâ€™ll pull from Firestore.</div>
        `);
        return;
      }

      if(action === "player_history"){
        openDetail("PLAYER HISTORY", `
          <div style="font-weight:1000; font-size:22px; margin-bottom:6px;">${value}</div>
          <div style="opacity:.75;">Placeholder. Next weâ€™ll pull from Firestore.</div>
        `);
        return;
      }

      if(action === "show_session"){
        if(!activeSessionId){
          openDetail("SESSION", `<div style="opacity:.78;">No active session.</div>`);
          return;
        }
        openDetail("SESSION â€¢ LIVE", `
          <div style="font-weight:1000; font-size:22px; margin-bottom:8px;">${activeGame || "Game"}</div>
          <div style="opacity:.82; font-size:14px; line-height:1.55;">
            Room: <b>${ROOM_ID}</b><br/>
            Session: <b>${activeSessionId}</b><br/>
            Host: <b>${activeHost || "â€”"}</b>
          </div>
          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="pill" data-action="join_session" type="button">Join</button>
            <button class="pill" data-action="end_session" type="button">End</button>
          </div>
        `);
        return;
      }

      if(action === "join_session"){
        try{ await joinActiveSessionIfAny(); }catch(e){}
        openDetail("JOINED", `<div style="opacity:.85;">Joined session.</div>`);
        return;
      }

      if(action === "end_session"){
        try{ await endSession(); }catch(e){}
        openDetail("SESSION ENDED", `<div style="opacity:.85;">Session ended.</div>`);
        return;
      }
    });

      backBtn.addEventListener("click", ()=> show("players"));
      homeBtn.addEventListener("click", ()=> show("landing"));

      lobbyBackBtn.addEventListener("click", ()=> show("players"));
      lobbySetupBtn.addEventListener("click", ()=> show("setup"));
      setupBackBtn.addEventListener("click", ()=> show("lobby"));
      lobbyStartBtn.addEventListener("click", ()=> startSession().catch(e=>alert(e.message||e)));
      lobbyEndBtn.addEventListener("click", ()=> endSession().catch(e=>alert(e.message||e)));


    } catch (err) {
      failHard("Firebase init failed (imports loaded but initialize failed).", err);
    }

    // If the module runs, hide the fatal overlay (in case something else turned it on)
    document.getElementById("fatal").style.display = "none";
  </script>
</body>
</html>
