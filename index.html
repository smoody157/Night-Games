<!--
================================================================================
  NIGHT GAMES v917  |  2026-02-27
================================================================================
  MASTER CLEAN BUILD (STABILITY FIRST)
  - Enter must work (email -> players) and must never regress.
  - Game -> Setup must open.
  - Setup Start must work (1 player + 2+ players).

  THIS BUILD CHANGES:
  - NO behavior changes intended.
  - Labels / section banners / edit notes only.
  - Visible version badge added.

  QUICK JUMP (Ctrl/Cmd+F):
    [EDIT_BG] [EDIT_LOGO] [EDIT_VERSION] [EDIT_COLORS] [EDIT_DROPDOWNS]
    [SECTION_CONFIG] [SECTION_FIREBASE] [SECTION_STATE] [SECTION_ROUTING]
    [SECTION_UI] [SECTION_PLAYERS] [SECTION_GAMES] [SECTION_SETUP]
    [SECTION_WAITING] [SECTION_INVITES] [SECTION_UTILS] [SECTION_DEBUG]
================================================================================
-->
<!DOCTYPE html>

<html lang="en">
<head>
<!-- ===================== v917 STABILITY SWEEP =====================
     - NO UI/layout changes
     - NO wiring changes
     - Only whitespace cleanup + version bump
     - Verified JS parses (node --check)
     =============================================================== -->

<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1, viewport-fit=cover" name="viewport"/>
<title>Night Games v917 (MASTER STABLE)</title>
<style>
/* =============================================================================
   SECTION: VISUAL THEME  [EDIT_COLORS]
   - Keep theme styles grouped here.
============================================================================= */
:root{
      --bgStage: url("https://raw.githubusercontent.com/smoody157/Night-Games/main/IMG_7390.jpeg?v=907");
      --maxW: 760px;
      --uiW: min(var(--maxW), calc(100vw - 24px));
      --txt: rgba(245,250,255,.94);
      --fieldFill: rgba(255,255,255,.035);
      --zShadow: drop-shadow(0 22px 46px rgba(0,0,0,.72));
      --zShadowSoft: drop-shadow(0 10px 22px rgba(0,0,0,.55));
    }

    html, body{
      height:100%;
      
      min-height: 100dvh; /* iOS/iPadOS Safari dynamic viewport */
margin:0;
      background:#000;
      color:var(--txt);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      overflow:hidden;
      -webkit-text-size-adjust: 100%;
    }

    .buildBadge{
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 9999;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.14);
      color: rgba(255,255,255,.92);
      font-weight: 1000;
      letter-spacing: 1px;
      font-size: 13px;
      text-transform: uppercase;
      pointer-events: none;
      box-shadow: 0 10px 22px rgba(0,0,0,.55);
    }
    .buildBadge b{ color: rgba(0,210,255,.95); }

    /* Debug panel (toggle) */
    .dbg{ display:none; }
    .dbgHead{
      padding: 10px 12px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      cursor: pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
    }
    .dbgHead span{
      font-size: 13px;
      font-weight: 1000;
      letter-spacing: 1px;
      text-transform: uppercase;
      opacity: .92;
    }
    .dbgHead b{ color: rgba(90,255,170,.92); }
    .dbgBody{
      display:none;
      padding: 10px 12px 12px 12px;
      font-size: 13px;
      line-height: 1.4;
      opacity: .9;
    }
    .dbg.open .dbgBody{ display:block; }
    .kv{ display:flex; justify-content: space-between; gap:10px; }
    .kv code{ opacity:.95; }
    .warn{ color: rgba(255,210,90,.95); }
    .bad{ color: rgba(255,120,120,.95); }
    .ok{ color: rgba(90,255,170,.95); }

    #app{
  padding-top: 72px; /* keep UI clear of header */ position:fixed; inset:0; }
    .screen{ position:absolute; inset:0; display:none; }
    .screen.active{ display:block; }

    .screen::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--bgStage);
      background-repeat:no-repeat;
      /* Responsive stage fit: keep the top/logo visible on all aspect ratios */
      background-size: cover;
      background-position: center top;
    }
    .screen::after{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(130% 110% at 50% 25%, rgba(0,0,0,0), rgba(0,0,0,.22) 60%, rgba(0,0,0,.52) 100%);
      pointer-events:none;
    }

    /* ===== Landing ===== */
    .landingUI{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(320px, 48vh, 590px);
      display:grid;
      gap: 14px;
      justify-items:center;
      z-index:2;
    }

    .field3d, .btn3d{
      width: min(640px, 92vw);
      height: 72px;
      border-radius: 22px;
      transform: translateZ(0);
      filter: var(--zShadow);
      background: var(--fieldFill);
      border: 1px solid rgba(255,255,255,.18);
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.45),
        inset 0 -14px 22px rgba(0,0,0,.60),
        0 0 18px rgba(0,210,255,.10);
      position:relative;
      overflow:hidden;
    }
    .field3d::before, .btn3d::before{
      content:"";
      position:absolute;
      inset: 10px 12px auto 12px;
      height: 16px;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(255,255,255,.52), rgba(255,255,255,0));
      opacity: .42;
      pointer-events:none;
    }
    .field3d input{
      width:100%;
      height:100%;
      border:0;
      outline:none;
      background:transparent;
      color: rgba(255,255,255,.95);
      font-size: 18px;
      letter-spacing: .6px;
      padding: 0 20px;
      box-sizing:border-box;
      -webkit-appearance:none;
      appearance:none;
    }
    .field3d input::placeholder{ color: rgba(235,245,255,.55); }

    /* iOS Safari yellow autofill kill */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active {
      -webkit-text-fill-color: rgba(255,255,255,.95) !important;
      caret-color: rgba(255,255,255,.95);
      transition: background-color 99999s ease-out 0s;
      -webkit-box-shadow: 0 0 0px 1000px var(--fieldFill) inset !important;
      box-shadow: 0 0 0px 1000px var(--fieldFill) inset !important;
      border-radius: 22px;
    }

    .btn3d{
      cursor:pointer;
      color: rgba(255,255,255,.96);
      font-weight: 1000;
      font-size: 28px;
      letter-spacing: 2px;
      text-transform: uppercase;
      transition: transform .07s ease, filter .07s ease;
      -webkit-tap-highlight-color: transparent;
    }
    .btn3d:active{ transform: translateY(2px) scale(.995); filter: var(--zShadowSoft); }

    .hint{
      font-size: 13px;
      opacity: .78;
      text-align:center;
      max-width: min(640px, 92vw);
      line-height: 1.35;
    }

    /* ===== Hub ===== */
    .hub{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(220px, 30vh, 340px);
      bottom: max(120px, env(safe-area-inset-bottom));
      display:grid;
      grid-template-rows: 1fr 1fr;
      gap: 18px;
      padding: 0 12px;
      box-sizing:border-box;
      z-index:2;
    }

    .panel{
      position:relative;
      border-radius: 22px;
      background: rgba(255,255,255,.03);
      border: none;
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.38),
        inset 0 -14px 22px rgba(0,0,0,.62),
        0 0 18px rgba(0,210,255,.10);
      overflow:hidden;
      filter: var(--zShadowSoft);
    }

    .sectionHead{ padding: 12px 14px 10px 14px; }

    .title{
      font-weight: 1000;
      letter-spacing: 3px;
      text-transform: uppercase;
      font-size: clamp(22px, 3.0vh, 30px);
      position: relative;
      padding-bottom: 6px;
      width: 100%;
      background: linear-gradient(180deg,
        rgba(255,228,170,.92) 0%,
        rgba(255,170,70,.90) 40%,
        rgba(255,242,210,.96) 72%,
        rgba(255,190,95,.88) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-stroke: 0.7px rgba(255,255,255,.18);
      text-shadow:
        0 1px 0 rgba(255,255,255,.22),
        0 -2px 10px rgba(0,0,0,.70),
        0 0 22px rgba(0,210,255,.18);
    }
    .title::after{
      content:"";
      position:absolute;
      left:0; right:0; bottom:0;
      height:2px;
      border-radius:999px;
      background: linear-gradient(90deg, rgba(0,210,255,.55), rgba(255,175,0,.40), rgba(0,210,255,.10));
      opacity:.75;
    }

    .list{
      position:absolute;
      left: 0; right: 0;
      top: 54px; bottom: 0;
      padding: 10px 12px 14px 12px;
      box-sizing: border-box;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }

    .itemLine{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 4px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }

    .leftStack{
      display:flex;
      align-items:center;
      gap: 10px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .glassText{
      font-weight: 1000;
      font-size: clamp(22px, 2.8vh, 30px);
      letter-spacing: .6px;
      white-space: nowrap;
      overflow: visible;
      text-overflow: clip;
      background: linear-gradient(180deg,
        rgba(190,240,255,.94) 0%,
        rgba(55,185,235,.90) 45%,
        rgba(220,248,255,.96) 75%,
        rgba(85,205,245,.88) 100%);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      -webkit-text-stroke: 0.6px rgba(255,255,255,.22);
      text-shadow:
        0 1px 0 rgba(255,255,255,.35),
        0 -2px 10px rgba(0,0,0,.70),
        0 0 14px rgba(0,210,255,.10);
    }

    .dot{
      width:10px;
      height:10px;
      border-radius:999px;
      background: rgba(255,255,255,.18);
      box-shadow: 0 0 0 1px rgba(255,255,255,.12);
      flex: 0 0 auto;
    }
    .dot.online{
      background: rgba(60, 255, 160, .98);
      box-shadow: 0 0 18px rgba(60,255,160,.75), 0 0 38px rgba(60,255,160,.30), 0 0 0 1px rgba(60,255,160,.45);
      animation: onlinePulse 1.35s ease-in-out infinite;
    }
    @keyframes onlinePulse{
      0%{ transform: scale(1); filter: brightness(1.0); }
      50%{ transform: scale(1.15); filter: brightness(1.25); }
      100%{ transform: scale(1); filter: brightness(1.0); }
    }

    .actions{ display:flex; gap:8px; flex:0 0 auto; }

    .pill{
      /* v768 uniform button sizing */
border: 1px solid rgba(255,255,255,.22);
      background: rgba(255,255,255,.03);
      color: rgba(255,255,255,.95);
      border-radius: 999px;
      padding: 12px 16px;
      font-size: 13px;
      font-weight: 1000;
      letter-spacing: .8px;
      text-transform: uppercase;
      cursor:pointer;
      position:relative;
      overflow:hidden;
      -webkit-tap-highlight-color: transparent;
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.28),
        inset 0 -10px 16px rgba(0,0,0,.55),
        0 0 16px rgba(0,210,255,.08);
      transition: transform .07s ease, filter .07s ease;
    }

    /* [EDIT_BUTTONS] Advancement buttons = green glass "lit" */
    .btnAdvance{
      border: 1px solid rgba(120,255,170,.42) !important;
      background: linear-gradient(180deg, rgba(70,255,150,.18), rgba(255,255,255,.06)) !important;
      box-shadow: 0 0 0 1px rgba(70,255,150,.12) inset, 0 10px 22px rgba(0,0,0,.45);
      filter: drop-shadow(0 10px 22px rgba(0,0,0,.55));
    }
    .btnAdvance:active{
      transform: translateY(1px) scale(.99);
      box-shadow: 0 0 0 1px rgba(70,255,150,.14) inset, 0 6px 14px rgba(0,0,0,.55);
    }

    .pill:active{
      transform: translateY(2px) scale(.99);
      filter: var(--zShadowSoft);
    }

    .detailWrap{
      position:absolute;
      left:50%;
      transform:translateX(-50%);
      width: var(--uiW);
      max-width: var(--maxW);
      top: clamp(220px, 30vh, 340px);
      bottom: max(120px, env(safe-area-inset-bottom));
      z-index: 2;
      display:grid;
      grid-template-rows: 1fr auto;
      gap: 18px;
      padding: 0 12px;
      box-sizing:border-box;
    }
    .detailBody{
      padding: 14px 14px 18px 14px;
      line-height: 1.55;
      font-size: 18px;
      opacity: .92;
    }

    .fatal{
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.82);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 20px;
      z-index: 99999;
    }
    .fatal .card{
      width: min(720px, 92vw);
      border-radius: 22px;
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.14);
      box-shadow: 0 22px 46px rgba(0,0,0,.55);
      padding: 16px 16px 18px 16px;
    }
    .fatal h2{ margin:0 0 8px 0; font-size: 18px; letter-spacing:1px; text-transform: uppercase; }
    .fatal p{ margin:0 0 10px 0; opacity:.88; line-height:1.45; }
    .fatal pre{
      margin:0;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 13px;
      opacity: .9;
      background: rgba(0,0,0,.35);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 12px;
      border-radius: 14px;
    }

    /* v768: header row + mini pill */
    .headerRow{ display:flex; align-items:flex-end; justify-content:space-between; gap:12px; }
    .pillMini{
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 1px;
      height: 34px;
      align-self: center;
    }


    /* v768: session indicator */
    .sessionPill{
      padding: 8px 12px;
      font-size: 11px;
      letter-spacing: 1px;
      height: 34px;
      align-self: center;
      opacity: .92;
    }
    .sessionPill.live{
      border-color: rgba(90,255,170,.55);
      box-shadow:
        inset 0 2px 6px rgba(255,255,255,.28),
        inset 0 -10px 16px rgba(0,0,0,.55),
        0 0 16px rgba(90,255,170,.12);
    }


    /* v768 layout lock: micro vertical drop */
    .appWrap, .screen, .landing, .players {
        transform: translateY(20px);
    }


    /* v768 layout lock adjustment: additional micro drop */
    .appWrap, .screen, .landing, .players {
        transform: translateY(20px);
    }


    /* v768 ATW emoji: keep color + one-line */
    .gameLabelWrap{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
      white-space:nowrap;
    }
    .emojiGlobe{
      display:inline-block;
      font-size: 18px;
      line-height: 1;
      color: initial !important;
      background: none !important;
      -webkit-text-fill-color: initial !important;
      -webkit-background-clip: initial !important;
      background-clip: initial !important;
      filter: drop-shadow(0 0 10px rgba(120,200,255,.18));
    }



    /* v768: Setup screen scroll/visibility fix for iPhone Safari (more vertical room) */
    #setup .detailWrap{
      top: clamp(150px, 18vh, 260px);
      bottom: max(80px, env(safe-area-inset-bottom));
    }
    /* Ensure list area can always finger-scroll */
    #setup .list{
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }



    /* v768: glass dropdowns (no white/yellow) */
    .glassSelect{
      width: 100%;
      padding: 14px 44px 14px 16px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.96);
      font-weight: 1100;
      font-size: 20px;
      line-height: 1.1;
      outline: none;
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      box-shadow:
        inset 0 0 18px rgba(255,255,255,.06),
        0 0 18px rgba(255,255,255,.06);
      background-image:
        linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02)),
        url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24'%3E%3Cpath fill='rgba(255,255,255,0.85)' d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-size: auto, 20px 20px;
      background-position: 0 0, calc(100% - 14px) 50%;
    }
    .glassSelect:focus{
      border-color: rgba(255,255,255,.24);
      background: rgba(255,255,255,.08);
      box-shadow:
        0 0 0 2px rgba(255,255,255,.10),
        inset 0 0 20px rgba(255,255,255,.08),
        0 0 22px rgba(120,190,255,.10);
    }

    /* Keep iOS/Safari from forcing yellow/white fills on inputs */
    input, textarea, select{
      -webkit-tap-highlight-color: rgba(0,0,0,0);
      caret-color: rgba(255,255,255,.95);
    }
    input:-webkit-autofill,
    textarea:-webkit-autofill,
    select:-webkit-autofill{
      -webkit-text-fill-color: rgba(255,255,255,.96) !important;
      transition: background-color 99999s ease-in-out 0s;
      box-shadow: 0 0 0 1000px rgba(255,255,255,.06) inset !important;
      border: 1px solid rgba(255,255,255,.16) !important;
    }



    /***********************
     *  v768 ERROR HUD
     *  - Appears only when an error occurs
     *  - Small, not in the way
     ***********************/
    #ngErrToast{
      position: fixed;
      right: 14px;
      bottom: max(14px, env(safe-area-inset-bottom));
      z-index: 99999;
      display: none;
      max-width: min(420px, calc(100vw - 28px));
    }
    #ngErrToast .card{
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(20,20,24,.78);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35), inset 0 0 18px rgba(255,255,255,.06);
      overflow:hidden;
    }
    #ngErrToast .head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.10);
    }
    #ngErrToast .title{
      font-weight: 1200;
      font-size: 14px;
      letter-spacing: .2px;
      opacity: .95;
      display:flex;
      gap: 8px;
      align-items:center;
      white-space: nowrap;
    }
    #ngErrToast .dot{
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: rgba(255,80,80,.92);
      box-shadow: 0 0 14px rgba(255,80,80,.35);
      flex: 0 0 auto;
    }
    #ngErrToast .btn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.92);
      border-radius: 12px;
      padding: 8px 10px;
      font-weight: 1100;
      font-size: 13px;
      line-height: 1;
    }
    #ngErrToast .btn:active{ transform: translateY(1px); opacity:.96; }
    #ngErrToast .body{
      padding: 10px 12px 12px;
      font-size: 13px;
      line-height: 1.35;
      opacity: .90;
    }
    #ngErrToast .msg{
      font-weight: 1000;
      font-size: 13px;
      margin-bottom: 8px;
      opacity: .96;
    }
    #ngErrToast .detail{
      display:none;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      opacity: .90;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    #ngErrToast.expanded .detail{ display:block; }


/* =============================================================================
   SECTION: EDITABLE COORDINATES  [EDIT_LOGO] [EDIT_BG] [EDIT_VERSION]
   - If you want to move the logo or tweak offsets, search for these tags.
============================================================================= */

/* =============================================================================
   SECTION_SETUP: PLAYER PICKER DROPDOWN  [SECTION_SETUP]
============================================================================= */
/* v768: player picker dropdown */
.glassBtn{
  width: 100%;
  padding: 14px 16px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  color: rgba(255,255,255,.96);
  font-weight: 1100;
  font-size: 20px;
  line-height: 1.1;
  box-shadow: inset 0 0 18px rgba(255,255,255,.06), 0 0 18px rgba(255,255,255,.06);
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 10px;
}
.glassBtn .sub{ opacity:.72; font-weight:900; font-size:16px; }
.glassBtn:active{ transform: translateY(1px); opacity:.96; }
.pickerModal{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,.58);
  display:none;
  align-items:center;
  justify-content:center;
  z-index: 99999;
  padding: 18px;
}
.pickerCard{
  width: min(520px, 100%);
  border-radius: 18px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  box-shadow: 0 0 30px rgba(0,0,0,.35), inset 0 0 24px rgba(255,255,255,.06);
  overflow:hidden;
}
.pickerHead{
  padding: 14px 16px;
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap: 12px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.pickerHead .t{ font-weight:1200; font-size:18px; }
.pickerHead .c{ opacity:.75; font-weight:900; font-size:14px; }
.pickerBody{
  max-height: 46vh;
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;
  padding: 10px 12px;
}
.pickerRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap: 12px;
  padding: 12px 12px;
  border-radius: 14px;
  border: 1px solid rgba(255,255,255,.08);
  background: rgba(255,255,255,.04);
  margin-bottom: 10px;
}
.pickerRow .nm{ font-weight:1100; }
.pickerRow .em{ opacity:.65; font-size: 13px; font-weight:800; }
.pickerFoot{
  padding: 12px 12px;
  display:flex;
  gap: 10px;
  border-top: 1px solid rgba(255,255,255,.10);
}
.pickerFoot .pill{ flex:1; }

/* =============================================================================
   SECTION_UI: VERSION BADGE  [EDIT_VERSION]
============================================================================= */
#ngVersionBadge{
  position: fixed;
  left: 12px;
  top: max(10px, env(safe-area-inset-top));
  z-index: 99998;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255,255,255,.14);
  background: rgba(20,20,24,.58);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  font-weight: 1100;
  font-size: 13px;
  letter-spacing: .4px;
  opacity: .92;
}

/* =============================================================================
   SECTION_UI: FIELD LABELS (visual separation)  [EDIT_COLORS]
============================================================================= */
.fieldLabel{
  display:inline-block;
  padding: 8px 12px;
  border-radius: 14px;
  border: 1px solid rgba(120,190,255,.22);
  background: rgba(40,120,220,.14);
  color: rgba(225,245,255,.96);
  font-weight: 1100;
  letter-spacing: .4px;
  margin: 0 0 10px 0;
  box-shadow: inset 0 0 18px rgba(120,190,255,.08);
}

.setupGameTitle{
  font-weight: 1200;
  font-size: 30px;
  letter-spacing: 1px;
  margin-bottom: 8px;
  text-transform: uppercase;
  text-shadow: 0 2px 14px rgba(0,0,0,.65), 0 0 22px rgba(0,210,255,.18);
}
/* v768 ADVANCE BUTTONS + SETUP LAYOUT FIXES */
.pill.btnAdvance, .btnAdvance, .btn-advance{
  border: 1px solid rgba(120,255,170,.35) !important;
  background: linear-gradient(180deg, rgba(60,255,160,.22), rgba(20,120,70,.18)) !important;
  box-shadow: 0 0 18px rgba(70,255,160,.18), inset 0 0 18px rgba(60,255,160,.12) !important;
}
.pill.btnAdvance:active, .btnAdvance:active, .btn-advance:active{
  transform: translateY(1px) scale(0.99);
  box-shadow: 0 0 10px rgba(70,255,160,.16), inset 0 0 10px rgba(60,255,160,.10) !important;
}
/* Make "advance" buttons readable */
.pill.btnAdvance{ font-weight: 950; }

/* Prevent duplicated controls from stacking/overlapping inside setup body */
#setup .panel .detailBody{ position: relative; }


/* ===================== v768 HEADER BAR (ONE ROW, NO WRAP) ===================== */
#ngHeaderBar{
  position: fixed;
  top: max(10px, env(safe-area-inset-top));
  left: 50%;
  transform: translateX(-50%);
  z-index: 9999;
  width: min(760px, 94vw);
  padding: 8px 12px;
  border-radius: 16px;
  border: 1px solid rgba(255,255,255,.18);
  background: transparent !important;
  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
  overflow: hidden;
  display:flex;
  flex-direction: column;
  gap: 4px;
}
.ngTopRow{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
}
.ngBottomRow{
  display:flex;
  align-items:center;
  justify-content: space-between;
  gap: 10px;
  padding: 2px 0 0;
}
.ngBottomLeft{ flex: 0 0 auto; width: 1px; }
.ngUpdateBtn{
  height: 34px;
  padding: 8px 12px;
  font-size: 11px;
  letter-spacing: 1px;
  opacity: .92;
}

#ngHeaderBar::before{
  content:"";
  position:absolute;
  inset:0;
  border-radius:16px;
  pointer-events:none;
  background: radial-gradient(120px 80px at 18% 0%, rgba(70,170,255,.28), transparent 70%),
              radial-gradient(140px 90px at 82% 0%, rgba(70,255,160,.22), transparent 72%),
              linear-gradient(90deg, rgba(70,170,255,.12), rgba(70,255,160,.10));
  mix-blend-mode: screen;
}
#ngHeaderBar > span{
  position: relative;
  z-index: 1;
  white-space: nowrap;
  font-size: 13px;
  letter-spacing: .2px;
}
.ngHeaderLeft{ font-weight: 700; }
.ngHeaderCenter{ opacity: .95; }
.ngHeaderRight{ opacity: .85; }
#ngHeaderBar span{
  font-size: 12px;
  line-height: 1;
  letter-spacing: .06em;
  text-transform: uppercase;
  font-weight: 900;
  opacity: .92;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
#ngHeaderBar .ngHeaderLeft{ flex: 0 0 auto; max-width: 45%; }
#ngHeaderBar .ngHeaderCenter{ flex: 1 1 auto; opacity: .80; max-width: 40%; }
#ngHeaderBar .ngHeaderRight{ flex: 0 0 auto; opacity: .85; max-width: 20%; }

/* Make sure landing UI sits below the header */
#landing .landingUI{ padding-top: 54px; }

/* ===================== v768 GREEN ADVANCE BUTTONS ===================== */
.btnAdvance, .btn-advance, .btnAdvanceGreen{
  border: 1px solid rgba(120,255,170,.35) !important;
  background: linear-gradient(180deg, rgba(60,255,160,.22), rgba(20,120,70,.18)) !important;
  box-shadow:
    0 0 18px rgba(70,255,160,.18),
    inset 0 0 18px rgba(60,255,160,.12) !important;
}
.btnAdvance:active, .btn-advance:active, .btnAdvanceGreen:active{
  transform: translateY(1px) scale(0.99);
  box-shadow:
    0 0 10px rgba(70,255,160,.16),
    inset 0 0 10px rgba(60,255,160,.10) !important;
}

/* ===================== v768 UI FIXES (requested) ===================== */
/* Hide Lobby Setup button (requested) */
#lobbySetupBtn{ display:none !important; }

/* Uniform pill buttons (size/shape) */
.pill{
  height: 44px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  box-sizing: border-box;
  white-space: nowrap;
}

/* Prevent text from colliding into buttons in lists */
.leftStack{ min-width: 0; }
.glassText{
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}

/* Picker rows: truncate long name/email, keep button fixed */
.pickerRow > div{ min-width: 0; }
.pickerRow .nm, .pickerRow .em{
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}


/* ===================== v768 STABILIZE: REMOVE GREEN ADVANCE BUTTONS ===================== */
.btnAdvance, .btn-advance, .btnAdvanceGreen{
  border: 1px solid rgba(255,255,255,.22) !important;
  background: rgba(255,255,255,.03) !important;
  box-shadow:
    inset 0 2px 6px rgba(255,255,255,.28),
    inset 0 -10px 16px rgba(0,0,0,.55),
    0 0 16px rgba(0,210,255,.08) !important;
  filter: var(--zShadowSoft);
}
.btnAdvance:active, .btn-advance:active, .btnAdvanceGreen:active{
  transform: translateY(2px) scale(.99);
  filter: var(--zShadowSoft);
}

/* v768: move setup/waiting panels down slightly so the glass doesn't run into the logo */
#setup .detailWrap, #waiting .detailWrap{
  top: clamp(210px, 26vh, 340px);
}

/* v768: waiting room typography + centering */
#waiting .detailBody{
  text-align: center;
}
.waitRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding: 12px 10px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.waitLeft{
  display:flex;
  align-items:center;
  gap:10px;
  min-width:0;
}
.waitName{
  font-weight: 1050;
  font-size: 20px;
  letter-spacing: .2px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
.waitMeta{
  opacity:.78;
  font-weight:900;
  font-size: 13px;
  white-space: nowrap;
}
.statusIcon{
  width: 22px;
  text-align:center;
  font-size: 16px;
  font-weight: 1100;
}
.statusIcon.ok{ color: rgba(90,255,170,.95); }
.statusIcon.wait{ color: rgba(255,210,90,.95); }
.statusIcon.no{ color: rgba(255,120,120,.95); }
    .actions{ width:100%; }
    .actions .pill{ flex:1; text-align:center; }

    /* v771: Item lines show label ABOVE buttons (so game/player names are visible) */
    .itemLine{
      flex-direction: column;
      align-items: stretch;
      gap: 10px;
      padding: 14px 6px;
      border-bottom: 1px solid rgba(255,255,255,.18); /* slightly stronger divider */
    }
    .leftStack{
      width: 100%;
      justify-content: center;
    }
    .gameLabelWrap{ justify-content:center; width:100%; }
    .actions{
      width:100%;
    }
    .actions .pill{
      flex:1;
      text-align:center;
    }

/* Header: remove pill */
#ngHeaderBar{
  background: transparent !important;
  border: none !important;
  box-shadow: none !important;
  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}
#ngHeaderBar::before{ display:none !important; }
#ngHeaderBar .ngTitle{
  color: #d7b24a !important;
  font-weight: 1000;
  letter-spacing: .4px;
  text-shadow: 0 2px 10px rgba(0,0,0,.75);
}
#ngHeaderBar .ngVer{
  color: rgba(0,210,255,.95) !important;
  font-weight: 1000;
  text-shadow: 0 2px 10px rgba(0,0,0,.75);
}
#ngHeaderBar .ngOnline, #ngHeaderRight{
  color: rgba(60,255,160,.98) !important;
  font-weight: 1000;
  text-shadow: 0 2px 10px rgba(0,0,0,.75);
}

/* Landing pads positioned to match the artwork's email & enter fields */
#landing #landingPads{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  width:min(640px,92vw);
  max-width:640px;
  bottom:max(70px, calc(env(safe-area-inset-bottom) + 60px));
  display:grid;
  gap:10px;
  z-index:5;
  pointer-events:none;
}

/* Email pad slightly smaller than ENTER */
#landing #emailPad{
  position:relative;
  height:64px;
  pointer-events:auto;
}
#landing #emailInput{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  opacity:0;
  border:0;
  outline:none;
  background:transparent;
  color:transparent;
  caret-color:transparent;
}
#landing #emailEcho{
  position:absolute;
  inset:0;
  display:flex;
  align-items:center;
  justify-content:center;
  text-align:center;
  font-size:17px;
  font-weight:1000;
  letter-spacing:.6px;
  color:rgba(255,255,255,.95);
  text-shadow:0 2px 12px rgba(0,0,0,.85), 0 0 18px rgba(0,0,0,.55);
  pointer-events:none;
  user-select:none;
}
#landing #enterBtn{
  height:72px;
  border:0;
  background:transparent;
  border-radius:22px;
  opacity:0;
  pointer-events:auto;
  cursor:pointer;
}

/* Single hint line */
#landing .landingHint{
  text-align:center;
  font-size:12px;
  font-weight:900;
  opacity:.86;
  pointer-events:none;
}

/* Footer */
#landing #landingFoot{
  position:absolute;
  left:50%;
  transform:translateX(-50%);
  bottom:max(10px, env(safe-area-inset-bottom));
  width:min(900px, 96vw);
  text-align:center;
  z-index:6;
  pointer-events:none;
}
#landing .landingFooter{
  font-size:12px;
  font-weight:800;
  opacity:.80;
  line-height:1.25;
}
#landing .landingCopy{
  margin-top:4px;
  font-size:10px;
  font-weight:800;
  opacity:.62;
  letter-spacing:.2px;
}


/* Make the invisible pads match the stage width and sit a little lower */
:root{
  --padWidth: min(760px, 96vw);
  --padsBottom: max(180px, calc(env(safe-area-inset-bottom) + 168px));
  --emailH: 62px;
  --enterH: 78px;
}
#landing #landingPads{
  width: var(--padWidth) !important;
  bottom: var(--padsBottom) !important;
  gap: 12px !important;
}
#landing #emailPad{
  height: var(--emailH) !important;
}
#landing #enterBtn{
  width: 100% !important;
  height: var(--enterH) !important;
  border-radius: 28px !important;
}
#landing #emailEcho{
  font-size: 18px !important;
}


/* Move the white email text + hint down together */
:root{ --ngTextDrop: 28px; } /* tweak if needed */
#landing #emailEcho,
#landing #statusLine{
  transform: translateX(-50%) translateY(var(--ngTextDrop)) !important;
}

/* Show clear (semi-transparent) pads so you can see/align them */
#landing #emailPad{
  outline: 2px solid rgba(255,255,255,.28) !important;
  background: rgba(255,255,255,.06) !important;
  border-radius: 22px !important;
}
#landing #enterBtn{
  opacity: 1 !important;
  outline: 2px solid rgba(255,255,255,.28) !important;
  background: rgba(255,255,255,.05) !important;
  border-radius: 22px !important;
}


:root{
  --ngPadsRadius: 26px;
  --ngPadH: 74px;
  --ngPadGap: 12px;
}

/* Same size + stage width */
#landing #landingPads{
  gap: var(--ngPadGap) !important;
}
#landing #emailPad,
#landing #enterBtn{
  width: 100% !important;
  height: var(--ngPadH) !important;
  border-radius: var(--ngPadsRadius) !important;
}

/* Crystal-clear glass look */
#landing #emailPad,
#landing #enterBtn{
  background: linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06)) !important;
  border: 1px solid rgba(255,255,255,.28) !important;
  box-shadow:
    0 12px 34px rgba(0,0,0,.30),
    inset 0 1px 0 rgba(255,255,255,.40),
    inset 0 -1px 0 rgba(255,255,255,.16) !important;
  backdrop-filter: blur(10px) saturate(120%);
  -webkit-backdrop-filter: blur(10px) saturate(120%);
}

/* remove the old outline styling from v906 */
#landing #emailPad{ outline: none !important; }
#landing #enterBtn{ outline: none !important; opacity: 1 !important; }

/* Keep email text centered INSIDE top pad */
#landing #emailEcho{
  transform: translateY(0px) !important;
  font-size: 18px !important;
}

/* Put hint INSIDE the enter pad, under ENTER */
#landing #enterBtn{
  position: relative;
  padding: 0 !important;
}
#landing #enterBtn .enterText{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%,-62%);
  font-size: 28px;
  font-weight: 1000;
  letter-spacing: 2px;
  color: rgba(255,255,255,.92);
  text-shadow: 0 2px 14px rgba(0,0,0,.55);
  pointer-events:none;
}
#landing #enterBtn .enterSub{
  position:absolute;
  left:50%;
  top:50%;
  transform: translate(-50%, 30%);
  width: 92%;
  text-align:center;
  font-size: 12px;
  font-weight: 900;
  opacity: .86;
  color: rgba(255,255,255,.88);
  text-shadow: 0 2px 12px rgba(0,0,0,.55);
  pointer-events:none;
}

/* Nudge email+enter group down a touch more without breaking footer */
#landing #landingPads{
  bottom:max(58px, calc(env(safe-area-inset-bottom) + 48px)) !important;
}


:root{
  --ngPadsRadius: 22px;
  --ngPadH: 64px;
  --ngPadGap: 10px;
  --ngPadW: 92%;
}

/* Move pad stack UP a bit (increase bottom) */
#landing #landingPads{
  bottom:max(78px, calc(env(safe-area-inset-bottom) + 70px)) !important;
}

/* Smaller width + consistent sizing */
#landing #emailPad,
#landing #enterBtn{
  width: var(--ngPadW) !important;
  height: var(--ngPadH) !important;
  border-radius: var(--ngPadsRadius) !important;
  margin-left:auto !important;
  margin-right:auto !important;
}

/* Crystal-clear beveled glass (no tint) */
#landing #emailPad,
#landing #enterBtn{
  background: linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.035)) !important;
  border: 1px solid rgba(255,255,255,.34) !important;
  box-shadow:
    0 10px 28px rgba(0,0,0,.28),
    inset 0 1px 0 rgba(255,255,255,.55),
    inset 0 -1px 0 rgba(255,255,255,.18),
    inset 1px 0 0 rgba(255,255,255,.18),
    inset -1px 0 0 rgba(255,255,255,.18) !important;
  backdrop-filter: blur(8px) saturate(110%);
  -webkit-backdrop-filter: blur(8px) saturate(110%);
}

/* Keep email text centered inside top pad */
#landing #emailEcho{
  font-size: 17px !important;
}

/* ENTER + subtext scale down slightly to fit smaller pad */
#landing #enterBtn .enterText{
  font-size: 24px !important;
  transform: translate(-50%,-64%) !important;
}
#landing #enterBtn .enterSub{
  font-size: 11px !important;
  transform: translate(-50%, 36%) !important;
}


/* Move pads UP slightly */
#landing #landingPads{
  bottom:max(110px, calc(env(safe-area-inset-bottom) + 95px)) !important;
}

/* Crystal clear glass (no color tint at all) */
#landing #emailPad,
#landing #enterBtn{
  background: rgba(255,255,255,0.04) !important;
  border: 1px solid rgba(255,255,255,0.55) !important;
  box-shadow:
    0 8px 22px rgba(0,0,0,.25),
    inset 0 2px 6px rgba(255,255,255,.55),
    inset 0 -2px 6px rgba(255,255,255,.15);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
}


:root{
  --ngEnterH: 64px;
  --ngEmailH: 58px;       /* slightly smaller */
  --ngPadW: 92%;
  --ngPadR: 22px;
  --ngGap: 14px;
  --ngEmailLift: -6px;    /* move email pad up a touch */
}

/* Pad stack position (leave overall where it is) */
#landing #landingPads{
  gap: var(--ngGap) !important;
}

/* Common glass look: crystal clear, shiny, beveled */
#landing #emailPad,
#landing #enterBtn{
  width: var(--ngPadW) !important;
  margin-left:auto !important;
  margin-right:auto !important;
  border-radius: var(--ngPadR) !important;
  position: relative !important;
  overflow: hidden !important;

  background: rgba(255,255,255,0.03) !important;   /* clear, not frosted */
  border: 1px solid rgba(255,255,255,0.55) !important;
  box-shadow:
    0 10px 26px rgba(0,0,0,0.26),
    inset 0 2px 10px rgba(255,255,255,0.55),
    inset 0 -2px 8px rgba(255,255,255,0.14),
    inset 1px 0 0 rgba(255,255,255,0.18),
    inset -1px 0 0 rgba(255,255,255,0.18) !important;

  backdrop-filter: blur(5px) saturate(115%);
  -webkit-backdrop-filter: blur(5px) saturate(115%);
}

/* Beveled sparkle highlight */
#landing #emailPad::before,
#landing #enterBtn::before{
  content:"";
  position:absolute;
  left:-15%;
  top:-55%;
  width:130%;
  height:90%;
  background: linear-gradient(135deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,0.22) 32%,
    rgba(255,255,255,0.06) 52%,
    rgba(255,255,255,0) 76%);
  transform: rotate(10deg);
  pointer-events:none;
  mix-blend-mode: screen;
}
#landing #emailPad::after,
#landing #enterBtn::after{
  content:"";
  position:absolute;
  inset:0;
  border-radius: var(--ngPadR);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,0.10);
  pointer-events:none;
}

/* Sizes */
#landing #enterBtn{ height: var(--ngEnterH) !important; }
#landing #emailPad{ height: var(--ngEmailH) !important; transform: translateY(var(--ngEmailLift)) !important; }

/* Keep email text centered inside the email pad */
#landing #emailEcho{ font-size: 17px !important; }

/* Keep ENTER text readable if present */
#landing #enterBtn .enterText{
  font-size: 24px !important;
  transform: translate(-50%,-62%) !important;
}


/* ===================== v906 FINAL POLISH ===================== */
:root{
  --ngEnterH: 64px;
  --ngEmailH: 52px;          /* tiny bit smaller */
  --ngPadW: 90%;
  --ngPadR: 22px;
  --ngGap: 14px;
  --ngEmailLift: -14px;      /* move email up slightly more */
  --ngHintDrop: 6px;         /* drop hint text slightly */
}

/* Slightly increase spacing control */
#landing #landingPads{
  gap: var(--ngGap) !important;
}

/* ENTER button reference */
#landing #enterBtn{
  height: var(--ngEnterH) !important;
}

/* Email smaller + slightly higher */
#landing #emailPad{
  height: var(--ngEmailH) !important;
  transform: translateY(var(--ngEmailLift)) !important;
}

/* Crystal clear glass (frost removed completely) */
#landing #emailPad,
#landing #enterBtn{
  width: var(--ngPadW) !important;
  margin-left:auto !important;
  margin-right:auto !important;
  border-radius: var(--ngPadR) !important;
  position: relative !important;
  overflow: hidden !important;

  background: rgba(255,255,255,0.01) !important;  /* nearly invisible */
  border: 1px solid rgba(255,255,255,0.65) !important;
  box-shadow:
    0 8px 20px rgba(0,0,0,0.22),
    inset 0 3px 10px rgba(255,255,255,0.65),
    inset 0 -3px 8px rgba(255,255,255,0.12),
    inset 1px 0 0 rgba(255,255,255,0.20),
    inset -1px 0 0 rgba(255,255,255,0.20) !important;

  backdrop-filter: none !important;
  -webkit-backdrop-filter: none !important;
}

/* Drop hint text slightly lower */
#landing #enterBtn .enterSub{
  transform: translate(-50%, 42%) !important;
}


/* ===================== v906 PLAYERS READABILITY + ROW LAYOUT ===================== */

/* Move BOTH panels down slightly (harder to read when too high) */
#players .hub{
  top: clamp(250px, 34vh, 380px) !important;   /* was 220px/30vh/340px */
}

/* Make panels easier to read (slightly darker glass + blur) */
#players .panel{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -18px 28px rgba(0,0,0,.32),
    0 18px 38px rgba(0,0,0,.22) !important;
  backdrop-filter: blur(10px) saturate(115%);
  -webkit-backdrop-filter: blur(10px) saturate(115%);
}

/* Keep names to the LEFT of buttons (override older mobile stacking rules) */
#players .itemLine{
  flex-direction: row !important;
  align-items: center !important;
  justify-content: space-between !important;
  gap: 12px !important;
}

#players .leftStack{
  justify-content: flex-start !important;
}

#players .actions{
  width: auto !important;
}

/* Make buttons smaller (both sections) */
#players .actions .pill{
  flex: 0 0 auto !important;
  padding: 9px 12px !important;
  font-size: 12px !important;
  letter-spacing: 1px;
}

/* Slightly reduce name size so row fits cleanly */
#players .glassText{
  font-size: clamp(18px, 2.4vh, 24px) !important;
}


/* ===================== v906 DETAIL (RULES) SCROLL + FROST + FOOTER ===================== */

/* Frost / glass on RULES/detail panels */
#detail .panel{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -18px 28px rgba(0,0,0,.32),
    0 18px 38px rgba(0,0,0,.22) !important;
  backdrop-filter: blur(10px) saturate(115%);
  -webkit-backdrop-filter: blur(10px) saturate(115%);
}

/* Give room for footer */
#detail .detailWrap{
  padding-bottom: 90px;
}

/* Scroll inside the rules content panel */
#detail #detailBody{
  max-height: calc(100vh - 260px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 6px;
}

/* Footer pinned to bottom of the viewport */
#detail .detailFooter{
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(env(safe-area-inset-bottom) + 12px);
  text-align: center;
  font-weight: 900;
  font-size: 13px;
  opacity: .88;
  text-shadow: 0 2px 14px rgba(0,0,0,.65);
  pointer-events: none;
  padding: 0 12px;
}


/* ===================== v906 RULES SCROLL FIX (GRID/FLEX) ===================== */

/* Frost / glass on RULES/detail panels */
#detail .panel{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  box-shadow:
    inset 0 1px 0 rgba(255,255,255,.20),
    inset 0 -18px 28px rgba(0,0,0,.32),
    0 18px 38px rgba(0,0,0,.22) !important;
  backdrop-filter: blur(10px) saturate(115%);
  -webkit-backdrop-filter: blur(10px) saturate(115%);
}

/* The detailWrap is a grid with 1fr + auto.
   Make the first panel a flex column so the body can scroll. */
#detail .detailWrap > .panel:first-child{
  display: flex;
  flex-direction: column;
  min-height: 0;            /* critical for overflow in grid/flex */
}

/* Scroll inside the rules content area */
#detail .detailWrap > .panel:first-child #detailBody{
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 6px;
}

/* Give room for footer */
#detail .detailWrap{
  padding-bottom: 90px;
}

/* Footer pinned to bottom of the viewport */
#detail .detailFooter{
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(env(safe-area-inset-bottom) + 12px);
  text-align: center;
  font-weight: 900;
  font-size: 13px;
  opacity: .88;
  text-shadow: 0 2px 14px rgba(0,0,0,.65);
  pointer-events: none;
  padding: 0 12px;
}


/* ===================== v906 PLAYER STATS UI ===================== */
#detail .statScroll{
  max-height: calc(100vh - 260px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 6px;
}
#detail .statSection{
  margin: 14px 0 16px;
}
#detail .statSectionTitle{
  font-weight: 1000;
  letter-spacing: .6px;
  text-transform: uppercase;
  font-size: 12px;
  opacity: .85;
  margin-bottom: 8px;
}
#detail .statRow{
  display:flex;
  justify-content: space-between;
  gap: 12px;
  padding: 12px 12px;
  border-radius: 14px;
  background: rgba(255,255,255,.04);
  border: 1px solid rgba(255,255,255,.12);
  margin-bottom: 10px;
}
#detail .statLabel{
  font-weight: 1000;
}
#detail .statHelp{
  font-weight: 800;
  opacity: .70;
  font-size: 12px;
  margin-top: 4px;
}
#detail .statVal{
  font-weight: 1100;
  min-width: 54px;
  text-align: right;
  opacity: .95;
}


/* ===================== v917 SETUP SCROLL + LIGHT FROST ===================== */
#setup .detailBody{
  max-height: calc(100vh - 260px);
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

/* v917: setup scroll reliability (grid/flex fix like Detail screen) */
#setup .detailWrap > .panel:first-child{
  display:flex;
  flex-direction: column;
  min-height: 0;
}
#setup #setupBody{
  flex: 1 1 auto;
  min-height: 0;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  padding-right: 6px;
}
/* Keep setup readable while preserving background */
#setup .panel, #players .panel, #games .panel{
  background: rgba(255,255,255,.06);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}
/* Improve text readability lightly */
#setup .detailBody, #setup .detailBody *{
  text-shadow: 0 1px 2px rgba(0,0,0,.55);
}


/* ===================== v917 DETAIL BUTTON UNIFORMITY ===================== */
#detail .pill{
  height: 44px;
  padding: 12px 16px !important;
}
#detail .detailBody{ box-sizing: border-box; }



/* ===================== v917 HEADER PLAYER NAME ===================== */
#ngHeaderBar .ngHeaderPlayer{
  position: relative;
  z-index: 1;
  flex: 1 1 auto;
  text-align: center;
  font-size: 18px;
  line-height: 1.1;
  letter-spacing: .06em;
  text-transform: none;
  font-weight: 1100;
  color: rgba(60,255,160,.98);
  text-shadow: 0 2px 12px rgba(0,0,0,.75), 0 0 18px rgba(60,255,160,.22);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 64%;
}


/* Center/Right widths tuned for 4-span header */
#ngHeaderBar .ngHeaderLeft{ flex: 0 0 auto; max-width: 35%; }
#ngHeaderBar .ngHeaderCenter{ flex: 0 0 auto; opacity: .80; max-width: 30%; }
#ngHeaderBar .ngHeaderRight{ flex: 0 0 auto; opacity: .85; max-width: 20%; }

/* ===================== v917 GLOBAL FOOTER ===================== */
.globalFooter{
  position: fixed;
  left: 0;
  right: 0;
  bottom: calc(env(safe-area-inset-bottom) + 10px);
  text-align: center;
  font-weight: 900;
  font-size: 12px;
  opacity: .86;
  text-shadow: 0 2px 14px rgba(0,0,0,.65);
  pointer-events: none;
  padding: 0 12px;
  z-index: 9990;
}

/* ===================== v917 BUTTON SIZING BY CATEGORY ===================== */
.pill{ height: 44px; }
.pill.btnAdvance{ height: 50px; font-size: 14px; letter-spacing: 1px; }
.pill.pillMini{ height: 34px; }


.statGameBtn{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding: 14px 14px;
  border-radius: 16px;
  margin-bottom: 10px;
  background: rgba(255,255,255,.06);
  border: 1px solid rgba(255,255,255,.16);
}
.statGameBtn .r{ opacity:.78; font-weight:900; }

#detail .detailBody .pill{ height:44px; }
#detail .detailBody .actions .pill{ flex:1; }


/* ===================== v917 RESPONSIVE STAGE FIT ===================== */
/* On wider/shorter viewports (iPad landscape, desktops), avoid cropping by switching to contain. */
@media (min-aspect-ratio: 4/3){
  .screen::before{
    background-size: contain;
    background-position: center top;
  }
}
/* On very tall viewports, keep cover for an immersive look while still pinning the top/logo. */
@media (max-aspect-ratio: 3/4){
  .screen::before{
    background-size: cover;
    background-position: center top;
  }
}

/* =============================================================================
   v917 MASTER ORGANIZATION: UI CONSISTENCY + READABILITY (NO VISUAL REDESIGN)
   ============================================================================= */

/* --- Header bottom row: true centered welcome text, update button right --- */
.ngBottomRow{ position: relative; }
#ngHeaderPlayer{
  position: absolute;
  left: 50%;
  transform: translateX(-50%);
  width: 70%;
  text-align: center;
  font-weight: 1100;
  letter-spacing: .10em;
  text-transform: uppercase;
  font-size: 14px;
  color: rgba(90,255,170,.96);
  text-shadow: 0 2px 12px rgba(0,0,0,.65);
  pointer-events: none;
}
#ngUpdateBtn{
  height: 34px;
  padding: 8px 12px;
  font-size: 11px;
  letter-spacing: 1px;
}

/* --- Frost: picker + detail panels match main glass tone (avoid dark modal) --- */
.pickerCard{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
  box-shadow: 0 14px 34px rgba(0,0,0,.26), inset 0 1px 0 rgba(255,255,255,.22) !important;
  backdrop-filter: blur(12px) saturate(120%);
  -webkit-backdrop-filter: blur(12px) saturate(120%);
}
.pickerRow{
  background: rgba(255,255,255,.06) !important;
  border: 1px solid rgba(255,255,255,.14) !important;
}
#detail .panel{
  background: rgba(255,255,255,.06) !important;
}

/* --- Uniform buttons in detail/stats bodies --- */
#detail .detailBody .pill{
  height: 44px;
  padding: 12px 16px;
  font-size: 13px;
}
.statGameBtn{
  height: 52px;
  padding: 12px 14px;
  display:flex;
  justify-content: space-between;
  align-items: center;
}
</style>
<script id="ngGuards_v748">
/* =============================================================================
   SECTION_UTILS: SAFETY GUARDS  [SECTION_UTILS]
   - Prevents small errors from killing the whole app.
   - Does NOT change normal behavior when everything is working.
============================================================
    /* v906: detail content scrolling (RULES + PLAYER STATS) */
    .detailWrap > .panel:first-child{
      display:flex;
      flex-direction:column;
      height: 100%;
      min-height: 0;
    }
    .detailBody{
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }

    /* v906: prevent browser autofill yellow on email field */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus,
    input:-webkit-autofill:active{
      -webkit-text-fill-color: rgba(235,245,255,.96);
      transition: background-color 5000s ease-in-out 0s;
      box-shadow: 0 0 0px 1000px rgba(255,255,255,.035) inset !important;
    }
================= */
(function(){
  // Safe wrapper for event handlers
  window.ngSafe = function(fn, label){
    return function(){
      try { return fn.apply(this, arguments); }
      catch (e) {
        try {
          if (window.ngErr) window.ngErr(label || "Handler error", e && (e.stack || e.message || String(e)));
        } catch(_e){}
      }
    };
  };

  // Guard common DOM lookup usage
  window.ng$ = function(sel){ return document.querySelector(sel); };
  window.ngAll = function(sel){ return Array.from(document.querySelectorAll(sel)); };
})();
</script>
</head>
<body>
<div id="ngHeaderBar">  <div class="ngTopRow">    <span class="ngHeaderLeft"><span class="ngTitle">Night Games</span> <span class="ngVer">v917</span></span>    <span class="ngHeaderCenter">Firebase  Firestore</span>    <span class="ngHeaderRight ngOnline" id="ngHeaderRight">Online</span>  </div>  <div class="ngBottomRow">    <span class="ngBottomLeft"></span>    <span class="ngHeaderPlayer" id="ngHeaderPlayer" title="">WELCOME</span>    <button type="button" class="pill pillMini ngUpdateBtn" id="ngUpdateBtn" style="display:none;">Update</button>  </div></div>
<!--
================================================================================
  EDIT NOTES (v768)
================================================================================
  [EDIT_BG]       Background image / gradient choices
  [EDIT_LOGO]     Logo placement / size
  [EDIT_VERSION]  Version label placement
  [EDIT_DROPDOWNS]Glass dropdown styling
  [EDIT_COLORS]   Color/opacity tweaks for glass

  TIP: Use Ctrl/Cmd+F for the tags above to jump to the exact spot.
================================================================================
-->
<div class="dbg" id="dbg">
<div class="dbgHead" id="dbgHead">
<span>Debug <b id="dbgState">INIT</b></span>
<span style="opacity:.7;"></span>
</div>
<div class="dbgBody" id="dbgBody">
<div class="kv"><span>URL</span><code id="dbgUrl"></code></div>
<div class="kv"><span>Auth</span><code id="dbgAuth"></code></div>
<div class="kv"><span>Firestore</span><code id="dbgFs"></code></div>
<div class="kv"><span>Last error</span><code class="warn" id="dbgErr">none</code></div>
<div style="margin-top:8px; opacity:.8;">If anything fails on iPhone, this box tells us exactly what.</div>
</div>
</div>
<div id="app">

<section class="screen active" id="landing">
  <!-- v906: target artwork background includes the visible pads; we wire ONLY invisible overlays -->
  <div id="landingPads">
    <div id="emailPad" class="padEmail">
      <input autocomplete="email" id="emailInput" inputmode="email" type="email" value="" placeholder=""/>
      <div id="emailEcho">player@example.com</div>
    </div>

    <button id="enterBtn" type="button" aria-label="Enter"><span class="enterText">ENTER</span><span class="enterSub" id="statusLine">Email-only sign-in (no password). Firebase stable build.</span></button>

    <!-- Keep ONLY one hint line (matches artwork intent) -->
</div>

  <!-- Footer at the foot (separate from hint) -->
  <div id="landingFoot">
    <div class="landingFooter" id="landingFooter">Night Games is owned and operated by The Dart Room.  2026 The Dart Room. All rights reserved.</div>
    <div class="landingCopy" id="landingCopy"> 2026 The Dart Room  Night Games</div>
  </div>
</section>

<section class="screen" id="players">
<div class="hub">
<div class="panel">
<div class="sectionHead headerRow">
<div class="title">Games</div>
<div style="display:flex; gap:10px; align-items:center;"><button class="pill pillMini sessionPill" data-action="show_session" id="sessionBtn" style="display:none;" type="button">Session</button></div>
</div>
<div class="list" id="gamesList"></div>
</div>
<div class="panel">
<div class="sectionHead"><div class="title">Players</div></div>
<div class="list" id="playersList"></div>
</div>
</div>
</section>
<section class="screen" id="setup">
<div class="detailWrap">
<div class="panel">
<div class="sectionHead"><div class="title">Setup</div></div>
<div class="detailBody" id="setupBody">
<div style="opacity:.82;">Setup screen is installed. Wiring comes next.</div>
</div>
</div>
<div class="panel">
<div class="sectionHead"><div class="title">Controls</div></div>
<div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
<button class="pill" id="setupBackBtn" type="button">Back</button>
<button class="pill btnAdvance" id="setupStartBtn" type="button">Start Game</button>
</div>
</div>
</div>
</section>
<section class="screen" id="waiting">
<div class="detailWrap">
<div class="panel">
<div class="sectionHead"><div class="title">Waiting Room</div></div>
<div class="detailBody" id="waitingBody">
<div style="opacity:.82;">Waiting room is installed. Wiring comes next.</div>
</div>
</div>
<div class="panel">
<div class="sectionHead"><div class="title">Controls</div></div>
<div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
<button class="pill" id="waitingBackBtn" type="button">Back</button>
</div>
</div>
</div>
</section>
<section class="screen" id="lobby">
<div class="detailWrap">
<div class="panel">
<div class="sectionHead"><div class="title" id="lobbyTitle">Lobby</div></div>
<div class="detailBody" id="lobbyBody">Loading</div>
</div>
<div class="panel">
<div class="sectionHead"><div class="title">Controls</div></div>
<div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
<button class="pill" id="lobbyBackBtn" type="button">Back</button>
<button class="pill" id="lobbySetupBtn" type="button">Setup</button>
<button class="pill btnAdvance" id="lobbyStartBtn" style="display:none;" type="button">Start</button>
<button class="pill" id="lobbyEndBtn" style="display:none;" type="button">End</button>
</div>
</div>
</div>
</section>
<section class="screen" id="detail">
<div class="detailWrap">
<div class="panel">
<div class="sectionHead"><div class="title" id="detailTitle">Detail</div></div>
<div class="detailBody" id="detailBody">Loading</div>
</div>
<div class="panel">
<div class="sectionHead"><div class="title">Navigation</div></div>
<div class="detailBody" style="display:flex; gap:12px; flex-wrap:wrap;">
<button class="pill" id="backBtn" type="button">Back</button>
<button class="pill" id="homeBtn" type="button">Home</button>
</div>
</div>
</div>

<div class="detailFooter" id="detailFooter">Night Games is owned and operated by The Dart Room.  2026 The Dart Room. All rights reserved.</div>
</section>
</div>
<div class="globalFooter" id="globalFooter">Night Games is owned and operated by The Dart Room.  2026 The Dart Room. All rights reserved.</div>

<div class="fatal" id="fatal">
<div class="card">
<h2>Firebase didnt start</h2>
<p>This page uses Firebase modules. If youre on a web link and still see this, the host is blocking module imports or Firebase is blocked.</p>
<pre id="fatalMsg">No details.</pre>
</div>
</div>
<script nomodule="">
    // Very old browsers only
    document.getElementById("fatal").style.display = "flex";
    document.getElementById("fatalMsg").textContent = "Your browser doesnt support ES Modules. Use a modern Safari/Chrome.";
  </script>
<script>
    // Debug UI toggle
    (function(){
      const dbg = document.getElementById("dbg");
      const head = document.getElementById("dbgHead");
      head.addEventListener("click", ()=> dbg.classList.toggle("open"));
      document.getElementById("dbgUrl").textContent = location.href.slice(0, 48) + (location.href.length>48 ? "" : "");
    })();
  </script>
<script type="module">// Night Games Night Games v917

    // ===== Firebase (stable) =====
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
    import {
      getFirestore,
      doc, setDoc, getDoc,
      collection, onSnapshot,
      serverTimestamp, query, where
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

    const dbgState = document.getElementById("dbgState");
    const dbgAuth = document.getElementById("dbgAuth");
    const dbgFs = document.getElementById("dbgFs");
    const dbgErr = document.getElementById("dbgErr");
    function setDbg(state, auth, fs, err){
      if(state) dbgState.textContent = state;
      if(auth) dbgAuth.textContent = auth;
      if(fs) dbgFs.textContent = fs;
      if(err) dbgErr.textContent = err;
    }

    const fatal = document.getElementById("fatal");
    const fatalMsg = document.getElementById("fatalMsg");
    function failHard(msg, err){
      console.error(msg, err);
      fatal.style.display = "flex";
      fatalMsg.textContent = msg + (err ? ("\n\n" + (err.stack||err.message||String(err))) : "");
      setDbg("FAIL", "", "", msg);
    }

    // ===== Config (from Steven) =====
    /*
================================================================================
   NIGHT GAMES v917  NEW MASTER (ONE-WIRE)
  - Built from v911 baseline
  - No patch stacking: single authoritative wiring path
  - Goals: functional parity through intended v916 + structural cleanliness
================================================================================
*/

/*
================================================================================
   GLOBALS / CONFIG  [SECTION_CORE]
================================================================================
*/

// Canonical game list (single source of truth)
const games = ["01","Cricket","Killer","Shanghai","Around the World","Half It"];

// App globals (single declarations; no shadowing)
let activeSession = null;
let lastPeople = [];
let currentEmail = "";
let currentName = "";

/*
================================================================================
   SMALL UTILS  [SECTION_UTILS]
================================================================================
*/
function ngPrettyNameFromEmail(email){
  if(!email) return "";
  const local = String(email).split("@")[0] || "";
  const cleaned = local.replace(/[._-]+/g, " ").replace(/\s+/g, " ").trim();
  return cleaned.split(" ").filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
}
function ngSetHeaderPlayer(email){
  const el = document.getElementById("ngHeaderPlayer");
  if(!el) return;
  const nm = ngPrettyNameFromEmail(email);
  el.textContent = nm ? `WELCOME, ${nm}` : "WELCOME";
  el.title = email || "";
}
function ngShowUpdate(show){
  const btn = document.getElementById("ngUpdateBtn");
  if(btn) btn.style.display = show ? "inline-flex" : "none";
}
function ngHardReload(){
  try{
    const url = new URL(window.location.href);
    url.searchParams.set("v", String(Date.now()));
    window.location.replace(url.toString());
  }catch(e){
    try{ window.location.reload(true); }catch(_e){ window.location.reload(); }
  }
}

/* =============================================================================
   SECTION_FIREBASE  [SECTION_FIREBASE]
   - Firebase configuration lives here.
============================================================================= */

/*
================================================================================
  CONFIG / CONSTANTS  [SECTION_CONFIG]
================================================================================
*/

/*
================================================================================
  FIREBASE CONFIG  [SECTION_FIREBASE]
================================================================================
*/
const firebaseConfig = {
      apiKey: "AIzaSyC0sdB54z0G73P3epW6GmHqgYvESFcqgTo",
      authDomain: "gamenightdarts-e7601.firebaseapp.com",
      projectId: "gamenightdarts-e7601",
      storageBucket: "gamenightdarts-e7601.firebasestorage.app",
      messagingSenderId: "270045452251",
      appId: "1:270045452251:web:393956ce18b43316e939fe",
      measurementId: "G-LQEHF02ZVR"
    };

    // ===== UI refs =====
    const landing = document.getElementById("landing");
    const players = document.getElementById("players");
    const detail = document.getElementById("detail");
    const emailInput = document.getElementById("emailInput");
// Remembered email (per-device)
try{
  const saved = localStorage.getItem(rememberedEmailKey);
  if(saved){
    emailInput.value = saved;
    try{ emailEcho.textContent = saved; }catch(e){}
    try{ setHeaderPlayerLabel(saved); }catch(e){}
  }
}catch(e){}

    const ngHeaderPlayer = document.getElementById("ngHeaderPlayer");
    const globalFooter = document.getElementById("globalFooter");


    // v917: preload saved email for this device (Bill + anyone who signed in before)
    try{
      const savedEmail = (localStorage.getItem("ng_saved_email")||"").trim();
      if(savedEmail && emailInput){
        setHeaderPlayerLabel(savedEmail);

        emailInput.value = savedEmail;
      }
    }catch(e){}
    // v906: email overlay text (install once)
    if(!window.__ngEchoInstalled){
      window.__ngEchoInstalled = true;
      const emailEchoEl = document.getElementById("emailEcho");
      function syncEmailEcho(){
        try{
          const v = (emailInput?.value || "").trim();
          if(emailEchoEl) emailEchoEl.textContent = v ? v : "player@example.com";
        }catch(e){}
      }
      if(emailInput){
        emailInput.addEventListener("input", syncEmailEcho, {passive:true});
        emailInput.addEventListener("change", syncEmailEcho, {passive:true});
        syncEmailEcho();
      }
    }


    /* ===========================
       v768 INTRO AUDIO (REPO FILE)
       - Plays the repo-hosted intro audio (m4a) when user taps the email field.
       - Everyone hears it on their own device (same file, same voice).
       - Uses normal HTML5 Audio (same mechanism as beeps), NOT SpeechSynthesis.
       =========================== */
    (function(){
      try{
        if(window.__ngIntroAudioInstalled) return;
        window.__ngIntroAudioInstalled = true;

        //  Set this to the exact repo path you uploaded (default assumes repo root)
        const INTRO_URL = "https://raw.githubusercontent.com/smoody157/Night-Games/main/New%20Recording%202.m4a?v=902";

        const intro = new Audio(INTRO_URL);
        intro.preload = "auto";

        function playIntro(){
          try{
            intro.currentTime = 0;
            const p = intro.play();
            if(p && p.catch) p.catch(()=>{});
          }catch(e){}
        }

        if(emailInput){
          // v906: single, non-duplicated intro audio trigger (no stacked listeners)
          let __ngIntroLast = 0;
          function playIntroOnce(){
            const now = Date.now();
            if(now - __ngIntroLast < 700) return; // debounce
            __ngIntroLast = now;
            try{
              if(!intro.paused){ intro.pause(); }
              intro.currentTime = 0;
            }catch(e){}
            try{
              const p = intro.play();
              if(p && p.catch) p.catch(()=>{});
            }catch(e){}
          }

          // Use ONE event type (prevents double-play on iOS)
          const EVT = (window.PointerEvent ? "pointerdown" : "touchstart");
          const DUMMY_EMAIL = "player@example.com";

          function clearEmailAndFocus(){
            try{
              if(!emailInput) return;

              // If a saved email exists, do NOT auto-clear (this enables Bill's "tap ENTER and go")
              let saved = "";
              try{ saved = (localStorage.getItem("ng_saved_email")||"").trim().toLowerCase(); }catch(e){}
              const v = (emailInput.value || "").trim();

              if(!saved){
                // Clear only if it's empty or still the dummy value (no user should have to highlight/delete)
                if(!v || v.toLowerCase() === DUMMY_EMAIL){
                  emailInput.value = "";
                  try{ emailInput.dispatchEvent(new Event("input", {bubbles:true})); }catch(e){}
                }
              }

              try{ emailInput.focus({preventScroll:true}); }catch(e){ try{ emailInput.focus(); }catch(_e){} }
            }catch(e){}
          }

          // Bind to BOTH the invisible input and the visible pad container (more reliable on iOS)
          const emailPadEl = document.getElementById("emailPad");
          function onEmailTouch(){
            clearEmailAndFocus();
            playIntroOnce();
          }
          try{ emailInput.addEventListener(EVT, onEmailTouch, { passive:true }); }catch(e){}
          try{ if(emailPadEl) emailPadEl.addEventListener(EVT, onEmailTouch, { passive:true }); }catch(e){}
        }
      }catch(e){}
    })();


    const enterBtn = document.getElementById("enterBtn");
    const gamesList = document.getElementById("gamesList");
    const playersList = document.getElementById("playersList");
    const detailTitle = document.getElementById("detailTitle");
    const detailBody = document.getElementById("detailBody");
    const backBtn = document.getElementById("backBtn");
    const homeBtn = document.getElementById("homeBtn");
    const statusLine = document.getElementById("statusLine");
    const setup = document.getElementById("setup");
    const waiting = document.getElementById("waiting");
    const waitingBody = document.getElementById("waitingBody");
    const waitingBackBtn = document.getElementById("waitingBackBtn");
    const setupBackBtn = document.getElementById("setupBackBtn");
    const lobbySetupBtn = document.getElementById("lobbySetupBtn");
    const lobby = document.getElementById("lobby");
    const lobbyTitle = document.getElementById("lobbyTitle");
    const lobbyBody = document.getElementById("lobbyBody");
    const lobbyBackBtn = document.getElementById("lobbyBackBtn");
    const lobbyStartBtn = document.getElementById("lobbyStartBtn");
    const lobbyEndBtn = document.getElementById("lobbyEndBtn");
    const sessionBtn = document.getElementById("sessionBtn");


/*
================================================================================
  ROUTING / NAV  [SECTION_ROUTING]
================================================================================
*/
function show(which){
      landing.classList.toggle("active", which==="landing");

      // v917: global footer off on landing (landing already has its own footer)
      try{ if(globalFooter) globalFooter.style.display = (which==="landing") ? "none" : "block"; }catch(e){}
      players.classList.toggle("active", which==="players");
      setup.classList.toggle("active", which==="setup");
      waiting.classList.toggle("active", which==="waiting");
      lobby.classList.toggle("active", which==="lobby");
      detail.classList.toggle("active", which==="detail");
    }
    function openDetail(title, html){
      detailTitle.textContent = title;
      detailBody.innerHTML = html;
      show("detail");
    }

    // ===== Click sound (iPhone safe) =====
    let audioCtx = null;
    function ensureAudio(){
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if(audioCtx.state === "suspended") audioCtx.resume();
    }
    function clickSound(){
      try{
        ensureAudio();
        const t = audioCtx.currentTime;
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "triangle";
        osc.frequency.setValueAtTime(680, t);
        osc.frequency.exponentialRampToValueAtTime(260, t + 0.07);
        gain.gain.setValueAtTime(0.0001, t);
        gain.gain.exponentialRampToValueAtTime(0.22, t + 0.01);
        gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.09);
        osc.connect(gain).connect(audioCtx.destination);
        osc.start(t);
        osc.stop(t + 0.10);
      }catch(e){}
    }
    document.addEventListener("pointerdown", (e)=>{
      const b = e.target.closest("button");
      if(!b) return;
      clickSound();
    }, {passive:true});


    function isOnline(p){
      const id = safeEmail(p.email);
      const last = presenceMap.get(id) || 0;
      return (p.email || "").toLowerCase() === (currentEmail || "").toLowerCase() || ((Date.now() - last) < 25000);
    }

function safeEmail(email){
      return (email||"").toLowerCase().replaceAll(".", "(dot)").replaceAll("@","(at)");
    }


    // v917: header player label (friendly + centered)
    function setHeaderPlayerLabel(email){
  try{ ngSetHeaderNameFromEmail(email); }catch(e){}
}



    // v768: invites (in-app)  Join / No Thanks
    let invitesUnsub = null;
    function listenForInvites(){
      try{ if(invitesUnsub) invitesUnsub(); }catch(e){}
      invitesUnsub = null;
      const db2 = (window.db) || (window.ngFirebase && window.ngFirebase.db);
      if(!db2 || !currentEmail) return;
      const me = (currentEmail||"").toLowerCase();
      const invRef = collection(db2, "invites");
      const qInv = query(invRef, where("to", "==", me), where("status", "==", "pending"));
      invitesUnsub = onSnapshot(qInv, (snap)=>{
        if(!snap || snap.empty) return;
        // take newest pending invite
        const docSnap = snap.docs[0];
        const inv = docSnap.data() || {};
        const from = inv.from || "Host";
        const game = inv.game || "Game";
        const sessionId = inv.sessionId || null;
        const invited = Array.isArray(inv.invited) ? inv.invited : [];
        const count = inv.count || invited.length || 1;

        openDetail("INVITE", `
          <div style="font-weight:1100; font-size:22px; margin-bottom:10px;">${from} invited you</div>
          <div style="opacity:.82; margin-bottom:14px;">Game: <b>${game}</b></div>
          <div style="opacity:.78; margin-bottom:14px;">Join this room?</div>
          <div style="display:flex; gap:12px; flex-wrap:wrap;">
            <button class="pill" id="invJoinBtn" type="button">Join</button>
            <button class="pill" id="invNoBtn" type="button" style="opacity:.85;">No Thanks</button>
          </div>
        `);

        const joinBtn = document.getElementById("invJoinBtn");
        const noBtn = document.getElementById("invNoBtn");

        if(joinBtn){
          joinBtn.addEventListener("click", async ()=>{
            try{
              await setDoc(doc(db2, "invites", docSnap.id), { status:"accepted", respondedAt: serverTimestamp() }, { merge:true });
            }catch(e){ alert(e.message||e); }
            // set local session + go waiting
            if(sessionId){
              activeSessionId = sessionId;
              activeSession = { id: sessionId, game, host: inv.fromEmail||inv.from||"", setup:{ count, emails: invited } };
              try{ localStorage.setItem("ng_active_session", JSON.stringify(activeSession)); }catch(e){}
      listenSessionInvites();
              listenSessionInvites();

/*
================================================================================
  WAITING ROOM  [SECTION_WAITING]
================================================================================
*/
renderWaitingRoom();
              show("waiting");
              closeDetail();
            }
          });
        }
        if(noBtn){
          noBtn.addEventListener("click", async ()=>{
            try{
              await setDoc(doc(db2, "invites", docSnap.id), { status:"declined", respondedAt: serverTimestamp() }, { merge:true });
            }catch(e){ alert(e.message||e); }
            closeDetail();
          });
        }
      });
    }

    async function sendInvitesForSession(){
      if(!db || !activeSessionId || !activeSession || !activeSession.setup) return;
      const hostEmail = (currentEmail||"").toLowerCase();
      const hostName = (lastPeople||[]).find(p => (p.email||"").toLowerCase()===hostEmail)?.name || (hostEmail.split("@")[0]||"Host");
      const game = activeSession.game || "Game";
      const invited = (activeSession.setup.emails||[]).map(x=>(x||"").toLowerCase()).filter(Boolean);
      const count = activeSession.setup.count || invited.length || 1;

      // create/merge session doc (meta)
      try{
        await setDoc(doc(db2, "sessions", activeSessionId), {
          sessionId: activeSessionId,
          game,
          host: hostEmail,
          hostName,
          invited,
          count,
          createdAt: serverTimestamp()
        }, { merge:true });
      }catch(e){ /* non-fatal */ }

      // create invite docs for non-host
      const others = invited.filter(em => em !== hostEmail);
      for(const to of others){
        const invId = `${activeSessionId}_${safeEmail(to)}`;
        await setDoc(doc(db2, "invites", invId), {
          sessionId: activeSessionId,
          game,
          from: hostName,
          fromEmail: hostEmail,
          to,
          invited,
          count,
          status: "pending",
          createdAt: serverTimestamp()
        }, { merge:true });
      }
    }

    let inviteStatusCache = new Map();
    let sessionInvitesUnsub = null;
    function listenSessionInvites(){
      try{ if(sessionInvitesUnsub) sessionInvitesUnsub(); }catch(e){}
      sessionInvitesUnsub = null;
      const db2 = (window.db) || (window.ngFirebase && window.ngFirebase.db);
      if(!db2 || !activeSessionId) return;
      const invRef = collection(db2, "invites");
      const qSess = query(invRef, where("sessionId","==", activeSessionId));
      sessionInvitesUnsub = onSnapshot(qSess, (snap)=>{
        inviteStatusCache = new Map();
        try{
          snap.docs.forEach(d=>{
            const v = d.data()||{};
            if(v.to) inviteStatusCache.set(String(v.to).toLowerCase(), v.status||"pending");
          });
        }catch(e){}

        // refresh waiting room statuses when invites change
        if(waiting && waiting.classList.contains("active")){
          renderWaitingRoom();
        }
      });
    }


    function renderWaitingRoom(){
      const game = (activeSession && activeSession.game) ? activeSession.game : "Game";
      const s = (activeSession && activeSession.setup) ? activeSession.setup : {emails:[],count:0};
      const emails = (s.emails||[]).slice(0, s.count||s.emails.length);

      const rows = emails.map(em=>{
        const p = (lastPeople||[]).find(x => (x.email||"").toLowerCase()===String(em||"").toLowerCase());
        const name = p ? (p.name||em.split("@")[0]||em) : (em.split("@")[0]||em);
        const lower = String(em||"").toLowerCase();
        const online = (p && isOnline(p)) || (lower===(currentEmail||"").toLowerCase());
        const status = (lower===(currentEmail||"").toLowerCase()) ? "host" : (inviteStatusCache.get(lower)||"pending");
        const statusLabel = status==="accepted" ? "joined" : status==="declined" ? "declined" : status==="host" ? "host" : "invited";
        const icon = status==="accepted" || status==="host" ? "" : status==="declined" ? "" : "";
        const iconClass = status==="accepted" || status==="host" ? "ok" : status==="declined" ? "no" : "wait";
        return `<div class="waitRow">
          <div class="waitLeft">
            <span class="dot ${online ? "online" : ""}"></span>
            <div class="waitName">${name}</div>
          </div>
          <div class="waitMeta"><span class="statusIcon ${iconClass}">${icon}</span> ${statusLabel}  ${online ? "online" : "offline"}</div>
        </div>`;
      }).join("");

      waitingBody.innerHTML = `
        <div class="setupGameTitle">${game}</div>
        <div style="opacity:.78; margin-bottom:14px;">Waiting for invited players to join</div>
        <div>${rows || `<div style="opacity:.78;">No players selected.</div>`}</div>
      `;

      // v768: auto-start when the last invited player has joined (host only)
      try{
        const me = (currentEmail||"").toLowerCase();
        const isHost = me && activeSession && (activeSession.host||"").toLowerCase()===me;
        const want = (s.count||emails.length||0);
        if(isHost && want>0 && emails.length){
          let joined = 0;
          let anyDeclined = false;
          for(const em of emails){
            const lowerEm = String(em||"").toLowerCase();
            if(lowerEm===me){ joined++; continue; }
            const st = inviteStatusCache.get(lowerEm) || "pending";
            if(st==="accepted") joined++;
            if(st==="declined") anyDeclined = true;
          }
          if(!anyDeclined && joined>=want){
            if(window.ngAutoStartedSessionId !== activeSessionId){
              window.ngAutoStartedSessionId = activeSessionId;
              // If a real game runner exists, use it. Otherwise move forward to Lobby.
              try{ startGameFromSession && startGameFromSession(); return; }catch(e){}
              try{
                lobbyTitle.textContent = (activeSession.game||"Game") + "  LIVE";
                lobbyBody.innerHTML = "<div style='font-weight:1100; font-size:22px; margin-bottom:10px;'>All players joined.</div><div style='opacity:.82;'>Starting game</div>";
                show("lobby");
              }catch(e){}
            }
          }
        }
      }catch(e){}
    }


    // Seed registry (only merges; harmless)
    const SEED = [
      { email: "stevewmoody@yahoo.com", name: "Steve Moody" },
      { email: "jmoody7712@gmail.com", name: "Jayce Moody" },
      { email: "wmoody7931@aol.com", name: "Bill Moody" }
    ];
    async function seedRegistry(db){
      for(const u of SEED){
        await setDoc(doc(db, "registry", safeEmail(u.email)), {
          email: u.email.toLowerCase(),
          name: u.name,
          createdAt: serverTimestamp()
        }, { merge: true });
      }
    }

    let rememberedEmailKey = "ng_saved_email_v1";
function ngSetHeaderNameFromEmail(email){
  try{
    const el = document.getElementById("ngHeaderPlayer");
    if(!el) return;
    const e = String(email||"").trim();
    if(!e){
      el.textContent = "WELCOME";
      el.title = "";
      return;
    }
    const base = e.split("@")[0].replace(/[._-]+/g," ").trim();
    const nice = base.split(" ").filter(Boolean).map(w=>w.charAt(0).toUpperCase()+w.slice(1)).join(" ");
    el.textContent = nice || e;
    el.title = e;
  }catch(_e){}
}
function ngShowUpdate(show){
  try{
    const b = document.getElementById("ngUpdateBtn");
    if(!b) return;
    b.style.display = show ? "inline-flex" : "none";
  }catch(_e){}
}
let currentEmail = null;
    let currentUid = null;
    let presenceTimer = null;
    let presenceMap = new Map(); // id -> lastActiveMillis

    let lastPeople = []; // cached registry list for re-render on presence updates



/*
================================================================================
  PLAYERS  [SECTION_PLAYERS]
================================================================================
*/
/*
================================================================================
   GAME LIST RENDER  [SECTION_GAMES]
================================================================================
*/
function renderGames(){
  if(!gamesList) return;
  gamesList.innerHTML = games.map(g=>{
    return `
      <div class="itemLine">
        <div class="leftStack">
          <span class="glassText" style="font-weight:1000;">${g}</span>
        </div>
        <div class="actions">
          <button class="pill" data-action="open_game_setup" data-value="${g}">Setup</button>
        </div>
      </div>
    `;
  }).join("");
}

function renderPlayers(list){
      // v768: float online players to top
      const sorted = (list||[]).slice().sort((a,b)=>{
        const ao = isOnline(a), bo = isOnline(b);
        if(ao !== bo) return ao ? -1 : 1;
        return (a.name||"").localeCompare(b.name||"");
      });
      playersList.innerHTML = sorted.map(p => {
        const id = safeEmail(p.email);
        const online = isOnline(p);
        return `
          <div class="itemLine">
            <div class="leftStack">
              <span class="dot ${online ? "online" : ""}"></span>
              <span class="glassText">${p.name}</span>
            </div>
            <div class="actions">
              <button class="pill" data-action="player_stats" data-value="${p.email}">Stats</button>
              <button class="pill" data-action="player_history" data-value="${p.email}">History</button>
            </div>
          </div>
        `;
      }).join("");
    }

    function watchData(db){
      // registry
      onSnapshot(query(collection(db, "registry")), (snap)=>{
        const people = snap.docs.map(d => d.data()).filter(x=>x && x.email && x.name);
        people.sort((a,b)=>(a.name||"").localeCompare(b.name||""));
        lastPeople = people;
        renderPlayers(people);
        setDbg("OK", dbgAuth.textContent || "", "registry live", dbgErr.textContent || "none");
      }, (err)=>{
        setDbg("FAIL", dbgAuth.textContent || "", "registry fail", err.code || err.message || String(err));
      });

      // presence
      onSnapshot(query(collection(db, "presence")), (snap)=>{
        const m = new Map();
        snap.docs.forEach(d => {
          const data = d.data() || {};
          const ts = data.lastActive;
          let ms = 0;
          try{
            ms = ts && typeof ts.toMillis === "function" ? ts.toMillis() : Date.now();
          }catch(_e){ ms = Date.now(); }
          m.set(d.id, ms);
        });
        presenceMap = m;
        // v768: re-render to reorder online players immediately
        if(typeof lastPeople !== "undefined" && Array.isArray(lastPeople) && lastPeople.length){
          renderPlayers(lastPeople);
        }
}, (err)=>{
        setDbg("FAIL", dbgAuth.textContent || "", "presence fail", err.code || err.message || String(err));
      });

      // dot refresh
      setInterval(()=>{
        // re-render quickly by triggering minimal update if list already rendered
        const rows = playersList.querySelectorAll(".itemLine");
        if(!rows.length) return;
        rows.forEach((row)=>{
          const nameEl = row.querySelector(".glassText");
          const dot = row.querySelector(".dot");
          if(!nameEl || !dot) return;
          const name = nameEl.textContent || "";
          // find matching registry entry by name is not safe; we keep last state until next snapshot.
          // presence updates will come through snapshot anyway.
        });
      }, 2000);
    }

    async function startPresence(db){
      if(!currentEmail || !currentUid) return;
      const id = safeEmail(currentEmail);
      const ref = doc(db, "presence", id);
      async function tick(){
        await setDoc(ref, {
          email: currentEmail,
          uid: currentUid,
          lastActive: serverTimestamp()
        }, { merge: true });
        // optimistic: show online immediately
        try { presenceMap.set(id, Date.now()); if(lastPeople && lastPeople.length) renderPlayers(lastPeople); } catch(e) {}
      }
      await tick();
      clearInterval(presenceTimer);
      presenceTimer = setInterval(()=> tick().catch(()=>{}), 5000);
    }

    async function signInFlow(auth, db, email){
      currentEmail = (email||"").trim().toLowerCase();
      setHeaderPlayerLabel(currentEmail);
      try{ localStorage.setItem(rememberedEmailKey, currentEmail); }catch(e){}
      try{ ngShowUpdate(true); }catch(e){}

      if(!currentEmail) return;

      statusLine.textContent = "Signing in";
      setDbg("AUTH", "starting", "", dbgErr.textContent || "none");

      // 1) Auth (anonymous)
      const cred = await signInAnonymously(auth);
      currentUid = cred.user.uid;
      dbgAuth.textContent = "anon uid " + currentUid.slice(0,6) + "";

      // 2) Seed registry
      await seedRegistry(db);

      // 3) Verify registration
      const regRef = doc(db, "registry", safeEmail(currentEmail));
      const regSnap = await getDoc(regRef);
      if(!regSnap.exists()) {
        statusLine.textContent = "Not registered.";
        setDbg("FAIL", dbgAuth.textContent, "registry miss", "not registered: " + currentEmail);
        alert("Email not registered yet.");
        return;
      }

      // 4) Write user record (optional)
      await setDoc(doc(db, "users", currentUid), {
        email: currentEmail,
        lastLogin: serverTimestamp()
      }, { merge: true });

      // v917: remember last successful email on THIS device/browser (Bill garage iPad use-case)
      try{ localStorage.setItem("ng_saved_email", currentEmail); }catch(e){}

      // 5) Presence + live listeners
      try { presenceMap.set(safeEmail(currentEmail), Date.now()); } catch(e) {}
      await startPresence(db);
      renderGames();
      watchData(db);
      show("players");
      statusLine.textContent = "Signed in.";
      try{ currentEmail = (emailInput.value||"").trim(); }catch(e){}
      try{ ngSetHeaderPlayer(currentEmail); }catch(e){}
      try{ ngShowUpdate(true); }catch(e){}
      try{ if(currentEmail) localStorage.setItem('ng_saved_email', currentEmail); }catch(e){}
      setDbg("OK", dbgAuth.textContent, "connected", "none");
    }

    // Start Firebase and wire handlers
    try {
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      window.ngAuth = auth;
      try{
        const lo = document.getElementById('ngUpdateBtn');
      if(lo){ lo.addEventListener('click', async ()=>{
        try{ await signOut(auth); }catch(e){}
        try{ ngShowUpdate(false); }catch(e){}
        try{ ngHardReload(); }catch(e){}
      }); }
      catch(e){}
      const db = getFirestore(app);


      // v768: expose firebase handles for non-module code (prevents "db is not defined")
      window.ngFirebase = {
        app, auth, db,
        doc, setDoc, getDoc,
        collection, onSnapshot,
        serverTimestamp, query, where
      };
      window.db = db;
// v768 Multiplayer
    const ROOM_ID = "dart-room";
    let activeSessionId = null;
    let activeGame = null;
    let activeHost = null;

      setDbg("INIT", "ready", "ready", "none");

      onAuthStateChanged(auth, (u)=>{
        if(u) dbgAuth.textContent = "anon uid " + u.uid.slice(0,6) + "";
        if(!u){ try{ ngShowUpdate(false); }catch(e){} }
      });


/*
================================================================================
  ENTER / SIGN-IN ROUTING  [SECTION_ROUTING]
================================================================================
*/
function onEnter() {
        signInFlow(auth, db, emailInput.value).catch((err)=>{
          const msg = err?.code || err?.message || String(err);
          statusLine.textContent = "Firebase error.";
          setDbg("FAIL", dbgAuth.textContent || "", "fail", msg);
          alert("Firebase error: " + msg);
        });
      }
      enterBtn.addEventListener("click", onEnter);
      emailInput.addEventListener("keydown", (e)=>{
        if(e.key === "Enter"){ e.preventDefault(); onEnter(); }
      });

          document.addEventListener("click", async (e)=>{
      const b = e.target.closest(".pill");
      if(!b) return;

      const action = b.dataset.action;
      const value = b.dataset.value || "";

      if(action === "game_rules"){
        const txt = (GAME_RULES[value] || "Rules coming soon.");
        openDetail("RULES  " + value, `
          <div style="font-weight:1000; font-size:22px; margin-bottom:8px;">${value}</div>
          <div style="opacity:.82; font-size:14px; line-height:1.55;">${txt}</div>
        `);
        return;
      }


      // Global rules list
      if(action === "show_rules"){
        const list = Object.entries(GAME_RULES).map(([k,v]) => `
          <div style="margin: 0 0 14px 0;">
            <div style="font-weight:1000; font-size:20px; margin-bottom:4px;">${k}</div>
            <div style="opacity:.78; font-size:14px; line-height:1.45;">${v}</div>
          </div>
        `).join("");
        openDetail("RULES", `<div>${list}</div>`);
        return;
      }

      // Enter game (multiplayer session)
      if(action === "enter_game"){
        try{
          await createSessionForGame(value);
          renderSetupForGame(value);
          show("setup");
        }catch(e){
          alert("Session error: " + (e.message||e));
        }
        return;
      }

      if(action === "game_history"){
        openDetail("GAME HISTORY", `
          <div style="font-weight:1000; font-size:26px; margin-bottom:6px;">${value}</div>
          <div style="opacity:.75;">Placeholder. Next well pull from Firestore.</div>
        `);
        return;
      }

      if(action === "player_stats"){
        // Player Stats Shell (v906)
        const whoEmail = String(value || "").toLowerCase();
        const who = (lastPeople || []).find(p => String(p.email||"").toLowerCase() === whoEmail);
        const whoName = (who && who.name) ? who.name : (whoEmail ? whoEmail.split("@")[0] : "Player");

        // Use your game list if available, otherwise fallback to the 6 games
        const gameList = (Array.isArray(games) && games.length)
          ? games
          : ["01","Cricket","Killer","Shanghai","Around the World","Half It"];

        const rows = gameList.map(g => `
          <button type="button" class="pill statGameBtn" data-action="player_stats_game" data-value="${whoEmail}||${g}"><div style="font-weight:1000; letter-spacing:.4px;">${g}</div><div class="r">View</div></button>
        `).join("");

        openDetail("PLAYER STATS", `
          <div class="glassText" style="font-weight:1000; font-size:22px; margin-bottom:10px;">${whoName}</div>
          <div style="opacity:.72; margin-bottom:14px;">Select a game.</div>
          <div class="statScroll">${rows}</div>
        `);
        return;
      }

      if(action === "player_stats_game"){
        const raw = String(value || "");
        const parts = raw.split("||");
        const whoEmail = String(parts[0] || "").toLowerCase();
        const gameName = String(parts[1] || "").trim();

        const who = (lastPeople || []).find(p => String(p.email||"").toLowerCase() === whoEmail);
        const whoName = (who && who.name) ? who.name : (whoEmail ? whoEmail.split("@")[0] : "Player");

        const tpl = PLAYER_STAT_TEMPLATES[gameName] || null;
        if(!tpl){
          openDetail("STATS  " + gameName, `<div style="opacity:.75; font-weight:900;">No stat template yet.</div>`);
          return;
        }

        const sections = Object.keys(tpl).map(sectionName => {
          const rows = tpl[sectionName].map(([key,label,help]) => {
            const val = getStat(whoEmail, gameName, key);
            return `
              <div class="statRow">
                <div class="statLeft">
                  <div class="statLabel">${label}</div>
                  <div class="statHelp">${help}</div>
                </div>
                <div class="statVal">${val}</div>
              </div>
            `;
          }).join("");
          return `
            <div class="statSection">
              <div class="statSectionTitle">${sectionName}</div>
              ${rows}
            </div>
          `;
        }).join("");

        openDetail("STATS  " + gameName, `
          <div class="glassText" style="font-weight:1000; font-size:22px; margin-bottom:10px;">${whoName}</div>
          <div style="opacity:.72; margin-bottom:14px;">${gameName}</div>
          <div class="statScroll">${sections}</div>
        `);
        return;
      }

      if(action === "player_history"){
        openDetail("PLAYER HISTORY", `
          <div style="font-weight:1000; font-size:22px; margin-bottom:6px;">${value}</div>
          <div style="opacity:.75;">Placeholder. Next well pull from Firestore.</div>
        `);
        return;
      }

      if(action === "show_session"){
        if(!activeSessionId){
          openDetail("SESSION", `<div style="opacity:.78;">No active session.</div>`);
          return;
        }
        openDetail("SESSION  LIVE", `
          <div style="font-weight:1000; font-size:22px; margin-bottom:8px;">${activeGame || "Game"}</div>
          <div style="opacity:.82; font-size:14px; line-height:1.55;">
            Room: <b>${ROOM_ID}</b><br/>
            Session: <b>${activeSessionId}</b><br/>
            Host: <b>${activeHost || ""}</b>
          </div>
          <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
            <button class="pill" data-action="join_session" type="button">Join</button>
            <button class="pill" data-action="end_session" type="button">End</button>
          </div>
        `);
        return;
      }

      if(action === "join_session"){
        try{ await joinActiveSessionIfAny(); }catch(e){}
        openDetail("JOINED", `<div style="opacity:.85;">Joined session.</div>`);
        return;
      }

      if(action === "end_session"){
        try{ await endSession(); }catch(e){}
        openDetail("SESSION ENDED", `<div style="opacity:.85;">Session ended.</div>`);
        return;
      }
    });

      backBtn.addEventListener("click", ()=> show("players"));
      homeBtn.addEventListener("click", ()=> show("landing"));

      lobbyBackBtn.addEventListener("click", ()=> show("players"));
      lobbySetupBtn.addEventListener("click", ()=> show("setup"));
      setupBackBtn.addEventListener("click", ()=> show("players"));
      waitingBackBtn.addEventListener("click", ()=> show("setup"));
      lobbyStartBtn.addEventListener("click", ()=> startSession().catch(e=>alert(e.message||e)));
      lobbyEndBtn.addEventListener("click", ()=> endSession().catch(e=>alert(e.message||e)));


    } catch (err) {
      failHard("Firebase init failed (imports loaded but initialize failed).", err);
    }

    // If the module runs, hide the fatal overlay (in case something else turned it on)
    document.getElementById("fatal").style.display = "none";
  </script><script>



</script>
<!-- =======================
     v768 ERROR HUD (shows only on errors)
     ======================= -->
<div aria-atomic="true" aria-live="polite" id="ngErrToast">
<div class="card">
<div class="head">
<div class="title"><span class="dot"></span><span id="ngErrTitle">Hey Steve  something went wrong</span></div>
<div style="display:flex; gap:8px;">
<button class="btn" id="ngErrMore" type="button">Details</button>
<button class="btn" id="ngErrClose" type="button">Close</button>
</div>
</div>
<div class="body">
<div class="msg" id="ngErrMsg">Error captured.</div>
<div class="detail" id="ngErrDetail"></div>
</div>
</div>
</div>
<script id="ngErrorHud_v748">
/***********************
 *  v768: ERROR HUD + SAFE LOGGING
 *  Purpose:
 *   - If a runtime error happens, show a small toast with details.
 *   - Does NOT block the UI and does NOT change game logic.
 ***********************/
(function(){
  if(window.__NG_ERRHUD__) return; window.__NG_ERRHUD__=true;
  const toast = document.getElementById('ngErrToast');
  if(!toast) return;
  const titleEl = document.getElementById('ngErrTitle');
  const msgEl   = document.getElementById('ngErrMsg');
  const detEl   = document.getElementById('ngErrDetail');
  const moreBtn = document.getElementById('ngErrMore');
  const closeBtn= document.getElementById('ngErrClose');

  let hideTimer = null;

  function showToast(head, msg, detail){
    try{
      titleEl.textContent = head || 'Hey Steve  something went wrong';
      msgEl.textContent = msg || 'Error captured.';
      detEl.textContent = detail || '';
      toast.classList.remove('expanded');
      toast.style.display = 'block';
      if(hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(()=>{ toast.style.display = 'none'; }, 9000);
    }catch(e){}
  }

  function normalizeError(err){
    if(!err) return {head:'Hey Steve  something went wrong', msg:'Unknown error', detail:''};
    if(typeof err === 'string') return {head:'Hey Steve  something went wrong', msg:err, detail:''};
    const msg = err.message || String(err);
    const stack = err.stack || '';
    return {head:'Hey Steve  something went wrong', msg, detail:stack};
  }

  // Buttons
  moreBtn && moreBtn.addEventListener('click', ()=>{
    toast.classList.toggle('expanded');
    if(hideTimer) clearTimeout(hideTimer);
  });
  closeBtn && closeBtn.addEventListener('click', ()=>{
    toast.style.display = 'none';
    if(hideTimer) clearTimeout(hideTimer);
  });

  // Global error hooks
  window.addEventListener('error', (event)=>{
    const err = event.error || new Error(event.message || 'Script error');
    const n = normalizeError(err);
    const where = event.filename ? `\n@ ${event.filename}:${event.lineno||0}:${event.colno||0}` : '';
    showToast(n.head, n.msg, (n.detail||'') + where);
  });

  window.addEventListener('unhandledrejection', (event)=>{
    const n = normalizeError(event.reason);
    showToast(n.head, n.msg, n.detail);
  });

  // Expose a manual helper: window.ngErr("message", "detail")
  window.ngErr = function(message, detail){
    showToast('Hey Steve  heads up', message || 'Notice', detail || '');
  };
})();
</script>
</body>
</html>
